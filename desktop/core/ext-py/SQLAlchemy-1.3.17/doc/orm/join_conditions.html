<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">



<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        
        <title>
            
    
    Configuring how Relationship Joins
 &mdash;
    SQLAlchemy 1.3 Documentation

        </title>

        
            <!-- begin iterate through site-imported + sphinx environment css_files -->
                <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
                <link rel="stylesheet" href="../_static/docs.css" type="text/css" />
                <link rel="stylesheet" href="../_static/changelog.css" type="text/css" />
                <link rel="stylesheet" href="../_static/sphinx_paramlinks.css" type="text/css" />
            <!-- end iterate through site-imported + sphinx environment css_files -->
        

        

    

    <!-- begin layout.mako headers -->

    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
        <link rel="copyright" title="Copyright" href="../copyright.html" />
    <link rel="top" title="SQLAlchemy 1.3 Documentation" href="../index.html" />
        <link rel="up" title="Relationship Configuration" href="relationships.html" />
        <link rel="next" title="Collection Configuration and Techniques" href="collections.html" />
        <link rel="prev" title="Linking Relationships with Backref" href="backref.html" />
    <!-- end layout.mako headers -->


    </head>
    <body>
        
















<div id="docs-container">





<div id="docs-top-navigation-container" class="body-background">
<div id="docs-header">
    <div id="docs-version-header">
        Release: <span class="version-num">1.3.17</span>


        | Release Date: May 13, 2020

    </div>

    <h1>SQLAlchemy 1.3 Documentation</h1>

</div>
</div>

<div id="docs-body-container">

    <div id="fixed-sidebar" class="withsidebar">


        <div id="docs-sidebar-popout">
            <h3><a href="../index.html">SQLAlchemy 1.3 Documentation</a></h3>
            <p id="sidebar-topnav">
                <a href="../contents.html">Contents</a> |
                <a href="../genindex.html">Index</a>
            </p>

            <div id="sidebar-search">
                <form class="search" action="../search.html" method="get">
                  <label>
                  Search terms:
                  <input type="text" placeholder="search..." name="q" size="12" />
                  </label>
                  <input type="hidden" name="check_keywords" value="yes" />
                  <input type="hidden" name="area" value="default" />
                </form>
            </div>

        </div>

        <div id="docs-sidebar">

        <div id="sidebar-banner">
            
        </div>

        <div id="docs-sidebar-inner">

        
        <h3>
            <a href="index.html" title="SQLAlchemy ORM">SQLAlchemy ORM</a>
        </h3>

        <ul>
<li><span class="link-container"><a class="reference external" href="tutorial.html">Object Relational Tutorial</a></span></li>
<li><span class="link-container"><a class="reference external" href="mapper_config.html">Mapper Configuration</a></span></li>
<li><span class="link-container"><a class="reference external" href="relationships.html">Relationship Configuration</a></span><ul>
<li><span class="link-container"><a class="reference external" href="basic_relationships.html">Basic Relationship Patterns</a></span></li>
<li><span class="link-container"><a class="reference external" href="self_referential.html">Adjacency List Relationships</a></span></li>
<li><span class="link-container"><a class="reference external" href="backref.html">Linking Relationships with Backref</a></span></li>
<li class="selected"><span class="link-container"><strong>Configuring how Relationship Joins</strong><a class="paramlink headerlink reference internal" href="#">¶</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#handling-multiple-join-paths">Handling Multiple Join Paths</a></span></li>
<li><span class="link-container"><a class="reference external" href="#specifying-alternate-join-conditions">Specifying Alternate Join Conditions</a></span></li>
<li><span class="link-container"><a class="reference external" href="#creating-custom-foreign-conditions">Creating Custom Foreign Conditions</a></span></li>
<li><span class="link-container"><a class="reference external" href="#using-custom-operators-in-join-conditions">Using custom operators in join conditions</a></span></li>
<li><span class="link-container"><a class="reference external" href="#custom-operators-based-on-sql-functions">Custom operators based on SQL functions</a></span></li>
<li><span class="link-container"><a class="reference external" href="#overlapping-foreign-keys">Overlapping Foreign Keys</a></span></li>
<li><span class="link-container"><a class="reference external" href="#non-relational-comparisons-materialized-path">Non-relational Comparisons / Materialized Path</a></span></li>
<li><span class="link-container"><a class="reference external" href="#self-referential-many-to-many-relationship">Self-Referential Many-to-Many Relationship</a></span></li>
<li><span class="link-container"><a class="reference external" href="#composite-secondary-joins">Composite “Secondary” Joins</a></span></li>
<li><span class="link-container"><a class="reference external" href="#relationship-to-aliased-class">Relationship to Aliased Class</a></span></li>
<li><span class="link-container"><a class="reference external" href="#row-limited-relationships-with-window-functions">Row-Limited Relationships with Window Functions</a></span></li>
<li><span class="link-container"><a class="reference external" href="#building-query-enabled-properties">Building Query-Enabled Properties</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="collections.html">Collection Configuration and Techniques</a></span></li>
<li><span class="link-container"><a class="reference external" href="relationship_persistence.html">Special Relationship Persistence Patterns</a></span></li>
<li><span class="link-container"><a class="reference external" href="relationship_api.html">Relationships API</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="loading_objects.html">Loading Objects</a></span></li>
<li><span class="link-container"><a class="reference external" href="session.html">Using the Session</a></span></li>
<li><span class="link-container"><a class="reference external" href="extending.html">Events and Internals</a></span></li>
<li><span class="link-container"><a class="reference external" href="extensions/index.html">ORM Extensions</a></span></li>
<li><span class="link-container"><a class="reference external" href="examples.html">ORM Examples</a></span></li>
</ul>



        </div>

        </div>

    </div>

    

    <div id="docs-body" class="withsidebar" >
        
<div class="section" id="configuring-how-relationship-joins">
<span id="relationship-configure-joins"></span><h1>Configuring how Relationship Joins<a class="headerlink" href="#configuring-how-relationship-joins" title="Permalink to this headline">¶</a></h1>
<p><a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> will normally create a join between two tables
by examining the foreign key relationship between the two tables
to determine which columns should be compared.  There are a variety
of situations where this behavior needs to be customized.</p>
<div class="section" id="handling-multiple-join-paths">
<span id="relationship-foreign-keys"></span><h2>Handling Multiple Join Paths<a class="headerlink" href="#handling-multiple-join-paths" title="Permalink to this headline">¶</a></h2>
<p>One of the most common situations to deal with is when
there are more than one foreign key path between two tables.</p>
<p>Consider a <code class="docutils literal notranslate"><span class="pre">Customer</span></code> class that contains two foreign keys to an <code class="docutils literal notranslate"><span class="pre">Address</span></code>
class:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">Column</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.declarative</span> <span class="k">import</span> <span class="n">declarative_base</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="k">import</span> <span class="n">relationship</span>

<span class="n">Base</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">Customer</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;customer&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>

    <span class="n">billing_address_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;address.id&quot;</span><span class="p">))</span>
    <span class="n">shipping_address_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;address.id&quot;</span><span class="p">))</span>

    <span class="n">billing_address</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Address&quot;</span><span class="p">)</span>
    <span class="n">shipping_address</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Address&quot;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Address</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;address&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">street</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>
    <span class="n">city</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>
    <span class="nb">zip</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span></pre></div>
</div>
<p>The above mapping, when we attempt to use it, will produce the error:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sqlalchemy</span><span class="o">.</span><span class="n">exc</span><span class="o">.</span><span class="n">AmbiguousForeignKeysError</span><span class="p">:</span> <span class="n">Could</span> <span class="ow">not</span> <span class="n">determine</span> <span class="n">join</span>
<span class="n">condition</span> <span class="n">between</span> <span class="n">parent</span><span class="o">/</span><span class="n">child</span> <span class="n">tables</span> <span class="n">on</span> <span class="n">relationship</span>
<span class="n">Customer</span><span class="o">.</span><span class="n">billing_address</span> <span class="o">-</span> <span class="n">there</span> <span class="n">are</span> <span class="n">multiple</span> <span class="n">foreign</span> <span class="n">key</span>
<span class="n">paths</span> <span class="n">linking</span> <span class="n">the</span> <span class="n">tables</span><span class="o">.</span>  <span class="n">Specify</span> <span class="n">the</span> <span class="s1">&#39;foreign_keys&#39;</span> <span class="n">argument</span><span class="p">,</span>
<span class="n">providing</span> <span class="n">a</span> <span class="nb">list</span> <span class="n">of</span> <span class="n">those</span> <span class="n">columns</span> <span class="n">which</span> <span class="n">should</span> <span class="n">be</span>
<span class="n">counted</span> <span class="k">as</span> <span class="n">containing</span> <span class="n">a</span> <span class="n">foreign</span> <span class="n">key</span> <span class="n">reference</span> <span class="n">to</span> <span class="n">the</span> <span class="n">parent</span> <span class="n">table</span><span class="o">.</span></pre></div>
</div>
<p>The above message is pretty long.  There are many potential messages
that <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> can return, which have been carefully tailored
to detect a variety of common configurational issues; most will suggest
the additional configuration that’s needed to resolve the ambiguity
or other missing information.</p>
<p>In this case, the message wants us to qualify each <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a>
by instructing for each one which foreign key column should be considered, and
the appropriate form is as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Customer</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;customer&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>

    <span class="n">billing_address_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;address.id&quot;</span><span class="p">))</span>
    <span class="n">shipping_address_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;address.id&quot;</span><span class="p">))</span>

    <span class="n">billing_address</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Address&quot;</span><span class="p">,</span> <span class="n">foreign_keys</span><span class="o">=</span><span class="p">[</span><span class="n">billing_address_id</span><span class="p">])</span>
    <span class="n">shipping_address</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Address&quot;</span><span class="p">,</span> <span class="n">foreign_keys</span><span class="o">=</span><span class="p">[</span><span class="n">shipping_address_id</span><span class="p">])</span></pre></div>
</div>
<p>Above, we specify the <code class="docutils literal notranslate"><span class="pre">foreign_keys</span></code> argument, which is a <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> or list
of <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> objects which indicate those columns to be considered “foreign”,
or in other words, the columns that contain a value referring to a parent table.
Loading the <code class="docutils literal notranslate"><span class="pre">Customer.billing_address</span></code> relationship from a <code class="docutils literal notranslate"><span class="pre">Customer</span></code>
object will use the value present in <code class="docutils literal notranslate"><span class="pre">billing_address_id</span></code> in order to
identify the row in <code class="docutils literal notranslate"><span class="pre">Address</span></code> to be loaded; similarly, <code class="docutils literal notranslate"><span class="pre">shipping_address_id</span></code>
is used for the <code class="docutils literal notranslate"><span class="pre">shipping_address</span></code> relationship.   The linkage of the two
columns also plays a role during persistence; the newly generated primary key
of a just-inserted <code class="docutils literal notranslate"><span class="pre">Address</span></code> object will be copied into the appropriate
foreign key column of an associated <code class="docutils literal notranslate"><span class="pre">Customer</span></code> object during a flush.</p>
<p>When specifying <code class="docutils literal notranslate"><span class="pre">foreign_keys</span></code> with Declarative, we can also use string
names to specify, however it is important that if using a list, the <strong>list
is part of the string</strong>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">billing_address</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Address&quot;</span><span class="p">,</span> <span class="n">foreign_keys</span><span class="o">=</span><span class="s2">&quot;[Customer.billing_address_id]&quot;</span><span class="p">)</span></pre></div>
</div>
<p>In this specific example, the list is not necessary in any case as there’s only
one <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> we need:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">billing_address</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Address&quot;</span><span class="p">,</span> <span class="n">foreign_keys</span><span class="o">=</span><span class="s2">&quot;Customer.billing_address_id&quot;</span><span class="p">)</span></pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>When passed as a Python-evaluable string, the
<a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.foreign_keys" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.foreign_keys</span></code></a> argument is interpreted using Python’s
<code class="docutils literal notranslate"><span class="pre">eval()</span></code> function. <strong>DO NOT PASS UNTRUSTED INPUT TO THIS STRING</strong>. See
<a class="reference internal" href="extensions/declarative/relationships.html#declarative-relationship-eval"><span class="std std-ref">Evaluation of relationship arguments</span></a> for details on declarative
evaluation of <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> arguments.</p>
</div>
</div>
<div class="section" id="specifying-alternate-join-conditions">
<span id="relationship-primaryjoin"></span><h2>Specifying Alternate Join Conditions<a class="headerlink" href="#specifying-alternate-join-conditions" title="Permalink to this headline">¶</a></h2>
<p>The default behavior of <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> when constructing a join
is that it equates the value of primary key columns
on one side to that of foreign-key-referring columns on the other.
We can change this criterion to be anything we’d like using the
<a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.primaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.primaryjoin</span></code></a>
argument, as well as the <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.secondaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.secondaryjoin</span></code></a>
argument in the case when a “secondary” table is used.</p>
<p>In the example below, using the <code class="docutils literal notranslate"><span class="pre">User</span></code> class
as well as an <code class="docutils literal notranslate"><span class="pre">Address</span></code> class which stores a street address,  we
create a relationship <code class="docutils literal notranslate"><span class="pre">boston_addresses</span></code> which will only
load those <code class="docutils literal notranslate"><span class="pre">Address</span></code> objects which specify a city of “Boston”:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">Column</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.declarative</span> <span class="k">import</span> <span class="n">declarative_base</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="k">import</span> <span class="n">relationship</span>

<span class="n">Base</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;user&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>
    <span class="n">boston_addresses</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Address&quot;</span><span class="p">,</span>
                    <span class="n">primaryjoin</span><span class="o">=</span><span class="s2">&quot;and_(User.id==Address.user_id, &quot;</span>
                        <span class="s2">&quot;Address.city==&#39;Boston&#39;)&quot;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Address</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;address&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;user.id&#39;</span><span class="p">))</span>

    <span class="n">street</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>
    <span class="n">city</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>
    <span class="nb">zip</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span></pre></div>
</div>
<p>Within this string SQL expression, we made use of the <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.and_" title="sqlalchemy.sql.expression.and_"><code class="xref py py-func docutils literal notranslate"><span class="pre">and_()</span></code></a> conjunction
construct to establish two distinct predicates for the join condition - joining
both the <code class="docutils literal notranslate"><span class="pre">User.id</span></code> and <code class="docutils literal notranslate"><span class="pre">Address.user_id</span></code> columns to each other, as well as
limiting rows in <code class="docutils literal notranslate"><span class="pre">Address</span></code> to just <code class="docutils literal notranslate"><span class="pre">city='Boston'</span></code>.   When using
Declarative, rudimentary SQL functions like <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.and_" title="sqlalchemy.sql.expression.and_"><code class="xref py py-func docutils literal notranslate"><span class="pre">and_()</span></code></a> are automatically
available in the evaluated namespace of a string <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a>
argument.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>When passed as a Python-evaluable string, the
<a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.primaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.primaryjoin</span></code></a> argument is interpreted using
Python’s
<code class="docutils literal notranslate"><span class="pre">eval()</span></code> function. <strong>DO NOT PASS UNTRUSTED INPUT TO THIS STRING</strong>. See
<a class="reference internal" href="extensions/declarative/relationships.html#declarative-relationship-eval"><span class="std std-ref">Evaluation of relationship arguments</span></a> for details on declarative
evaluation of <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> arguments.</p>
</div>
<p>The custom criteria we use in a <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.primaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.primaryjoin</span></code></a>
is generally only significant when SQLAlchemy is rendering SQL in
order to load or represent this relationship. That is, it’s used in
the SQL statement that’s emitted in order to perform a per-attribute
lazy load, or when a join is constructed at query time, such as via
<a class="reference internal" href="query.html#sqlalchemy.orm.query.Query.join" title="sqlalchemy.orm.query.Query.join"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.join()</span></code></a>, or via the eager “joined” or “subquery” styles of
loading.   When in-memory objects are being manipulated, we can place
any <code class="docutils literal notranslate"><span class="pre">Address</span></code> object we’d like into the <code class="docutils literal notranslate"><span class="pre">boston_addresses</span></code>
collection, regardless of what the value of the <code class="docutils literal notranslate"><span class="pre">.city</span></code> attribute
is.   The objects will remain present in the collection until the
attribute is expired and re-loaded from the database where the
criterion is applied.   When a flush occurs, the objects inside of
<code class="docutils literal notranslate"><span class="pre">boston_addresses</span></code> will be flushed unconditionally, assigning value
of the primary key <code class="docutils literal notranslate"><span class="pre">user.id</span></code> column onto the foreign-key-holding
<code class="docutils literal notranslate"><span class="pre">address.user_id</span></code> column for each row.  The <code class="docutils literal notranslate"><span class="pre">city</span></code> criteria has no
effect here, as the flush process only cares about synchronizing
primary key values into referencing foreign key values.</p>
</div>
<div class="section" id="creating-custom-foreign-conditions">
<span id="relationship-custom-foreign"></span><h2>Creating Custom Foreign Conditions<a class="headerlink" href="#creating-custom-foreign-conditions" title="Permalink to this headline">¶</a></h2>
<p>Another element of the primary join condition is how those columns
considered “foreign” are determined.  Usually, some subset
of <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> objects will specify <a class="reference internal" href="../core/constraints.html#sqlalchemy.schema.ForeignKey" title="sqlalchemy.schema.ForeignKey"><code class="xref py py-class docutils literal notranslate"><span class="pre">ForeignKey</span></code></a>, or otherwise
be part of a <a class="reference internal" href="../core/constraints.html#sqlalchemy.schema.ForeignKeyConstraint" title="sqlalchemy.schema.ForeignKeyConstraint"><code class="xref py py-class docutils literal notranslate"><span class="pre">ForeignKeyConstraint</span></code></a> that’s relevant to the join condition.
<a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> looks to this foreign key status as it decides
how it should load and persist data for this relationship.   However, the
<a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.primaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.primaryjoin</span></code></a> argument can be used to create a join condition that
doesn’t involve any “schema” level foreign keys.  We can combine <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.primaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.primaryjoin</span></code></a>
along with <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.foreign_keys" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.foreign_keys</span></code></a> and <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.remote_side" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.remote_side</span></code></a> explicitly in order to
establish such a join.</p>
<p>Below, a class <code class="docutils literal notranslate"><span class="pre">HostEntry</span></code> joins to itself, equating the string <code class="docutils literal notranslate"><span class="pre">content</span></code>
column to the <code class="docutils literal notranslate"><span class="pre">ip_address</span></code> column, which is a PostgreSQL type called <code class="docutils literal notranslate"><span class="pre">INET</span></code>.
We need to use <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.cast" title="sqlalchemy.sql.expression.cast"><code class="xref py py-func docutils literal notranslate"><span class="pre">cast()</span></code></a> in order to cast one side of the join to the
type of the other:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="n">cast</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Integer</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="k">import</span> <span class="n">relationship</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.dialects.postgresql</span> <span class="k">import</span> <span class="n">INET</span>

<span class="kn">from</span> <span class="nn">sqlalchemy.ext.declarative</span> <span class="k">import</span> <span class="n">declarative_base</span>

<span class="n">Base</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">HostEntry</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;host_entry&#39;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ip_address</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">INET</span><span class="p">)</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">))</span>

    <span class="c1"># relationship() using explicit foreign_keys, remote_side</span>
    <span class="n">parent_host</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;HostEntry&quot;</span><span class="p">,</span>
                        <span class="n">primaryjoin</span><span class="o">=</span><span class="n">ip_address</span> <span class="o">==</span> <span class="n">cast</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">INET</span><span class="p">),</span>
                        <span class="n">foreign_keys</span><span class="o">=</span><span class="n">content</span><span class="p">,</span>
                        <span class="n">remote_side</span><span class="o">=</span><span class="n">ip_address</span>
                    <span class="p">)</span></pre></div>
</div>
<p>The above relationship will produce a join like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="n">host_entry</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">host_entry</span><span class="o">.</span><span class="n">ip_address</span><span class="p">,</span> <span class="n">host_entry</span><span class="o">.</span><span class="n">content</span>
<span class="n">FROM</span> <span class="n">host_entry</span> <span class="n">JOIN</span> <span class="n">host_entry</span> <span class="n">AS</span> <span class="n">host_entry_1</span>
<span class="n">ON</span> <span class="n">host_entry_1</span><span class="o">.</span><span class="n">ip_address</span> <span class="o">=</span> <span class="n">CAST</span><span class="p">(</span><span class="n">host_entry</span><span class="o">.</span><span class="n">content</span> <span class="n">AS</span> <span class="n">INET</span><span class="p">)</span></pre></div>
</div>
<p>An alternative syntax to the above is to use the <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.foreign" title="sqlalchemy.orm.foreign"><code class="xref py py-func docutils literal notranslate"><span class="pre">foreign()</span></code></a> and
<a class="reference internal" href="relationship_api.html#sqlalchemy.orm.remote" title="sqlalchemy.orm.remote"><code class="xref py py-func docutils literal notranslate"><span class="pre">remote()</span></code></a> <a class="reference internal" href="../glossary.html#term-annotations"><span class="xref std std-term">annotations</span></a>,
inline within the <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.primaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.primaryjoin</span></code></a> expression.
This syntax represents the annotations that <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> normally
applies by itself to the join condition given the <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.foreign_keys" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.foreign_keys</span></code></a> and
<a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.remote_side" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.remote_side</span></code></a> arguments.  These functions may
be more succinct when an explicit join condition is present, and additionally
serve to mark exactly the column that is “foreign” or “remote” independent
of whether that column is stated multiple times or within complex
SQL expressions:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="k">import</span> <span class="n">foreign</span><span class="p">,</span> <span class="n">remote</span>

<span class="k">class</span> <span class="nc">HostEntry</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;host_entry&#39;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ip_address</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">INET</span><span class="p">)</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">))</span>

    <span class="c1"># relationship() using explicit foreign() and remote() annotations</span>
    <span class="c1"># in lieu of separate arguments</span>
    <span class="n">parent_host</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;HostEntry&quot;</span><span class="p">,</span>
                        <span class="n">primaryjoin</span><span class="o">=</span><span class="n">remote</span><span class="p">(</span><span class="n">ip_address</span><span class="p">)</span> <span class="o">==</span> \
                                <span class="n">cast</span><span class="p">(</span><span class="n">foreign</span><span class="p">(</span><span class="n">content</span><span class="p">),</span> <span class="n">INET</span><span class="p">),</span>
                    <span class="p">)</span></pre></div>
</div>
</div>
<div class="section" id="using-custom-operators-in-join-conditions">
<span id="relationship-custom-operator"></span><h2>Using custom operators in join conditions<a class="headerlink" href="#using-custom-operators-in-join-conditions" title="Permalink to this headline">¶</a></h2>
<p>Another use case for relationships is the use of custom operators, such
as PostgreSQL’s “is contained within” <code class="docutils literal notranslate"><span class="pre">&lt;&lt;</span></code> operator when joining with
types such as <a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.INET" title="sqlalchemy.dialects.postgresql.INET"><code class="xref py py-class docutils literal notranslate"><span class="pre">INET</span></code></a> and <a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.CIDR" title="sqlalchemy.dialects.postgresql.CIDR"><code class="xref py py-class docutils literal notranslate"><span class="pre">CIDR</span></code></a>.
For custom operators we use the <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.operators.Operators.op" title="sqlalchemy.sql.operators.Operators.op"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Operators.op()</span></code></a> function:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">inet_column</span><span class="o">.</span><span class="n">op</span><span class="p">(</span><span class="s2">&quot;&lt;&lt;&quot;</span><span class="p">)(</span><span class="n">cidr_column</span><span class="p">)</span></pre></div>
</div>
<p>However, if we construct a <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.primaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.primaryjoin</span></code></a> using this
operator, <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> will still need more information.  This is because
when it examines our primaryjoin condition, it specifically looks for operators
used for <strong>comparisons</strong>, and this is typically a fixed list containing known
comparison operators such as <code class="docutils literal notranslate"><span class="pre">==</span></code>, <code class="docutils literal notranslate"><span class="pre">&lt;</span></code>, etc.   So for our custom operator
to participate in this system, we need it to register as a comparison operator
using the <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.operators.Operators.op.params.is_comparison" title="sqlalchemy.sql.operators.Operators.op"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Operators.op.is_comparison</span></code></a> parameter:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">inet_column</span><span class="o">.</span><span class="n">op</span><span class="p">(</span><span class="s2">&quot;&lt;&lt;&quot;</span><span class="p">,</span> <span class="n">is_comparison</span><span class="o">=</span><span class="kc">True</span><span class="p">)(</span><span class="n">cidr_column</span><span class="p">)</span></pre></div>
</div>
<p>A complete example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">IPA</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;ip_address&#39;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">v4address</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">INET</span><span class="p">)</span>

    <span class="n">network</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Network&quot;</span><span class="p">,</span>
                        <span class="n">primaryjoin</span><span class="o">=</span><span class="s2">&quot;IPA.v4address.op(&#39;&lt;&lt;&#39;, is_comparison=True)&quot;</span>
                            <span class="s2">&quot;(foreign(Network.v4representation))&quot;</span><span class="p">,</span>
                        <span class="n">viewonly</span><span class="o">=</span><span class="kc">True</span>
                    <span class="p">)</span>
<span class="k">class</span> <span class="nc">Network</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;network&#39;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">v4representation</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">CIDR</span><span class="p">)</span></pre></div>
</div>
<p>Above, a query such as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">IPA</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">IPA</span><span class="o">.</span><span class="n">network</span><span class="p">)</span></pre></div>
</div>
<p>Will render as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="n">ip_address</span><span class="o">.</span><span class="n">id</span> <span class="n">AS</span> <span class="n">ip_address_id</span><span class="p">,</span> <span class="n">ip_address</span><span class="o">.</span><span class="n">v4address</span> <span class="n">AS</span> <span class="n">ip_address_v4address</span>
<span class="n">FROM</span> <span class="n">ip_address</span> <span class="n">JOIN</span> <span class="n">network</span> <span class="n">ON</span> <span class="n">ip_address</span><span class="o">.</span><span class="n">v4address</span> <span class="o">&lt;&lt;</span> <span class="n">network</span><span class="o">.</span><span class="n">v4representation</span></pre></div>
</div>
<div class="versionadded">
<p><span class="versionmodified added">New in version 0.9.2: </span>- Added the <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.operators.Operators.op.params.is_comparison" title="sqlalchemy.sql.operators.Operators.op"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Operators.op.is_comparison</span></code></a>
flag to assist in the creation of <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> constructs using
custom operators.</p>
</div>
</div>
<div class="section" id="custom-operators-based-on-sql-functions">
<h2>Custom operators based on SQL functions<a class="headerlink" href="#custom-operators-based-on-sql-functions" title="Permalink to this headline">¶</a></h2>
<p>A variant to the use case for <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.operators.Operators.op.params.is_comparison" title="sqlalchemy.sql.operators.Operators.op"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Operators.op.is_comparison</span></code></a> is
when we aren’t using an operator, but a SQL function.   The typical example
of this use case is the PostgreSQL PostGIS functions however any SQL
function on any database that resolves to a binary condition may apply.
To suit this use case, the <a class="reference internal" href="../core/functions.html#sqlalchemy.sql.functions.FunctionElement.as_comparison" title="sqlalchemy.sql.functions.FunctionElement.as_comparison"><code class="xref py py-meth docutils literal notranslate"><span class="pre">FunctionElement.as_comparison()</span></code></a> method
can modify any SQL function, such as those invoked from the <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.func" title="sqlalchemy.sql.expression.func"><code class="xref py py-data docutils literal notranslate"><span class="pre">func</span></code></a>
namespace, to indicate to the ORM that the function produces a comparison of
two expressions.  The below example illustrates this with the
<a class="reference external" href="https://geoalchemy-2.readthedocs.io/">Geoalchemy2</a> library:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">geoalchemy2</span> <span class="k">import</span> <span class="n">Geometry</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">func</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="k">import</span> <span class="n">relationship</span><span class="p">,</span> <span class="n">foreign</span>

<span class="k">class</span> <span class="nc">Polygon</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;polygon&quot;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">geom</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Geometry</span><span class="p">(</span><span class="s2">&quot;POLYGON&quot;</span><span class="p">,</span> <span class="n">srid</span><span class="o">=</span><span class="mi">4326</span><span class="p">))</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="s2">&quot;Point&quot;</span><span class="p">,</span>
        <span class="n">primaryjoin</span><span class="o">=</span><span class="s2">&quot;func.ST_Contains(foreign(Polygon.geom), Point.geom).as_comparison(1, 2)&quot;</span><span class="p">,</span>
        <span class="n">viewonly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

<span class="k">class</span> <span class="nc">Point</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;point&quot;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">geom</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Geometry</span><span class="p">(</span><span class="s2">&quot;POINT&quot;</span><span class="p">,</span> <span class="n">srid</span><span class="o">=</span><span class="mi">4326</span><span class="p">))</span></pre></div>
</div>
<p>Above, the <a class="reference internal" href="../core/functions.html#sqlalchemy.sql.functions.FunctionElement.as_comparison" title="sqlalchemy.sql.functions.FunctionElement.as_comparison"><code class="xref py py-meth docutils literal notranslate"><span class="pre">FunctionElement.as_comparison()</span></code></a> indicates that the
<code class="docutils literal notranslate"><span class="pre">func.ST_Contains()</span></code> SQL function is comparing the <code class="docutils literal notranslate"><span class="pre">Polygon.geom</span></code> and
<code class="docutils literal notranslate"><span class="pre">Point.geom</span></code> expressions. The <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.foreign" title="sqlalchemy.orm.foreign"><code class="xref py py-func docutils literal notranslate"><span class="pre">foreign()</span></code></a> annotation additionally notes
which column takes on the “foreign key” role in this particular relationship.</p>
<div class="versionadded">
<p><span class="versionmodified added">New in version 1.3: </span>Added <a class="reference internal" href="../core/functions.html#sqlalchemy.sql.functions.FunctionElement.as_comparison" title="sqlalchemy.sql.functions.FunctionElement.as_comparison"><code class="xref py py-meth docutils literal notranslate"><span class="pre">FunctionElement.as_comparison()</span></code></a>.</p>
</div>
</div>
<div class="section" id="overlapping-foreign-keys">
<span id="relationship-overlapping-foreignkeys"></span><h2>Overlapping Foreign Keys<a class="headerlink" href="#overlapping-foreign-keys" title="Permalink to this headline">¶</a></h2>
<p>A rare scenario can arise when composite foreign keys are used, such that
a single column may be the subject of more than one column
referred to via foreign key constraint.</p>
<p>Consider an (admittedly complex) mapping such as the <code class="docutils literal notranslate"><span class="pre">Magazine</span></code> object,
referred to both by the <code class="docutils literal notranslate"><span class="pre">Writer</span></code> object and the <code class="docutils literal notranslate"><span class="pre">Article</span></code> object
using a composite primary key scheme that includes <code class="docutils literal notranslate"><span class="pre">magazine_id</span></code>
for both; then to make <code class="docutils literal notranslate"><span class="pre">Article</span></code> refer to <code class="docutils literal notranslate"><span class="pre">Writer</span></code> as well,
<code class="docutils literal notranslate"><span class="pre">Article.magazine_id</span></code> is involved in two separate relationships;
<code class="docutils literal notranslate"><span class="pre">Article.magazine</span></code> and <code class="docutils literal notranslate"><span class="pre">Article.writer</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Magazine</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;magazine&#39;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Article</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;article&#39;</span>

    <span class="n">article_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span>
    <span class="n">magazine_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;magazine.id&#39;</span><span class="p">))</span>
    <span class="n">writer_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">()</span>

    <span class="n">magazine</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Magazine&quot;</span><span class="p">)</span>
    <span class="n">writer</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Writer&quot;</span><span class="p">)</span>

    <span class="n">__table_args__</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">PrimaryKeyConstraint</span><span class="p">(</span><span class="s1">&#39;article_id&#39;</span><span class="p">,</span> <span class="s1">&#39;magazine_id&#39;</span><span class="p">),</span>
        <span class="n">ForeignKeyConstraint</span><span class="p">(</span>
            <span class="p">[</span><span class="s1">&#39;writer_id&#39;</span><span class="p">,</span> <span class="s1">&#39;magazine_id&#39;</span><span class="p">],</span>
            <span class="p">[</span><span class="s1">&#39;writer.id&#39;</span><span class="p">,</span> <span class="s1">&#39;writer.magazine_id&#39;</span><span class="p">]</span>
        <span class="p">),</span>
    <span class="p">)</span>


<span class="k">class</span> <span class="nc">Writer</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;writer&#39;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">magazine_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;magazine.id&#39;</span><span class="p">),</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">magazine</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Magazine&quot;</span><span class="p">)</span></pre></div>
</div>
<p>When the above mapping is configured, we will see this warning emitted:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SAWarning</span><span class="p">:</span> <span class="n">relationship</span> <span class="s1">&#39;Article.writer&#39;</span> <span class="n">will</span> <span class="n">copy</span> <span class="n">column</span>
<span class="n">writer</span><span class="o">.</span><span class="n">magazine_id</span> <span class="n">to</span> <span class="n">column</span> <span class="n">article</span><span class="o">.</span><span class="n">magazine_id</span><span class="p">,</span>
<span class="n">which</span> <span class="n">conflicts</span> <span class="k">with</span> <span class="n">relationship</span><span class="p">(</span><span class="n">s</span><span class="p">):</span> <span class="s1">&#39;Article.magazine&#39;</span>
<span class="p">(</span><span class="n">copies</span> <span class="n">magazine</span><span class="o">.</span><span class="n">id</span> <span class="n">to</span> <span class="n">article</span><span class="o">.</span><span class="n">magazine_id</span><span class="p">)</span><span class="o">.</span> <span class="n">Consider</span> <span class="n">applying</span>
<span class="n">viewonly</span><span class="o">=</span><span class="kc">True</span> <span class="n">to</span> <span class="n">read</span><span class="o">-</span><span class="n">only</span> <span class="n">relationships</span><span class="p">,</span> <span class="ow">or</span> <span class="n">provide</span> <span class="n">a</span> <span class="n">primaryjoin</span>
<span class="n">condition</span> <span class="n">marking</span> <span class="n">writable</span> <span class="n">columns</span> <span class="k">with</span> <span class="n">the</span> <span class="n">foreign</span><span class="p">()</span> <span class="n">annotation</span><span class="o">.</span></pre></div>
</div>
<p>What this refers to originates from the fact that <code class="docutils literal notranslate"><span class="pre">Article.magazine_id</span></code> is
the subject of two different foreign key constraints; it refers to
<code class="docutils literal notranslate"><span class="pre">Magazine.id</span></code> directly as a source column, but also refers to
<code class="docutils literal notranslate"><span class="pre">Writer.magazine_id</span></code> as a source column in the context of the
composite key to <code class="docutils literal notranslate"><span class="pre">Writer</span></code>.   If we associate an <code class="docutils literal notranslate"><span class="pre">Article</span></code> with a
particular <code class="docutils literal notranslate"><span class="pre">Magazine</span></code>, but then associate the <code class="docutils literal notranslate"><span class="pre">Article</span></code> with a
<code class="docutils literal notranslate"><span class="pre">Writer</span></code> that’s  associated  with a <em>different</em> <code class="docutils literal notranslate"><span class="pre">Magazine</span></code>, the ORM
will overwrite <code class="docutils literal notranslate"><span class="pre">Article.magazine_id</span></code> non-deterministically, silently
changing which magazine we refer towards; it may
also attempt to place NULL into this column if we de-associate a
<code class="docutils literal notranslate"><span class="pre">Writer</span></code> from an <code class="docutils literal notranslate"><span class="pre">Article</span></code>.  The warning lets us know this is the case.</p>
<p>To solve this, we need to break out the behavior of <code class="docutils literal notranslate"><span class="pre">Article</span></code> to include
all three of the following features:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Article</span></code> first and foremost writes to
<code class="docutils literal notranslate"><span class="pre">Article.magazine_id</span></code> based on data persisted in the <code class="docutils literal notranslate"><span class="pre">Article.magazine</span></code>
relationship only, that is a value copied from <code class="docutils literal notranslate"><span class="pre">Magazine.id</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Article</span></code> can write to <code class="docutils literal notranslate"><span class="pre">Article.writer_id</span></code> on behalf of data
persisted in the  <code class="docutils literal notranslate"><span class="pre">Article.writer</span></code> relationship, but only the
<code class="docutils literal notranslate"><span class="pre">Writer.id</span></code> column; the <code class="docutils literal notranslate"><span class="pre">Writer.magazine_id</span></code> column should not
be written into <code class="docutils literal notranslate"><span class="pre">Article.magazine_id</span></code> as it ultimately is sourced
from <code class="docutils literal notranslate"><span class="pre">Magazine.id</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Article</span></code> takes <code class="docutils literal notranslate"><span class="pre">Article.magazine_id</span></code> into account when loading
<code class="docutils literal notranslate"><span class="pre">Article.writer</span></code>, even though it <em>doesn’t</em> write to it on behalf
of this relationship.</p></li>
</ol>
<p>To get just #1 and #2, we could specify only <code class="docutils literal notranslate"><span class="pre">Article.writer_id</span></code> as the
“foreign keys” for <code class="docutils literal notranslate"><span class="pre">Article.writer</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Article</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="c1"># ...</span>

    <span class="n">writer</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Writer&quot;</span><span class="p">,</span> <span class="n">foreign_keys</span><span class="o">=</span><span class="s1">&#39;Article.writer_id&#39;</span><span class="p">)</span></pre></div>
</div>
<p>However, this has the effect of <code class="docutils literal notranslate"><span class="pre">Article.writer</span></code> not taking
<code class="docutils literal notranslate"><span class="pre">Article.magazine_id</span></code> into account when querying against <code class="docutils literal notranslate"><span class="pre">Writer</span></code>:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">article</span><span class="p">.</span><span class="n">article_id</span> <span class="k">AS</span> <span class="n">article_article_id</span><span class="p">,</span>
    <span class="n">article</span><span class="p">.</span><span class="n">magazine_id</span> <span class="k">AS</span> <span class="n">article_magazine_id</span><span class="p">,</span>
    <span class="n">article</span><span class="p">.</span><span class="n">writer_id</span> <span class="k">AS</span> <span class="n">article_writer_id</span>
<span class="k">FROM</span> <span class="n">article</span>
<span class="k">JOIN</span> <span class="n">writer</span> <span class="k">ON</span> <span class="n">writer</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">article</span><span class="p">.</span><span class="n">writer_id</span></pre></div>
</div>
<p>Therefore, to get at all of #1, #2, and #3, we express the join condition
as well as which columns to be written by combining
<a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.primaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.primaryjoin</span></code></a> fully, along with either the
<a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.foreign_keys" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.foreign_keys</span></code></a> argument, or more succinctly by
annotating with <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.foreign" title="sqlalchemy.orm.foreign"><code class="xref py py-func docutils literal notranslate"><span class="pre">foreign()</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Article</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="c1"># ...</span>

    <span class="n">writer</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="s2">&quot;Writer&quot;</span><span class="p">,</span>
        <span class="n">primaryjoin</span><span class="o">=</span><span class="s2">&quot;and_(Writer.id == foreign(Article.writer_id), &quot;</span>
                    <span class="s2">&quot;Writer.magazine_id == Article.magazine_id)&quot;</span><span class="p">)</span></pre></div>
</div>
<div class="versionchanged">
<p><span class="versionmodified changed">Changed in version 1.0.0: </span>the ORM will attempt to warn when a column is used
as the synchronization target from more than one relationship
simultaneously.</p>
</div>
</div>
<div class="section" id="non-relational-comparisons-materialized-path">
<h2>Non-relational Comparisons / Materialized Path<a class="headerlink" href="#non-relational-comparisons-materialized-path" title="Permalink to this headline">¶</a></h2>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>this section details an experimental feature.</p>
</div>
<p>Using custom expressions means we can produce unorthodox join conditions that
don’t obey the usual primary/foreign key model.  One such example is the
materialized path pattern, where we compare strings for overlapping path tokens
in order to produce a tree structure.</p>
<p>Through careful use of <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.foreign" title="sqlalchemy.orm.foreign"><code class="xref py py-func docutils literal notranslate"><span class="pre">foreign()</span></code></a> and <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.remote" title="sqlalchemy.orm.remote"><code class="xref py py-func docutils literal notranslate"><span class="pre">remote()</span></code></a>, we can build
a relationship that effectively produces a rudimentary materialized path
system.   Essentially, when <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.foreign" title="sqlalchemy.orm.foreign"><code class="xref py py-func docutils literal notranslate"><span class="pre">foreign()</span></code></a> and <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.remote" title="sqlalchemy.orm.remote"><code class="xref py py-func docutils literal notranslate"><span class="pre">remote()</span></code></a> are
on the <em>same</em> side of the comparison expression, the relationship is considered
to be “one to many”; when they are on <em>different</em> sides, the relationship
is considered to be “many to one”.   For the comparison we’ll use here,
we’ll be dealing with collections so we keep things configured as “one to many”:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Element</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;element&#39;</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">descendants</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s1">&#39;Element&#39;</span><span class="p">,</span>
                           <span class="n">primaryjoin</span><span class="o">=</span>
                                <span class="n">remote</span><span class="p">(</span><span class="n">foreign</span><span class="p">(</span><span class="n">path</span><span class="p">))</span><span class="o">.</span><span class="n">like</span><span class="p">(</span>
                                        <span class="n">path</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="s1">&#39;/%&#39;</span><span class="p">)),</span>
                           <span class="n">viewonly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                           <span class="n">order_by</span><span class="o">=</span><span class="n">path</span><span class="p">)</span></pre></div>
</div>
<p>Above, if given an <code class="docutils literal notranslate"><span class="pre">Element</span></code> object with a path attribute of <code class="docutils literal notranslate"><span class="pre">&quot;/foo/bar2&quot;</span></code>,
we seek for a load of <code class="docutils literal notranslate"><span class="pre">Element.descendants</span></code> to look like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="n">element</span><span class="o">.</span><span class="n">path</span> <span class="n">AS</span> <span class="n">element_path</span>
<span class="n">FROM</span> <span class="n">element</span>
<span class="n">WHERE</span> <span class="n">element</span><span class="o">.</span><span class="n">path</span> <span class="n">LIKE</span> <span class="p">(</span><span class="s1">&#39;/foo/bar2&#39;</span> <span class="o">||</span> <span class="s1">&#39;/%&#39;</span><span class="p">)</span> <span class="n">ORDER</span> <span class="n">BY</span> <span class="n">element</span><span class="o">.</span><span class="n">path</span></pre></div>
</div>
<div class="versionadded">
<p><span class="versionmodified added">New in version 0.9.5: </span>Support has been added to allow a single-column
comparison to itself within a primaryjoin condition, as well as for
primaryjoin conditions that use <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.operators.ColumnOperators.like" title="sqlalchemy.sql.operators.ColumnOperators.like"><code class="xref py py-meth docutils literal notranslate"><span class="pre">ColumnOperators.like()</span></code></a> as the comparison
operator.</p>
</div>
</div>
<div class="section" id="self-referential-many-to-many-relationship">
<span id="self-referential-many-to-many"></span><h2>Self-Referential Many-to-Many Relationship<a class="headerlink" href="#self-referential-many-to-many-relationship" title="Permalink to this headline">¶</a></h2>
<p>Many to many relationships can be customized by one or both of <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.primaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.primaryjoin</span></code></a>
and <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.secondaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.secondaryjoin</span></code></a> - the latter is significant for a relationship that
specifies a many-to-many reference using the <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.secondary" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.secondary</span></code></a> argument.
A common situation which involves the usage of <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.primaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.primaryjoin</span></code></a> and <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.secondaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.secondaryjoin</span></code></a>
is when establishing a many-to-many relationship from a class to itself, as shown below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Table</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.declarative</span> <span class="k">import</span> <span class="n">declarative_base</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="k">import</span> <span class="n">relationship</span>

<span class="n">Base</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">()</span>

<span class="n">node_to_node</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s2">&quot;node_to_node&quot;</span><span class="p">,</span> <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;left_node_id&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;node.id&quot;</span><span class="p">),</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;right_node_id&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;node.id&quot;</span><span class="p">),</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="p">)</span>

<span class="k">class</span> <span class="nc">Node</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;node&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>
    <span class="n">right_nodes</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Node&quot;</span><span class="p">,</span>
                        <span class="n">secondary</span><span class="o">=</span><span class="n">node_to_node</span><span class="p">,</span>
                        <span class="n">primaryjoin</span><span class="o">=</span><span class="nb">id</span><span class="o">==</span><span class="n">node_to_node</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">left_node_id</span><span class="p">,</span>
                        <span class="n">secondaryjoin</span><span class="o">=</span><span class="nb">id</span><span class="o">==</span><span class="n">node_to_node</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">right_node_id</span><span class="p">,</span>
                        <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;left_nodes&quot;</span>
    <span class="p">)</span></pre></div>
</div>
<p>Where above, SQLAlchemy can’t know automatically which columns should connect
to which for the <code class="docutils literal notranslate"><span class="pre">right_nodes</span></code> and <code class="docutils literal notranslate"><span class="pre">left_nodes</span></code> relationships.   The <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.primaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.primaryjoin</span></code></a>
and <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.secondaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.secondaryjoin</span></code></a> arguments establish how we’d like to join to the association table.
In the Declarative form above, as we are declaring these conditions within the Python
block that corresponds to the <code class="docutils literal notranslate"><span class="pre">Node</span></code> class, the <code class="docutils literal notranslate"><span class="pre">id</span></code> variable is available directly
as the <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> object we wish to join with.</p>
<p>Alternatively, we can define the <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.primaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.primaryjoin</span></code></a>
and <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.secondaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.secondaryjoin</span></code></a> arguments using strings, which is suitable
in the case that our configuration does not have either the <code class="docutils literal notranslate"><span class="pre">Node.id</span></code> column
object available yet or the <code class="docutils literal notranslate"><span class="pre">node_to_node</span></code> table perhaps isn’t yet available.
When referring to a plain <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> object in a declarative string, we
use the string name of the table as it is present in the <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.MetaData" title="sqlalchemy.schema.MetaData"><code class="xref py py-class docutils literal notranslate"><span class="pre">MetaData</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Node</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;node&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>
    <span class="n">right_nodes</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Node&quot;</span><span class="p">,</span>
                        <span class="n">secondary</span><span class="o">=</span><span class="s2">&quot;node_to_node&quot;</span><span class="p">,</span>
                        <span class="n">primaryjoin</span><span class="o">=</span><span class="s2">&quot;Node.id==node_to_node.c.left_node_id&quot;</span><span class="p">,</span>
                        <span class="n">secondaryjoin</span><span class="o">=</span><span class="s2">&quot;Node.id==node_to_node.c.right_node_id&quot;</span><span class="p">,</span>
                        <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;left_nodes&quot;</span>
    <span class="p">)</span></pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>When passed as a Python-evaluable string, the
<a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.primaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.primaryjoin</span></code></a> and
<a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.secondaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.secondaryjoin</span></code></a> arguments are interpreted using
Python’s <code class="docutils literal notranslate"><span class="pre">eval()</span></code> function. <strong>DO NOT PASS UNTRUSTED INPUT TO THESE
STRINGS</strong>. See <a class="reference internal" href="extensions/declarative/relationships.html#declarative-relationship-eval"><span class="std std-ref">Evaluation of relationship arguments</span></a> for details on
declarative evaluation of <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> arguments.</p>
</div>
<p>A classical mapping situation here is similar, where <code class="docutils literal notranslate"><span class="pre">node_to_node</span></code> can be joined
to <code class="docutils literal notranslate"><span class="pre">node.c.id</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Table</span><span class="p">,</span> <span class="n">MetaData</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="k">import</span> <span class="n">relationship</span><span class="p">,</span> <span class="n">mapper</span>

<span class="n">metadata</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">()</span>

<span class="n">node_to_node</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s2">&quot;node_to_node&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;left_node_id&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;node.id&quot;</span><span class="p">),</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;right_node_id&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;node.id&quot;</span><span class="p">),</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">node</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s2">&quot;node&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="n">String</span><span class="p">)</span>
<span class="p">)</span>
<span class="k">class</span> <span class="nc">Node</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="n">mapper</span><span class="p">(</span><span class="n">Node</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="p">{</span>
    <span class="s1">&#39;right_nodes&#39;</span><span class="p">:</span><span class="n">relationship</span><span class="p">(</span><span class="n">Node</span><span class="p">,</span>
                        <span class="n">secondary</span><span class="o">=</span><span class="n">node_to_node</span><span class="p">,</span>
                        <span class="n">primaryjoin</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="o">==</span><span class="n">node_to_node</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">left_node_id</span><span class="p">,</span>
                        <span class="n">secondaryjoin</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="o">==</span><span class="n">node_to_node</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">right_node_id</span><span class="p">,</span>
                        <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;left_nodes&quot;</span>
                    <span class="p">)})</span></pre></div>
</div>
<p>Note that in both examples, the <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.backref" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.backref</span></code></a>
keyword specifies a <code class="docutils literal notranslate"><span class="pre">left_nodes</span></code> backref - when
<a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> creates the second relationship in the reverse
direction, it’s smart enough to reverse the
<a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.primaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.primaryjoin</span></code></a> and
<a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.secondaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.secondaryjoin</span></code></a> arguments.</p>
</div>
<div class="section" id="composite-secondary-joins">
<span id="composite-secondary-join"></span><h2>Composite “Secondary” Joins<a class="headerlink" href="#composite-secondary-joins" title="Permalink to this headline">¶</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This section features far edge cases that are somewhat supported
by SQLAlchemy, however it is recommended to solve problems like these
in simpler ways whenever possible, by using reasonable relational
layouts and / or <a class="reference internal" href="mapped_attributes.html#mapper-hybrids"><span class="std std-ref">in-Python attributes</span></a>.</p>
</div>
<p>Sometimes, when one seeks to build a <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> between two tables
there is a need for more than just two or three tables to be involved in
order to join them.  This is an area of <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> where one seeks
to push the boundaries of what’s possible, and often the ultimate solution to
many of these exotic use cases needs to be hammered out on the SQLAlchemy mailing
list.</p>
<p>In more recent versions of SQLAlchemy, the <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.secondary" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.secondary</span></code></a>
parameter can be used in some of these cases in order to provide a composite
target consisting of multiple tables.   Below is an example of such a
join condition (requires version 0.9.2 at least to function as is):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">b_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;b.id&#39;</span><span class="p">))</span>

    <span class="n">d</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;D&quot;</span><span class="p">,</span>
                <span class="n">secondary</span><span class="o">=</span><span class="s2">&quot;join(B, D, B.d_id == D.id).&quot;</span>
                            <span class="s2">&quot;join(C, C.d_id == D.id)&quot;</span><span class="p">,</span>
                <span class="n">primaryjoin</span><span class="o">=</span><span class="s2">&quot;and_(A.b_id == B.id, A.id == C.a_id)&quot;</span><span class="p">,</span>
                <span class="n">secondaryjoin</span><span class="o">=</span><span class="s2">&quot;D.id == B.d_id&quot;</span><span class="p">,</span>
                <span class="n">uselist</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">viewonly</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>

<span class="k">class</span> <span class="nc">B</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">d_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;d.id&#39;</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">C</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;c&#39;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">a_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;a.id&#39;</span><span class="p">))</span>
    <span class="n">d_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;d.id&#39;</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">D</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;d&#39;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></pre></div>
</div>
<p>In the above example, we provide all three of <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.secondary" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.secondary</span></code></a>,
<a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.primaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.primaryjoin</span></code></a>, and <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.secondaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.secondaryjoin</span></code></a>,
in the declarative style referring to the named tables <code class="docutils literal notranslate"><span class="pre">a</span></code>, <code class="docutils literal notranslate"><span class="pre">b</span></code>, <code class="docutils literal notranslate"><span class="pre">c</span></code>, <code class="docutils literal notranslate"><span class="pre">d</span></code>
directly.  A query from <code class="docutils literal notranslate"><span class="pre">A</span></code> to <code class="docutils literal notranslate"><span class="pre">D</span></code> looks like:</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><span class="n">sess</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

<div class='show_sql'>SELECT a.id AS a_id, a.b_id AS a_b_id
FROM a JOIN (
    b AS b_1 JOIN d AS d_1 ON b_1.d_id = d_1.id
        JOIN c AS c_1 ON c_1.d_id = d_1.id)
    ON a.b_id = b_1.id AND a.id = c_1.a_id JOIN d ON d.id = b_1.d_id</div></pre></div>
</div>
<p>In the above example, we take advantage of being able to stuff multiple
tables into a “secondary” container, so that we can join across many
tables while still keeping things “simple” for <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a>, in that
there’s just “one” table on both the “left” and the “right” side; the
complexity is kept within the middle.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>A relationship like the above is typically marked as
<code class="docutils literal notranslate"><span class="pre">viewonly=True</span></code> and should be considered as read-only.  While there are
sometimes ways to make relationships like the above writable, this is
generally complicated and error prone.</p>
</div>
</div>
<div class="section" id="relationship-to-aliased-class">
<span id="relationship-aliased-class"></span><span id="relationship-non-primary-mapper"></span><h2>Relationship to Aliased Class<a class="headerlink" href="#relationship-to-aliased-class" title="Permalink to this headline">¶</a></h2>
<div class="versionadded">
<p><span class="versionmodified added">New in version 1.3: </span>The <a class="reference internal" href="query.html#sqlalchemy.orm.util.AliasedClass" title="sqlalchemy.orm.util.AliasedClass"><code class="xref py py-class docutils literal notranslate"><span class="pre">AliasedClass</span></code></a> construct can now be specified as the
target of a <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a>, replacing the previous approach
of using non-primary mappers, which had limitations such that they did
not inherit sub-relationships of the mapped entity as well as that they
required complex configuration against an alternate selectable.  The
recipes in this section are now updated to use <a class="reference internal" href="query.html#sqlalchemy.orm.util.AliasedClass" title="sqlalchemy.orm.util.AliasedClass"><code class="xref py py-class docutils literal notranslate"><span class="pre">AliasedClass</span></code></a>.</p>
</div>
<p>In the previous section, we illustrated a technique where we used
<a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.secondary" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.secondary</span></code></a> in order to place additional
tables within a join condition.   There is one complex join case where
even this technique is not sufficient; when we seek to join from <code class="docutils literal notranslate"><span class="pre">A</span></code>
to <code class="docutils literal notranslate"><span class="pre">B</span></code>, making use of any number of <code class="docutils literal notranslate"><span class="pre">C</span></code>, <code class="docutils literal notranslate"><span class="pre">D</span></code>, etc. in between,
however there are also join conditions between <code class="docutils literal notranslate"><span class="pre">A</span></code> and <code class="docutils literal notranslate"><span class="pre">B</span></code>
<em>directly</em>.  In this case, the join from <code class="docutils literal notranslate"><span class="pre">A</span></code> to <code class="docutils literal notranslate"><span class="pre">B</span></code> may be
difficult to express with just a complex
<a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.primaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.primaryjoin</span></code></a> condition, as the intermediary
tables may need special handling, and it is also not expressible with
a <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.secondary" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.secondary</span></code></a> object, since the
<code class="docutils literal notranslate"><span class="pre">A-&gt;secondary-&gt;B</span></code> pattern does not support any references between
<code class="docutils literal notranslate"><span class="pre">A</span></code> and <code class="docutils literal notranslate"><span class="pre">B</span></code> directly.  When this <strong>extremely advanced</strong> case
arises, we can resort to creating a second mapping as a target for the
relationship.  This is where we use <a class="reference internal" href="query.html#sqlalchemy.orm.util.AliasedClass" title="sqlalchemy.orm.util.AliasedClass"><code class="xref py py-class docutils literal notranslate"><span class="pre">AliasedClass</span></code></a> in order to make a
mapping to a class that includes all the additional tables we need for
this join. In order to produce this mapper as an “alternative” mapping
for our class, we use the <a class="reference internal" href="query.html#sqlalchemy.orm.aliased" title="sqlalchemy.orm.aliased"><code class="xref py py-func docutils literal notranslate"><span class="pre">aliased()</span></code></a> function to produce the new
construct, then use <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> against the object as though it
were a plain mapped class.</p>
<p>Below illustrates a <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> with a simple join from <code class="docutils literal notranslate"><span class="pre">A</span></code> to
<code class="docutils literal notranslate"><span class="pre">B</span></code>, however the primaryjoin condition is augmented with two additional
entities <code class="docutils literal notranslate"><span class="pre">C</span></code> and <code class="docutils literal notranslate"><span class="pre">D</span></code>, which also must have rows that line up with
the rows in both <code class="docutils literal notranslate"><span class="pre">A</span></code> and <code class="docutils literal notranslate"><span class="pre">B</span></code> simultaneously:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">b_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;b.id&#39;</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">B</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">C</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;c&#39;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">a_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;a.id&#39;</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">D</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;d&#39;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">c_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;c.id&#39;</span><span class="p">))</span>
    <span class="n">b_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;b.id&#39;</span><span class="p">))</span>

<span class="c1"># 1. set up the join() as a variable, so we can refer</span>
<span class="c1"># to it in the mapping multiple times.</span>
<span class="n">j</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">D</span><span class="o">.</span><span class="n">b_id</span> <span class="o">==</span> <span class="n">B</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">C</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">D</span><span class="o">.</span><span class="n">c_id</span><span class="p">)</span>

<span class="c1"># 2. Create an AliasedClass to B</span>
<span class="n">B_viacd</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">A</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">B_viacd</span><span class="p">,</span> <span class="n">primaryjoin</span><span class="o">=</span><span class="n">A</span><span class="o">.</span><span class="n">b_id</span> <span class="o">==</span> <span class="n">j</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">b_id</span><span class="p">)</span></pre></div>
</div>
<p>With the above mapping, a simple join looks like:</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><span class="n">sess</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

<div class='show_sql'>SELECT a.id AS a_id, a.b_id AS a_b_id
FROM a JOIN (b JOIN d ON d.b_id = b.id JOIN c ON c.id = d.c_id) ON a.b_id = b.id</div></pre></div>
</div>
</div>
<div class="section" id="row-limited-relationships-with-window-functions">
<span id="relationship-to-window-function"></span><h2>Row-Limited Relationships with Window Functions<a class="headerlink" href="#row-limited-relationships-with-window-functions" title="Permalink to this headline">¶</a></h2>
<p>Another interesting use case for relationships to <a class="reference internal" href="query.html#sqlalchemy.orm.util.AliasedClass" title="sqlalchemy.orm.util.AliasedClass"><code class="xref py py-class docutils literal notranslate"><span class="pre">AliasedClass</span></code></a>
objects are situations where
the relationship needs to join to a specialized SELECT of any form.   One
scenario is when the use of a window function is desired, such as to limit
how many rows should be returned for a relationship.  The example below
illustrates a non-primary mapper relationship that will load the first
ten items for each collection:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">B</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">a_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;a.id&quot;</span><span class="p">))</span>

<span class="n">partition</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span>
    <span class="n">B</span><span class="p">,</span>
    <span class="n">func</span><span class="o">.</span><span class="n">row_number</span><span class="p">()</span><span class="o">.</span><span class="n">over</span><span class="p">(</span>
        <span class="n">order_by</span><span class="o">=</span><span class="n">B</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">partition_by</span><span class="o">=</span><span class="n">B</span><span class="o">.</span><span class="n">a_id</span>
    <span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
<span class="p">])</span><span class="o">.</span><span class="n">alias</span><span class="p">()</span>

<span class="n">partitioned_b</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">partition</span><span class="p">)</span>

<span class="n">A</span><span class="o">.</span><span class="n">partitioned_bs</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
    <span class="n">partitioned_b</span><span class="p">,</span>
    <span class="n">primaryjoin</span><span class="o">=</span><span class="n">and_</span><span class="p">(</span><span class="n">partitioned_b</span><span class="o">.</span><span class="n">a_id</span> <span class="o">==</span> <span class="n">A</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">partition</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span>
<span class="p">)</span></pre></div>
</div>
<p>We can use the above <code class="docutils literal notranslate"><span class="pre">partitioned_bs</span></code> relationship with most of the loader
strategies, such as <a class="reference internal" href="loading_relationships.html#sqlalchemy.orm.selectinload" title="sqlalchemy.orm.selectinload"><code class="xref py py-func docutils literal notranslate"><span class="pre">selectinload()</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">a1</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">selectinload</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">partitioned_bs</span><span class="p">)):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">a1</span><span class="o">.</span><span class="n">partitioned_bs</span><span class="p">)</span>   <span class="c1"># &lt;-- will be no more than ten objects</span></pre></div>
</div>
<p>Where above, the “selectinload” query looks like:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span>
    <span class="n">a_1</span><span class="p">.</span><span class="n">id</span> <span class="k">AS</span> <span class="n">a_1_id</span><span class="p">,</span> <span class="n">anon_1</span><span class="p">.</span><span class="n">id</span> <span class="k">AS</span> <span class="n">anon_1_id</span><span class="p">,</span> <span class="n">anon_1</span><span class="p">.</span><span class="n">a_id</span> <span class="k">AS</span> <span class="n">anon_1_a_id</span><span class="p">,</span>
    <span class="n">anon_1</span><span class="p">.</span><span class="k">data</span> <span class="k">AS</span> <span class="n">anon_1_data</span><span class="p">,</span> <span class="n">anon_1</span><span class="p">.</span><span class="k">index</span> <span class="k">AS</span> <span class="n">anon_1_index</span>
<span class="k">FROM</span> <span class="n">a</span> <span class="k">AS</span> <span class="n">a_1</span>
<span class="k">JOIN</span> <span class="p">(</span>
    <span class="k">SELECT</span> <span class="n">b</span><span class="p">.</span><span class="n">id</span> <span class="k">AS</span> <span class="n">id</span><span class="p">,</span> <span class="n">b</span><span class="p">.</span><span class="n">a_id</span> <span class="k">AS</span> <span class="n">a_id</span><span class="p">,</span> <span class="n">b</span><span class="p">.</span><span class="k">data</span> <span class="k">AS</span> <span class="k">data</span><span class="p">,</span>
    <span class="n">row_number</span><span class="p">()</span> <span class="n">OVER</span> <span class="p">(</span><span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">b</span><span class="p">.</span><span class="n">a_id</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">b</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="k">AS</span> <span class="k">index</span>
    <span class="k">FROM</span> <span class="n">b</span><span class="p">)</span> <span class="k">AS</span> <span class="n">anon_1</span>
<span class="k">ON</span> <span class="n">anon_1</span><span class="p">.</span><span class="n">a_id</span> <span class="o">=</span> <span class="n">a_1</span><span class="p">.</span><span class="n">id</span> <span class="k">AND</span> <span class="n">anon_1</span><span class="p">.</span><span class="k">index</span> <span class="o">&lt;</span> <span class="o">%</span><span class="p">(</span><span class="n">index_1</span><span class="p">)</span><span class="n">s</span>
<span class="k">WHERE</span> <span class="n">a_1</span><span class="p">.</span><span class="n">id</span> <span class="k">IN</span> <span class="p">(</span> <span class="p">...</span> <span class="k">primary</span> <span class="k">key</span> <span class="n">collection</span> <span class="p">...)</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">a_1</span><span class="p">.</span><span class="n">id</span></pre></div>
</div>
<p>Above, for each matching primary key in “a”, we will get the first ten
“bs” as ordered by “b.id”.   By partitioning on “a_id” we ensure that each
“row number” is local to the parent “a_id”.</p>
<p>Such a mapping would ordinarily also include a “plain” relationship
from “A” to “B”, for persistence operations as well as when the full
set of “B” objects per “A” is desired.</p>
</div>
<div class="section" id="building-query-enabled-properties">
<span id="query-enabled-properties"></span><h2>Building Query-Enabled Properties<a class="headerlink" href="#building-query-enabled-properties" title="Permalink to this headline">¶</a></h2>
<p>Very ambitious custom join conditions may fail to be directly persistable, and
in some cases may not even load correctly. To remove the persistence part of
the equation, use the flag <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.viewonly" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.viewonly</span></code></a> on the
<a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a>, which establishes it as a read-only
attribute (data written to the collection will be ignored on flush()).
However, in extreme cases, consider using a regular Python property in
conjunction with <a class="reference internal" href="query.html#sqlalchemy.orm.query.Query" title="sqlalchemy.orm.query.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a> as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;user&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">addresses</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">object_session</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Address</span><span class="p">)</span><span class="o">.</span><span class="n">with_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">...</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span></pre></div>
</div>
<p>In other cases, the descriptor can be built to make use of existing in-Python
data.  See the section on <a class="reference internal" href="mapped_attributes.html#mapper-hybrids"><span class="std std-ref">Using Descriptors and Hybrids</span></a> for more general discussion
of special Python attributes.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="mapped_attributes.html#mapper-hybrids"><span class="std std-ref">Using Descriptors and Hybrids</span></a></p>
</div>
</div>
</div>

    </div>

</div>

<div id="docs-bottom-navigation" class="docs-navigation-links, withsidebar">
        Previous:
        <a href="backref.html" title="previous chapter">Linking Relationships with Backref</a>
        Next:
        <a href="collections.html" title="next chapter">Collection Configuration and Techniques</a>

    <div id="docs-copyright">
        &copy; <a href="../copyright.html">Copyright</a> 2007-2020, the SQLAlchemy authors and contributors.
        Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 3.0.3.
    </div>
</div>

</div>



        
        

    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
          URL_ROOT:    '../',
          VERSION:     '1.3.17',
          COLLAPSE_MODINDEX: false,
          FILE_SUFFIX: '.html'
      };
    </script>

    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>

    <!-- begin iterate through sphinx environment script_files -->
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    <!-- end iterate through sphinx environment script_files -->

    <script type="text/javascript" src="../_static/detectmobile.js"></script>
    <script type="text/javascript" src="../_static/init.js"></script>


    </body>
</html>


