<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">



<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        
        <title>
            
    
    What’s New in SQLAlchemy 1.0?
 &mdash;
    SQLAlchemy 1.3 Documentation

        </title>

        
            <!-- begin iterate through site-imported + sphinx environment css_files -->
                <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
                <link rel="stylesheet" href="../_static/docs.css" type="text/css" />
                <link rel="stylesheet" href="../_static/changelog.css" type="text/css" />
                <link rel="stylesheet" href="../_static/sphinx_paramlinks.css" type="text/css" />
            <!-- end iterate through site-imported + sphinx environment css_files -->
        

        

    

    <!-- begin layout.mako headers -->

    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
        <link rel="copyright" title="Copyright" href="../copyright.html" />
    <link rel="top" title="SQLAlchemy 1.3 Documentation" href="../index.html" />
        <link rel="up" title="Changes and Migration" href="index.html" />
        <link rel="next" title="What’s New in SQLAlchemy 0.9?" href="migration_09.html" />
        <link rel="prev" title="What’s New in SQLAlchemy 1.1?" href="migration_11.html" />
    <!-- end layout.mako headers -->


    </head>
    <body>
        
















<div id="docs-container">





<div id="docs-top-navigation-container" class="body-background">
<div id="docs-header">
    <div id="docs-version-header">
        Release: <span class="version-num">1.3.17</span>


        | Release Date: May 13, 2020

    </div>

    <h1>SQLAlchemy 1.3 Documentation</h1>

</div>
</div>

<div id="docs-body-container">

    <div id="fixed-sidebar" class="withsidebar">


        <div id="docs-sidebar-popout">
            <h3><a href="../index.html">SQLAlchemy 1.3 Documentation</a></h3>
            <p id="sidebar-topnav">
                <a href="../contents.html">Contents</a> |
                <a href="../genindex.html">Index</a>
            </p>

            <div id="sidebar-search">
                <form class="search" action="../search.html" method="get">
                  <label>
                  Search terms:
                  <input type="text" placeholder="search..." name="q" size="12" />
                  </label>
                  <input type="hidden" name="check_keywords" value="yes" />
                  <input type="hidden" name="area" value="default" />
                </form>
            </div>

        </div>

        <div id="docs-sidebar">

        <div id="sidebar-banner">
            
        </div>

        <div id="docs-sidebar-inner">

        
        <h3>
            <a href="index.html" title="Changes and Migration">Changes and Migration</a>
        </h3>

        <ul>
<li><span class="link-container"><a class="reference external" href="migration_13.html">What’s New in SQLAlchemy 1.3?</a></span></li>
<li><span class="link-container"><a class="reference external" href="changelog_13.html">1.3 Changelog</a></span></li>
<li><span class="link-container"><a class="reference external" href="changelog_12.html">1.2 Changelog</a></span></li>
<li><span class="link-container"><a class="reference external" href="changelog_11.html">1.1 Changelog</a></span></li>
<li><span class="link-container"><a class="reference external" href="changelog_10.html">1.0 Changelog</a></span></li>
<li><span class="link-container"><a class="reference external" href="changelog_09.html">0.9 Changelog</a></span></li>
<li><span class="link-container"><a class="reference external" href="changelog_08.html">0.8 Changelog</a></span></li>
<li><span class="link-container"><a class="reference external" href="changelog_07.html">0.7 Changelog</a></span></li>
<li><span class="link-container"><a class="reference external" href="changelog_06.html">0.6 Changelog</a></span></li>
<li><span class="link-container"><a class="reference external" href="changelog_05.html">0.5 Changelog</a></span></li>
<li><span class="link-container"><a class="reference external" href="changelog_04.html">0.4 Changelog</a></span></li>
<li><span class="link-container"><a class="reference external" href="changelog_03.html">0.3 Changelog</a></span></li>
<li><span class="link-container"><a class="reference external" href="changelog_02.html">0.2 Changelog</a></span></li>
<li><span class="link-container"><a class="reference external" href="changelog_01.html">0.1 Changelog</a></span></li>
<li><span class="link-container"><a class="reference external" href="migration_12.html">What’s New in SQLAlchemy 1.2?</a></span></li>
<li><span class="link-container"><a class="reference external" href="migration_11.html">What’s New in SQLAlchemy 1.1?</a></span></li>
<li class="selected"><span class="link-container"><strong>What’s New in SQLAlchemy 1.0?</strong><a class="paramlink headerlink reference internal" href="#">¶</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#introduction">Introduction</a></span></li>
<li><span class="link-container"><a class="reference external" href="#new-features-and-improvements-orm">New Features and Improvements - ORM</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#new-session-bulk-insert-update-api">New Session Bulk INSERT/UPDATE API</a></span></li>
<li><span class="link-container"><a class="reference external" href="#new-performance-example-suite">New Performance Example Suite</a></span></li>
<li><span class="link-container"><a class="reference external" href="#baked-queries">“Baked” Queries</a></span></li>
<li><span class="link-container"><a class="reference external" href="#improvements-to-declarative-mixins-declared-attr-and-related-features">Improvements to declarative mixins, <code class="docutils literal notranslate"><span class="pre">&#64;declared_attr</span></code> and related features</a></span></li>
<li><span class="link-container"><a class="reference external" href="#orm-full-object-fetches-25-faster">ORM full object fetches 25% faster</a></span></li>
<li><span class="link-container"><a class="reference external" href="#new-keyedtuple-implementation-dramatically-faster">New KeyedTuple implementation dramatically faster</a></span></li>
<li><span class="link-container"><a class="reference external" href="#significant-improvements-in-structural-memory-use">Significant Improvements in Structural Memory Use</a></span></li>
<li><span class="link-container"><a class="reference external" href="#update-statements-are-now-batched-with-executemany-in-a-flush">UPDATE statements are now batched with executemany() in a flush</a></span></li>
<li><span class="link-container"><a class="reference external" href="#session-get-bind-handles-a-wider-variety-of-inheritance-scenarios">Session.get_bind() handles a wider variety of inheritance scenarios</a></span></li>
<li><span class="link-container"><a class="reference external" href="#session-get-bind-will-receive-the-mapper-in-all-relevant-query-cases">Session.get_bind() will receive the Mapper in all relevant Query cases</a></span></li>
<li><span class="link-container"><a class="reference external" href="#info-dictionary-improvements">.info dictionary improvements</a></span></li>
<li><span class="link-container"><a class="reference external" href="#columnproperty-constructs-work-a-lot-better-with-aliases-order-by">ColumnProperty constructs work a lot better with aliases, order_by</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#new-features-and-improvements-core">New Features and Improvements - Core</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#select-query-limit-offset-may-be-specified-as-an-arbitrary-sql-expression">Select/Query LIMIT / OFFSET may be specified as an arbitrary SQL expression</a></span></li>
<li><span class="link-container"><a class="reference external" href="#the-use-alter-flag-on-foreignkeyconstraint-is-usually-no-longer-needed">The <code class="docutils literal notranslate"><span class="pre">use_alter</span></code> flag on <code class="docutils literal notranslate"><span class="pre">ForeignKeyConstraint</span></code> is (usually) no longer needed</a></span></li>
<li><span class="link-container"><a class="reference external" href="#resultproxy-auto-close-is-now-a-soft-close">ResultProxy “auto close” is now a “soft” close</a></span></li>
<li><span class="link-container"><a class="reference external" href="#check-constraints-now-support-the-column-0-name-s-token-in-naming-conventions">CHECK Constraints now support the <code class="docutils literal notranslate"><span class="pre">%(column_0_name)s</span></code> token in naming conventions</a></span></li>
<li><span class="link-container"><a class="reference external" href="#constraints-referring-to-unattached-columns-can-auto-attach-to-the-table-when-their-referred-columns-are-attached">Constraints referring to unattached Columns can auto-attach to the Table when their referred columns are attached</a></span></li>
<li><span class="link-container"><a class="reference external" href="#insert-from-select-now-includes-python-and-sql-expression-defaults">INSERT FROM SELECT now includes Python and SQL-expression defaults</a></span></li>
<li><span class="link-container"><a class="reference external" href="#column-server-defaults-now-render-literal-values">Column server defaults now render literal values</a></span></li>
<li><span class="link-container"><a class="reference external" href="#uniqueconstraint-is-now-part-of-the-table-reflection-process">UniqueConstraint is now part of the Table reflection process</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#postgresql">PostgreSQL</a></span></li>
<li><span class="link-container"><a class="reference external" href="#mysql">MySQL</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#new-systems-to-safely-emit-parameterized-warnings">New systems to safely emit parameterized warnings</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#key-behavioral-changes-orm">Key Behavioral Changes - ORM</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#query-update-now-resolves-string-names-into-mapped-attribute-names">query.update() now resolves string names into mapped attribute names</a></span></li>
<li><span class="link-container"><a class="reference external" href="#warnings-emitted-when-comparing-objects-with-none-values-to-relationships">Warnings emitted when comparing objects with None values to relationships</a></span></li>
<li><span class="link-container"><a class="reference external" href="#a-negated-contains-or-equals-relationship-comparison-will-use-the-current-value-of-attributes-not-the-database-value">A “negated contains or equals” relationship comparison will use the current value of attributes, not the database value</a></span></li>
<li><span class="link-container"><a class="reference external" href="#changes-to-attribute-events-and-other-operations-regarding-attributes-that-have-no-pre-existing-value">Changes to attribute events and other operations regarding attributes that have no pre-existing value</a></span></li>
<li><span class="link-container"><a class="reference external" href="#priority-of-attribute-changes-on-relationship-bound-attributes-vs-fk-bound-may-appear-to-change">Priority of attribute changes on relationship-bound attributes vs. FK-bound may appear to change</a></span></li>
<li><span class="link-container"><a class="reference external" href="#session-expunge-will-fully-detach-an-object-that-s-been-deleted">session.expunge() will fully detach an object that’s been deleted</a></span></li>
<li><span class="link-container"><a class="reference external" href="#joined-subquery-eager-loading-explicitly-disallowed-with-yield-per">Joined/Subquery eager loading explicitly disallowed with yield_per</a></span></li>
<li><span class="link-container"><a class="reference external" href="#changes-and-fixes-in-handling-of-duplicate-join-targets">Changes and fixes in handling of duplicate join targets</a></span></li>
<li><span class="link-container"><a class="reference external" href="#deferred-columns-no-longer-implicitly-undefer">Deferred Columns No Longer Implicitly Undefer</a></span></li>
<li><span class="link-container"><a class="reference external" href="#deprecated-orm-event-hooks-removed">Deprecated ORM Event Hooks Removed</a></span></li>
<li><span class="link-container"><a class="reference external" href="#api-change-for-new-bundle-feature-when-custom-row-loaders-are-used">API Change for new Bundle feature when custom row loaders are used</a></span></li>
<li><span class="link-container"><a class="reference external" href="#right-inner-join-nesting-now-the-default-for-joinedload-with-innerjoin-true">Right inner join nesting now the default for joinedload with innerjoin=True</a></span></li>
<li><span class="link-container"><a class="reference external" href="#subqueries-no-longer-applied-to-uselist-false-joined-eager-loads">Subqueries no longer applied to uselist=False joined eager loads</a></span></li>
<li><span class="link-container"><a class="reference external" href="#query-update-query-delete-raises-if-used-with-join-select-from-from-self">query.update() / query.delete() raises if used with join(), select_from(), from_self()</a></span></li>
<li><span class="link-container"><a class="reference external" href="#query-update-with-synchronize-session-evaluate-raises-on-multi-table-update">query.update() with <code class="docutils literal notranslate"><span class="pre">synchronize_session='evaluate'</span></code> raises on multi-table update</a></span></li>
<li><span class="link-container"><a class="reference external" href="#resurrect-event-has-been-removed">Resurrect Event has been Removed</a></span></li>
<li><span class="link-container"><a class="reference external" href="#change-to-single-table-inheritance-criteria-when-using-from-self-count">Change to single-table-inheritance criteria when using from_self(), count()</a></span></li>
<li><span class="link-container"><a class="reference external" href="#single-table-inheritance-criteria-added-to-all-on-clauses-unconditionally">single-table-inheritance criteria added to all ON clauses unconditionally</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#key-behavioral-changes-core">Key Behavioral Changes - Core</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#warnings-emitted-when-coercing-full-sql-fragments-into-text">Warnings emitted when coercing full SQL fragments into text()</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#order-by-and-group-by-are-special-cases">ORDER BY and GROUP BY are special cases</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#python-side-defaults-invoked-for-each-row-individually-when-using-a-multivalued-insert">Python-side defaults invoked for each row individually when using a multivalued insert</a></span></li>
<li><span class="link-container"><a class="reference external" href="#event-listeners-can-not-be-added-or-removed-from-within-that-event-s-runner">Event listeners can not be added or removed from within that event’s runner</a></span></li>
<li><span class="link-container"><a class="reference external" href="#the-insert-from-select-construct-now-implies-inline-true">The INSERT…FROM SELECT construct now implies <code class="docutils literal notranslate"><span class="pre">inline=True</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#autoload-with-now-implies-autoload-true"><code class="docutils literal notranslate"><span class="pre">autoload_with</span></code> now implies <code class="docutils literal notranslate"><span class="pre">autoload=True</span></code></a></span></li>
<li><span class="link-container"><a class="reference external" href="#dbapi-exception-wrapping-and-handle-error-event-improvements">DBAPI exception wrapping and handle_error() event improvements</a></span></li>
<li><span class="link-container"><a class="reference external" href="#foreignkeyconstraint-columns-is-now-a-columncollection">ForeignKeyConstraint.columns is now a ColumnCollection</a></span></li>
<li><span class="link-container"><a class="reference external" href="#metadata-sorted-tables-accessor-is-deterministic">MetaData.sorted_tables accessor is “deterministic”</a></span></li>
<li><span class="link-container"><a class="reference external" href="#null-false-and-true-constants-are-no-longer-singletons">null(), false() and true() constants are no longer singletons</a></span></li>
<li><span class="link-container"><a class="reference external" href="#sqlite-oracle-have-distinct-methods-for-temporary-table-view-name-reporting">SQLite/Oracle have distinct methods for temporary table/view name reporting</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#dialect-improvements-and-changes-postgresql">Dialect Improvements and Changes - PostgreSQL</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#overhaul-of-enum-type-create-drop-rules">Overhaul of ENUM type create/drop rules</a></span></li>
<li><span class="link-container"><a class="reference external" href="#new-postgresql-table-options">New PostgreSQL Table options</a></span></li>
<li><span class="link-container"><a class="reference external" href="#new-get-enums-method-with-postgresql-dialect">New get_enums() method with PostgreSQL Dialect</a></span></li>
<li><span class="link-container"><a class="reference external" href="#postgresql-dialect-reflects-materialized-views-foreign-tables">PostgreSQL Dialect reflects Materialized Views, Foreign Tables</a></span></li>
<li><span class="link-container"><a class="reference external" href="#postgresql-has-table-now-works-for-temporary-tables">PostgreSQL <code class="docutils literal notranslate"><span class="pre">has_table()</span></code> now works for temporary tables</a></span></li>
<li><span class="link-container"><a class="reference external" href="#postgresql-filter-keyword">PostgreSQL FILTER keyword</a></span></li>
<li><span class="link-container"><a class="reference external" href="#pg8000-dialect-supports-client-side-encoding">PG8000 dialect supports client side encoding</a></span></li>
<li><span class="link-container"><a class="reference external" href="#pg8000-native-jsonb-support">PG8000 native JSONB support</a></span></li>
<li><span class="link-container"><a class="reference external" href="#support-for-psycopg2cffi-dialect-on-pypy">Support for psycopg2cffi Dialect on PyPy</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#dialect-improvements-and-changes-mysql">Dialect Improvements and Changes - MySQL</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#mysql-timestamp-type-now-renders-null-not-null-in-all-cases">MySQL TIMESTAMP Type now renders NULL / NOT NULL in all cases</a></span></li>
<li><span class="link-container"><a class="reference external" href="#mysql-set-type-overhauled-to-support-empty-sets-unicode-blank-value-handling">MySQL SET Type Overhauled to support empty sets, unicode, blank value handling</a></span></li>
<li><span class="link-container"><a class="reference external" href="#mysql-internal-no-such-table-exceptions-not-passed-to-event-handlers">MySQL internal “no such table” exceptions not passed to event handlers</a></span></li>
<li><span class="link-container"><a class="reference external" href="#changed-the-default-value-of-raise-on-warnings-for-mysql-connector">Changed the default value of <code class="docutils literal notranslate"><span class="pre">raise_on_warnings</span></code> for MySQL-Connector</a></span></li>
<li><span class="link-container"><a class="reference external" href="#mysql-boolean-symbols-true-false-work-again">MySQL boolean symbols “true”, “false” work again</a></span></li>
<li><span class="link-container"><a class="reference external" href="#the-match-operator-now-returns-an-agnostic-matchtype-compatible-with-mysql-s-floating-point-return-value">The match() operator now returns an agnostic MatchType compatible with MySQL’s floating point return value</a></span></li>
<li><span class="link-container"><a class="reference external" href="#drizzle-dialect-is-now-an-external-dialect">Drizzle Dialect is now an External Dialect</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#dialect-improvements-and-changes-sqlite">Dialect Improvements and Changes - SQLite</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#sqlite-named-and-unnamed-unique-and-foreign-key-constraints-will-inspect-and-reflect">SQLite named and unnamed UNIQUE and FOREIGN KEY constraints will inspect and reflect</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#dialect-improvements-and-changes-sql-server">Dialect Improvements and Changes - SQL Server</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#pyodbc-driver-name-is-required-with-hostname-based-sql-server-connections">PyODBC driver name is required with hostname-based SQL Server connections</a></span></li>
<li><span class="link-container"><a class="reference external" href="#sql-server-2012-large-text-binary-types-render-as-varchar-nvarchar-varbinary">SQL Server 2012 large text / binary types render as VARCHAR, NVARCHAR, VARBINARY</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#dialect-improvements-and-changes-oracle">Dialect Improvements and Changes - Oracle</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#improved-support-for-ctes-in-oracle">Improved support for CTEs in Oracle</a></span></li>
<li><span class="link-container"><a class="reference external" href="#new-oracle-keywords-for-ddl">New Oracle Keywords for DDL</a></span></li>
</ul>
</li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="migration_09.html">What’s New in SQLAlchemy 0.9?</a></span></li>
<li><span class="link-container"><a class="reference external" href="migration_08.html">What’s New in SQLAlchemy 0.8?</a></span></li>
<li><span class="link-container"><a class="reference external" href="migration_07.html">What’s New in SQLAlchemy 0.7?</a></span></li>
<li><span class="link-container"><a class="reference external" href="migration_06.html">What’s New in SQLAlchemy 0.6?</a></span></li>
<li><span class="link-container"><a class="reference external" href="migration_05.html">What’s new in SQLAlchemy 0.5?</a></span></li>
<li><span class="link-container"><a class="reference external" href="migration_04.html">What’s new in SQLAlchemy 0.4?</a></span></li>
</ul>



        </div>

        </div>

    </div>

    

    <div id="docs-body" class="withsidebar" >
        
<div class="section" id="what-s-new-in-sqlalchemy-1-0">
<h1>What’s New in SQLAlchemy 1.0?<a class="headerlink" href="#what-s-new-in-sqlalchemy-1-0" title="Permalink to this headline">¶</a></h1>
<div class="admonition-about-this-document admonition">
<p class="admonition-title">About this Document</p>
<p>This document describes changes between SQLAlchemy version 0.9,
undergoing maintenance releases as of May, 2014,
and SQLAlchemy version 1.0, released in April, 2015.</p>
<p>Document last updated: June 9, 2015</p>
</div>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>This guide introduces what’s new in SQLAlchemy version 1.0,
and also documents changes which affect users migrating
their applications from the 0.9 series of SQLAlchemy to 1.0.</p>
<p>Please carefully review the sections on behavioral changes for
potentially backwards-incompatible changes in behavior.</p>
</div>
<div class="section" id="new-features-and-improvements-orm">
<h2>New Features and Improvements - ORM<a class="headerlink" href="#new-features-and-improvements-orm" title="Permalink to this headline">¶</a></h2>
<div class="section" id="new-session-bulk-insert-update-api">
<h3>New Session Bulk INSERT/UPDATE API<a class="headerlink" href="#new-session-bulk-insert-update-api" title="Permalink to this headline">¶</a></h3>
<p>A new series of <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.session.Session" title="sqlalchemy.orm.session.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> methods which provide hooks directly
into the unit of work’s facility for emitting INSERT and UPDATE
statements has been created.  When used correctly, this expert-oriented system
can allow ORM-mappings to be used to generate bulk insert and update
statements batched into executemany groups, allowing the statements
to proceed at speeds that rival direct use of the Core.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../orm/persistence_techniques.html#bulk-operations"><span class="std std-ref">Bulk Operations</span></a> - introduction and full documentation</p>
</div>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3100">#3100</a></p>
</div>
<div class="section" id="new-performance-example-suite">
<h3>New Performance Example Suite<a class="headerlink" href="#new-performance-example-suite" title="Permalink to this headline">¶</a></h3>
<p>Inspired by the benchmarking done for the <a class="reference internal" href="../orm/persistence_techniques.html#bulk-operations"><span class="std std-ref">Bulk Operations</span></a> feature
as well as for the <a class="reference internal" href="../faq/performance.html#faq-how-to-profile"><span class="std std-ref">How can I profile a SQLAlchemy powered application?</span></a> section of the FAQ, a new
example section has been added which features several scripts designed
to illustrate the relative performance profile of various Core and ORM
techniques.  The scripts are organized into use cases, and are packaged
under a single console interface such that any combination of demonstrations
can be run, dumping out timings, Python profile results and/or RunSnake profile
displays.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../orm/examples.html#examples-performance"><span class="std std-ref">Performance</span></a></p>
</div>
</div>
<div class="section" id="baked-queries">
<h3>“Baked” Queries<a class="headerlink" href="#baked-queries" title="Permalink to this headline">¶</a></h3>
<p>The “baked” query feature is an unusual new approach which allows for
straightforward construction an invocation of <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.query.Query" title="sqlalchemy.orm.query.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a> objects
using caching, which upon successive calls features vastly reduced
Python function call overhead (over 75%).    By  specifying a
<a class="reference internal" href="../orm/query.html#sqlalchemy.orm.query.Query" title="sqlalchemy.orm.query.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a> object as a series of lambdas which are only invoked
once, a query as a pre-compiled unit begins to be feasible:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.ext</span> <span class="k">import</span> <span class="n">baked</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="n">bindparam</span>

<span class="n">bakery</span> <span class="o">=</span> <span class="n">baked</span><span class="o">.</span><span class="n">bakery</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">search_for_user</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="n">baked_query</span> <span class="o">=</span> <span class="n">bakery</span><span class="p">(</span><span class="k">lambda</span> <span class="n">session</span><span class="p">:</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">))</span>
    <span class="n">baked_query</span> <span class="o">+=</span> <span class="k">lambda</span> <span class="n">q</span><span class="p">:</span> <span class="n">q</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">bindparam</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">))</span>

    <span class="n">baked_query</span> <span class="o">+=</span> <span class="k">lambda</span> <span class="n">q</span><span class="p">:</span> <span class="n">q</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">email</span><span class="p">:</span>
        <span class="n">baked_query</span> <span class="o">+=</span> <span class="k">lambda</span> <span class="n">q</span><span class="p">:</span> <span class="n">q</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">email</span> <span class="o">==</span> <span class="n">bindparam</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">))</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">baked_query</span><span class="p">(</span><span class="n">session</span><span class="p">)</span><span class="o">.</span><span class="n">params</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">result</span></pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../orm/extensions/baked.html"><span class="std std-ref">Baked Queries</span></a></p>
</div>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3054">#3054</a></p>
</div>
<div class="section" id="improvements-to-declarative-mixins-declared-attr-and-related-features">
<span id="feature-3150"></span><h3>Improvements to declarative mixins, <code class="docutils literal notranslate"><span class="pre">&#64;declared_attr</span></code> and related features<a class="headerlink" href="#improvements-to-declarative-mixins-declared-attr-and-related-features" title="Permalink to this headline">¶</a></h3>
<p>The declarative system in conjunction with <a class="reference internal" href="../orm/extensions/declarative/api.html#sqlalchemy.ext.declarative.declared_attr" title="sqlalchemy.ext.declarative.declared_attr"><code class="xref py py-class docutils literal notranslate"><span class="pre">declared_attr</span></code></a> has been
overhauled to support new capabilities.</p>
<p>A function decorated with <a class="reference internal" href="../orm/extensions/declarative/api.html#sqlalchemy.ext.declarative.declared_attr" title="sqlalchemy.ext.declarative.declared_attr"><code class="xref py py-class docutils literal notranslate"><span class="pre">declared_attr</span></code></a> is now called only <strong>after</strong>
any mixin-based column copies are generated.  This means the function can
call upon mixin-established columns and will receive a reference to the correct
<a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> object:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">HasFooBar</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">foobar</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span>

    <span class="nd">@declared_attr</span>
    <span class="k">def</span> <span class="nf">foobar_prop</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">column_property</span><span class="p">(</span><span class="s1">&#39;foobar: &#39;</span> <span class="o">+</span> <span class="bp">cls</span><span class="o">.</span><span class="n">foobar</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">SomeClass</span><span class="p">(</span><span class="n">HasFooBar</span><span class="p">,</span> <span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;some_table&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></pre></div>
</div>
<p>Above, <code class="docutils literal notranslate"><span class="pre">SomeClass.foobar_prop</span></code> will be invoked against <code class="docutils literal notranslate"><span class="pre">SomeClass</span></code>,
and <code class="docutils literal notranslate"><span class="pre">SomeClass.foobar</span></code> will be the final <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> object that is
to be mapped to <code class="docutils literal notranslate"><span class="pre">SomeClass</span></code>, as opposed to the non-copied object present
directly on <code class="docutils literal notranslate"><span class="pre">HasFooBar</span></code>, even though the columns aren’t mapped yet.</p>
<p>The <a class="reference internal" href="../orm/extensions/declarative/api.html#sqlalchemy.ext.declarative.declared_attr" title="sqlalchemy.ext.declarative.declared_attr"><code class="xref py py-class docutils literal notranslate"><span class="pre">declared_attr</span></code></a> function now <strong>memoizes</strong> the value
that’s returned on a per-class basis, so that repeated calls to the same
attribute will return the same value.  We can alter the example to illustrate
this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">HasFooBar</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="nd">@declared_attr</span>
    <span class="k">def</span> <span class="nf">foobar</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span>

    <span class="nd">@declared_attr</span>
    <span class="k">def</span> <span class="nf">foobar_prop</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">column_property</span><span class="p">(</span><span class="s1">&#39;foobar: &#39;</span> <span class="o">+</span> <span class="bp">cls</span><span class="o">.</span><span class="n">foobar</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">SomeClass</span><span class="p">(</span><span class="n">HasFooBar</span><span class="p">,</span> <span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;some_table&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></pre></div>
</div>
<p>Previously, <code class="docutils literal notranslate"><span class="pre">SomeClass</span></code> would be mapped with one particular copy of
the <code class="docutils literal notranslate"><span class="pre">foobar</span></code> column, but the <code class="docutils literal notranslate"><span class="pre">foobar_prop</span></code> by calling upon <code class="docutils literal notranslate"><span class="pre">foobar</span></code>
a second time would produce a different column.   The value of
<code class="docutils literal notranslate"><span class="pre">SomeClass.foobar</span></code> is now memoized during declarative setup time, so that
even before the attribute is mapped by the mapper, the interim column
value will remain consistent no matter how many times the
<a class="reference internal" href="../orm/extensions/declarative/api.html#sqlalchemy.ext.declarative.declared_attr" title="sqlalchemy.ext.declarative.declared_attr"><code class="xref py py-class docutils literal notranslate"><span class="pre">declared_attr</span></code></a> is called upon.</p>
<p>The two behaviors above should help considerably with declarative definition
of many types of mapper properties that derive from other attributes, where
the <a class="reference internal" href="../orm/extensions/declarative/api.html#sqlalchemy.ext.declarative.declared_attr" title="sqlalchemy.ext.declarative.declared_attr"><code class="xref py py-class docutils literal notranslate"><span class="pre">declared_attr</span></code></a> function is called upon from other
<a class="reference internal" href="../orm/extensions/declarative/api.html#sqlalchemy.ext.declarative.declared_attr" title="sqlalchemy.ext.declarative.declared_attr"><code class="xref py py-class docutils literal notranslate"><span class="pre">declared_attr</span></code></a> functions locally present before the class is
actually mapped.</p>
<p>For a pretty slim edge case where one wishes to build a declarative mixin
that establishes distinct columns per subclass, a new modifier
<a class="reference internal" href="../orm/extensions/declarative/api.html#sqlalchemy.ext.declarative.declared_attr.cascading" title="sqlalchemy.ext.declarative.declared_attr.cascading"><code class="xref py py-attr docutils literal notranslate"><span class="pre">declared_attr.cascading</span></code></a> is added.  With this modifier, the
decorated function will be invoked individually for each class in the
mapped inheritance hierarchy.  While this is already the behavior for
special attributes such as <code class="docutils literal notranslate"><span class="pre">__table_args__</span></code> and <code class="docutils literal notranslate"><span class="pre">__mapper_args__</span></code>,
for columns and other properties the behavior by default assumes that attribute
is affixed to the base class only, and just inherited from subclasses.
With <a class="reference internal" href="../orm/extensions/declarative/api.html#sqlalchemy.ext.declarative.declared_attr.cascading" title="sqlalchemy.ext.declarative.declared_attr.cascading"><code class="xref py py-attr docutils literal notranslate"><span class="pre">declared_attr.cascading</span></code></a>, individual behaviors can be
applied:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">HasIdMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="nd">@declared_attr</span><span class="o">.</span><span class="n">cascading</span>
    <span class="k">def</span> <span class="nf">id</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">has_inherited_table</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">Column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;myclass.id&#39;</span><span class="p">),</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">MyClass</span><span class="p">(</span><span class="n">HasIdMixin</span><span class="p">,</span> <span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;myclass&#39;</span>
    <span class="c1"># ...</span>

<span class="k">class</span> <span class="nc">MySubClass</span><span class="p">(</span><span class="n">MyClass</span><span class="p">):</span>
    <span class="s2">&quot;&quot;</span>
    <span class="c1"># ...</span></pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../orm/extensions/declarative/mixins.html#mixin-inheritance-columns"><span class="std std-ref">Mixing in Columns in Inheritance Scenarios</span></a></p>
</div>
<p>Finally, the <a class="reference internal" href="../orm/extensions/declarative/api.html#sqlalchemy.ext.declarative.AbstractConcreteBase" title="sqlalchemy.ext.declarative.AbstractConcreteBase"><code class="xref py py-class docutils literal notranslate"><span class="pre">AbstractConcreteBase</span></code></a> class has been reworked
so that a relationship or other mapper property can be set up inline
on the abstract base:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="k">import</span> <span class="n">relationship</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.declarative</span> <span class="k">import</span> <span class="p">(</span><span class="n">declarative_base</span><span class="p">,</span> <span class="n">declared_attr</span><span class="p">,</span>
    <span class="n">AbstractConcreteBase</span><span class="p">)</span>

<span class="n">Base</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">Something</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;something&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Abstract</span><span class="p">(</span><span class="n">AbstractConcreteBase</span><span class="p">,</span> <span class="n">Base</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nd">@declared_attr</span>
    <span class="k">def</span> <span class="nf">something_id</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Something</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>

    <span class="nd">@declared_attr</span>
    <span class="k">def</span> <span class="nf">something</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">relationship</span><span class="p">(</span><span class="n">Something</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Concrete</span><span class="p">(</span><span class="n">Abstract</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;cca&#39;</span>
    <span class="n">__mapper_args__</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;polymorphic_identity&#39;</span><span class="p">:</span> <span class="s1">&#39;cca&#39;</span><span class="p">,</span> <span class="s1">&#39;concrete&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span></pre></div>
</div>
<p>The above mapping will set up a table <code class="docutils literal notranslate"><span class="pre">cca</span></code> with both an <code class="docutils literal notranslate"><span class="pre">id</span></code> and
a <code class="docutils literal notranslate"><span class="pre">something_id</span></code> column, and <code class="docutils literal notranslate"><span class="pre">Concrete</span></code> will also have a relationship
<code class="docutils literal notranslate"><span class="pre">something</span></code>.  The new feature is that <code class="docutils literal notranslate"><span class="pre">Abstract</span></code> will also have an
independently configured relationship <code class="docutils literal notranslate"><span class="pre">something</span></code> that builds against
the polymorphic union of the base.</p>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3150">#3150</a> <a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/2670">#2670</a> <a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3149">#3149</a> <a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/2952">#2952</a> <a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3050">#3050</a></p>
</div>
<div class="section" id="orm-full-object-fetches-25-faster">
<h3>ORM full object fetches 25% faster<a class="headerlink" href="#orm-full-object-fetches-25-faster" title="Permalink to this headline">¶</a></h3>
<p>The mechanics of the <code class="docutils literal notranslate"><span class="pre">loading.py</span></code> module as well as the identity map
have undergone several passes of inlining, refactoring, and pruning, so
that a raw load of rows now populates ORM-based objects around 25% faster.
Assuming a 1M row table, a script like the following illustrates the type
of load that’s improved the most:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">Column</span><span class="p">,</span> <span class="n">create_engine</span><span class="p">,</span> <span class="n">Table</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="k">import</span> <span class="n">Session</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.declarative</span> <span class="k">import</span> <span class="n">declarative_base</span>

<span class="n">Base</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__table__</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
        <span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
        <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
        <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
        <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
    <span class="p">)</span>

<span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span>
    <span class="s1">&#39;mysql+mysqldb://scott:tiger@localhost/test&#39;</span><span class="p">,</span> <span class="n">echo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">sess</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>

<span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="c1"># avoid using all() so that we don&#39;t have the overhead of building</span>
<span class="c1"># a large list of full objects in memory</span>
<span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">sess</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Foo</span><span class="p">)</span><span class="o">.</span><span class="n">yield_per</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">1000000</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Total time: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">now</span><span class="p">))</span></pre></div>
</div>
<p>Local MacBookPro results bench from 19 seconds for 0.9 down to 14 seconds for
1.0.  The <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.query.Query.yield_per" title="sqlalchemy.orm.query.Query.yield_per"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.yield_per()</span></code></a> call is always a good idea when batching
huge numbers of rows, as it prevents the Python interpreter from having
to allocate a huge amount of memory for all objects and their instrumentation
at once.  Without the <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.query.Query.yield_per" title="sqlalchemy.orm.query.Query.yield_per"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.yield_per()</span></code></a>, the above script on the
MacBookPro is 31 seconds on 0.9 and 26 seconds on 1.0, the extra time spent
setting up very large memory buffers.</p>
</div>
<div class="section" id="new-keyedtuple-implementation-dramatically-faster">
<span id="feature-3176"></span><h3>New KeyedTuple implementation dramatically faster<a class="headerlink" href="#new-keyedtuple-implementation-dramatically-faster" title="Permalink to this headline">¶</a></h3>
<p>We took a look into the <a class="reference internal" href="../orm/query.html#sqlalchemy.util.KeyedTuple" title="sqlalchemy.util.KeyedTuple"><code class="xref py py-class docutils literal notranslate"><span class="pre">KeyedTuple</span></code></a> implementation in the hopes
of improving queries like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rows</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Foo</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">Foo</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="n">Foo</span><span class="o">.</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span></pre></div>
</div>
<p>The <a class="reference internal" href="../orm/query.html#sqlalchemy.util.KeyedTuple" title="sqlalchemy.util.KeyedTuple"><code class="xref py py-class docutils literal notranslate"><span class="pre">KeyedTuple</span></code></a> class is used rather than Python’s
<code class="docutils literal notranslate"><span class="pre">collections.namedtuple()</span></code>, because the latter has a very complex
type-creation routine that benchmarks much slower than <a class="reference internal" href="../orm/query.html#sqlalchemy.util.KeyedTuple" title="sqlalchemy.util.KeyedTuple"><code class="xref py py-class docutils literal notranslate"><span class="pre">KeyedTuple</span></code></a>.
However, when fetching hundreds of thousands of rows,
<code class="docutils literal notranslate"><span class="pre">collections.namedtuple()</span></code> quickly overtakes <a class="reference internal" href="../orm/query.html#sqlalchemy.util.KeyedTuple" title="sqlalchemy.util.KeyedTuple"><code class="xref py py-class docutils literal notranslate"><span class="pre">KeyedTuple</span></code></a> which
becomes dramatically slower as instance invocation goes up.   What to do?
A new type that hedges between the approaches of both.   Benching
all three types for “size” (number of rows returned) and “num”
(number of distinct queries), the new “lightweight keyed tuple” either
outperforms both, or lags very slightly behind the faster object, based on
which scenario.  In the “sweet spot”, where we are both creating a good number
of new types as well as fetching a good number of rows, the lightweight
object totally smokes both namedtuple and KeyedTuple:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-----------------</span>
<span class="n">size</span><span class="o">=</span><span class="mi">10</span> <span class="n">num</span><span class="o">=</span><span class="mi">10000</span>                 <span class="c1"># few rows, lots of queries</span>
<span class="n">namedtuple</span><span class="p">:</span> <span class="mf">3.60302400589</span>         <span class="c1"># namedtuple falls over</span>
<span class="n">keyedtuple</span><span class="p">:</span> <span class="mf">0.255059957504</span>        <span class="c1"># KeyedTuple very fast</span>
<span class="n">lw</span> <span class="n">keyed</span> <span class="nb">tuple</span><span class="p">:</span> <span class="mf">0.582715034485</span>    <span class="c1"># lw keyed trails right on KeyedTuple</span>
<span class="o">-----------------</span>
<span class="n">size</span><span class="o">=</span><span class="mi">100</span> <span class="n">num</span><span class="o">=</span><span class="mi">1000</span>                 <span class="c1"># &lt;--- sweet spot</span>
<span class="n">namedtuple</span><span class="p">:</span> <span class="mf">0.365247011185</span>
<span class="n">keyedtuple</span><span class="p">:</span> <span class="mf">0.24896979332</span>
<span class="n">lw</span> <span class="n">keyed</span> <span class="nb">tuple</span><span class="p">:</span> <span class="mf">0.0889317989349</span>   <span class="c1"># lw keyed blows both away!</span>
<span class="o">-----------------</span>
<span class="n">size</span><span class="o">=</span><span class="mi">10000</span> <span class="n">num</span><span class="o">=</span><span class="mi">100</span>
<span class="n">namedtuple</span><span class="p">:</span> <span class="mf">0.572599887848</span>
<span class="n">keyedtuple</span><span class="p">:</span> <span class="mf">2.54251694679</span>
<span class="n">lw</span> <span class="n">keyed</span> <span class="nb">tuple</span><span class="p">:</span> <span class="mf">0.613876104355</span>
<span class="o">-----------------</span>
<span class="n">size</span><span class="o">=</span><span class="mi">1000000</span> <span class="n">num</span><span class="o">=</span><span class="mi">10</span>               <span class="c1"># few queries, lots of rows</span>
<span class="n">namedtuple</span><span class="p">:</span> <span class="mf">5.79669594765</span>         <span class="c1"># namedtuple very fast</span>
<span class="n">keyedtuple</span><span class="p">:</span> <span class="mf">28.856498003</span>          <span class="c1"># KeyedTuple falls over</span>
<span class="n">lw</span> <span class="n">keyed</span> <span class="nb">tuple</span><span class="p">:</span> <span class="mf">6.74346804619</span>     <span class="c1"># lw keyed trails right on namedtuple</span></pre></div>
</div>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3176">#3176</a></p>
</div>
<div class="section" id="significant-improvements-in-structural-memory-use">
<span id="feature-slots"></span><h3>Significant Improvements in Structural Memory Use<a class="headerlink" href="#significant-improvements-in-structural-memory-use" title="Permalink to this headline">¶</a></h3>
<p>Structural memory use has been improved via much more significant use
of <code class="docutils literal notranslate"><span class="pre">__slots__</span></code> for many internal objects.  This optimization is
particularly geared towards the base memory size of large applications
that have lots of tables and columns, and reduces memory
size for a variety of high-volume objects including event listening
internals, comparator objects and parts of the ORM attribute and
loader strategy system.</p>
<p>A bench that makes use of heapy measure the startup size of Nova
illustrates a difference of about 3.7 fewer megs, or 46%,
taken up by SQLAlchemy’s objects, associated dictionaries, as
well as weakrefs, within a basic import of “nova.db.sqlalchemy.models”:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># reported by heapy, summation of SQLAlchemy objects +</span>
<span class="c1"># associated dicts + weakref-related objects with core of Nova imported:</span>

    <span class="n">Before</span><span class="p">:</span> <span class="n">total</span> <span class="n">count</span> <span class="mi">26477</span> <span class="n">total</span> <span class="nb">bytes</span> <span class="mi">7975712</span>
    <span class="n">After</span><span class="p">:</span> <span class="n">total</span> <span class="n">count</span> <span class="mi">18181</span> <span class="n">total</span> <span class="nb">bytes</span> <span class="mi">4236456</span>

<span class="c1"># reported for the Python module space overall with the</span>
<span class="c1"># core of Nova imported:</span>

    <span class="n">Before</span><span class="p">:</span> <span class="n">Partition</span> <span class="n">of</span> <span class="n">a</span> <span class="nb">set</span> <span class="n">of</span> <span class="mi">355558</span> <span class="n">objects</span><span class="o">.</span> <span class="n">Total</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">61661760</span> <span class="nb">bytes</span><span class="o">.</span>
    <span class="n">After</span><span class="p">:</span> <span class="n">Partition</span> <span class="n">of</span> <span class="n">a</span> <span class="nb">set</span> <span class="n">of</span> <span class="mi">346034</span> <span class="n">objects</span><span class="o">.</span> <span class="n">Total</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">57808016</span> <span class="nb">bytes</span><span class="o">.</span></pre></div>
</div>
</div>
<div class="section" id="update-statements-are-now-batched-with-executemany-in-a-flush">
<span id="feature-updatemany"></span><h3>UPDATE statements are now batched with executemany() in a flush<a class="headerlink" href="#update-statements-are-now-batched-with-executemany-in-a-flush" title="Permalink to this headline">¶</a></h3>
<p>UPDATE statements can now be batched within an ORM flush
into more performant executemany() call, similarly to how INSERT
statements can be batched; this will be invoked within flush
based on the following criteria:</p>
<ul class="simple">
<li><p>two or more UPDATE statements in sequence involve the identical set of
columns to be modified.</p></li>
<li><p>The statement has no embedded SQL expressions in the SET clause.</p></li>
<li><p>The mapping does not use a <a class="reference internal" href="../orm/mapping_api.html#sqlalchemy.orm.mapper.params.version_id_col" title="sqlalchemy.orm.mapper"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">mapper.version_id_col</span></code></a>, or
the backend dialect supports a “sane” rowcount for an executemany()
operation; most DBAPIs support this correctly now.</p></li>
</ul>
</div>
<div class="section" id="session-get-bind-handles-a-wider-variety-of-inheritance-scenarios">
<span id="bug-3035"></span><span id="feature-3178"></span><h3>Session.get_bind() handles a wider variety of inheritance scenarios<a class="headerlink" href="#session-get-bind-handles-a-wider-variety-of-inheritance-scenarios" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.session.Session.get_bind" title="sqlalchemy.orm.session.Session.get_bind"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.get_bind()</span></code></a> method is invoked whenever a query or unit
of work flush process seeks to locate the database engine that corresponds
to a particular class.   The method has been improved to handle a variety
of inheritance-oriented scenarios, including:</p>
<ul>
<li><p>Binding to a Mixin or Abstract Class:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyClass</span><span class="p">(</span><span class="n">SomeMixin</span><span class="p">,</span> <span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;my_table&#39;</span>
    <span class="c1"># ...</span>

<span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">binds</span><span class="o">=</span><span class="p">{</span><span class="n">SomeMixin</span><span class="p">:</span> <span class="n">some_engine</span><span class="p">})</span></pre></div>
</div>
</li>
<li><p>Binding to inherited concrete subclasses individually based on table:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">BaseClass</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;base&#39;</span>

    <span class="c1"># ...</span>

<span class="k">class</span> <span class="nc">ConcreteSubClass</span><span class="p">(</span><span class="n">BaseClass</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;concrete&#39;</span>

    <span class="c1"># ...</span>

    <span class="n">__mapper_args__</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;concrete&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>


<span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">binds</span><span class="o">=</span><span class="p">{</span>
    <span class="n">base_table</span><span class="p">:</span> <span class="n">some_engine</span><span class="p">,</span>
    <span class="n">concrete_table</span><span class="p">:</span> <span class="n">some_other_engine</span>
<span class="p">})</span></pre></div>
</div>
</li>
</ul>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3035">#3035</a></p>
</div>
<div class="section" id="session-get-bind-will-receive-the-mapper-in-all-relevant-query-cases">
<span id="bug-3227"></span><h3>Session.get_bind() will receive the Mapper in all relevant Query cases<a class="headerlink" href="#session-get-bind-will-receive-the-mapper-in-all-relevant-query-cases" title="Permalink to this headline">¶</a></h3>
<p>A series of issues were repaired where the <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.session.Session.get_bind" title="sqlalchemy.orm.session.Session.get_bind"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.get_bind()</span></code></a>
would not receive the primary <a class="reference internal" href="../orm/mapping_api.html#sqlalchemy.orm.Mapper" title="sqlalchemy.orm.Mapper"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapper</span></code></a> of the <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.query.Query" title="sqlalchemy.orm.query.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a>,
even though this mapper was readily available (the primary mapper is the
single mapper, or alternatively the first mapper, that is associated with
a <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.query.Query" title="sqlalchemy.orm.query.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a> object).</p>
<p>The <a class="reference internal" href="../orm/mapping_api.html#sqlalchemy.orm.Mapper" title="sqlalchemy.orm.Mapper"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapper</span></code></a> object, when passed to <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.session.Session.get_bind" title="sqlalchemy.orm.session.Session.get_bind"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.get_bind()</span></code></a>,
is typically used by sessions that make use of the
<a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.session.Session.params.binds" title="sqlalchemy.orm.session.Session"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Session.binds</span></code></a> parameter to associate mappers with a
series of engines (although in this use case, things frequently
“worked” in most cases anyway as the bind would be located via the
mapped table object), or more specifically implement a user-defined
<a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.session.Session.get_bind" title="sqlalchemy.orm.session.Session.get_bind"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.get_bind()</span></code></a> method that provies some pattern of
selecting engines based on mappers, such as horizontal sharding or a
so-called “routing” session that routes queries to different backends.</p>
<p>These scenarios include:</p>
<ul>
<li><p><a class="reference internal" href="../orm/query.html#sqlalchemy.orm.query.Query.count" title="sqlalchemy.orm.query.Query.count"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.count()</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span></pre></div>
</div>
</li>
<li><p><a class="reference internal" href="../orm/query.html#sqlalchemy.orm.query.Query.update" title="sqlalchemy.orm.query.Query.update"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.update()</span></code></a> and <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.query.Query.delete" title="sqlalchemy.orm.query.Query.delete"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.delete()</span></code></a>, both for the UPDATE/DELETE
statement as well as for the SELECT used by the “fetch” strategy:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">15</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;foob&quot;</span><span class="p">},</span> <span class="n">synchronize_session</span><span class="o">=</span><span class="s1">&#39;fetch&#39;</span><span class="p">)</span>

<span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">15</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span>
        <span class="n">synchronize_session</span><span class="o">=</span><span class="s1">&#39;fetch&#39;</span><span class="p">)</span></pre></div>
</div>
</li>
<li><p>Queries against individual columns:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">User</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span></pre></div>
</div>
</li>
<li><p>SQL functions and other expressions against indirect mappings such as
<a class="reference internal" href="../orm/mapping_columns.html#sqlalchemy.orm.column_property" title="sqlalchemy.orm.column_property"><code class="xref py py-obj docutils literal notranslate"><span class="pre">column_property</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="c1"># ...</span>

    <span class="n">score</span> <span class="o">=</span> <span class="n">column_property</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">coalesce</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)))</span>

<span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">score</span><span class="p">))</span><span class="o">.</span><span class="n">scalar</span><span class="p">()</span></pre></div>
</div>
</li>
</ul>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3227">#3227</a> <a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3242">#3242</a> <a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/1326">#1326</a></p>
</div>
<div class="section" id="info-dictionary-improvements">
<span id="feature-2963"></span><h3>.info dictionary improvements<a class="headerlink" href="#info-dictionary-improvements" title="Permalink to this headline">¶</a></h3>
<p>The <code class="xref py py-attr docutils literal notranslate"><span class="pre">InspectionAttr.info</span></code> collection is now available on every kind
of object that one would retrieve from the <a class="reference internal" href="../orm/mapping_api.html#sqlalchemy.orm.Mapper.all_orm_descriptors" title="sqlalchemy.orm.Mapper.all_orm_descriptors"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Mapper.all_orm_descriptors</span></code></a>
collection.  This includes <a class="reference internal" href="../orm/extensions/hybrid.html#sqlalchemy.ext.hybrid.hybrid_property" title="sqlalchemy.ext.hybrid.hybrid_property"><code class="xref py py-class docutils literal notranslate"><span class="pre">hybrid_property</span></code></a> and <a class="reference internal" href="../orm/extensions/associationproxy.html#sqlalchemy.ext.associationproxy.association_proxy" title="sqlalchemy.ext.associationproxy.association_proxy"><code class="xref py py-func docutils literal notranslate"><span class="pre">association_proxy()</span></code></a>.
However, as these objects are class-bound descriptors, they must be accessed
<strong>separately</strong> from the class to which they are attached in order to get
at the attribute.  Below this is illustrated using the
<a class="reference internal" href="../orm/mapping_api.html#sqlalchemy.orm.Mapper.all_orm_descriptors" title="sqlalchemy.orm.Mapper.all_orm_descriptors"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Mapper.all_orm_descriptors</span></code></a> namespace:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SomeObject</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="c1"># ...</span>

    <span class="nd">@hybrid_property</span>
    <span class="k">def</span> <span class="nf">some_prop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="mi">5</span>


<span class="n">inspect</span><span class="p">(</span><span class="n">SomeObject</span><span class="p">)</span><span class="o">.</span><span class="n">all_orm_descriptors</span><span class="o">.</span><span class="n">some_prop</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;foo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;bar&#39;</span></pre></div>
</div>
<p>It is also available as a constructor argument for all <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.SchemaItem" title="sqlalchemy.schema.SchemaItem"><code class="xref py py-class docutils literal notranslate"><span class="pre">SchemaItem</span></code></a>
objects (e.g. <a class="reference internal" href="../core/constraints.html#sqlalchemy.schema.ForeignKey" title="sqlalchemy.schema.ForeignKey"><code class="xref py py-class docutils literal notranslate"><span class="pre">ForeignKey</span></code></a>, <a class="reference internal" href="../core/constraints.html#sqlalchemy.schema.UniqueConstraint" title="sqlalchemy.schema.UniqueConstraint"><code class="xref py py-class docutils literal notranslate"><span class="pre">UniqueConstraint</span></code></a> etc.) as well
as remaining ORM constructs such as <a class="reference internal" href="../orm/mapped_attributes.html#sqlalchemy.orm.synonym" title="sqlalchemy.orm.synonym"><code class="xref py py-func docutils literal notranslate"><span class="pre">synonym()</span></code></a>.</p>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/2971">#2971</a></p>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/2963">#2963</a></p>
</div>
<div class="section" id="columnproperty-constructs-work-a-lot-better-with-aliases-order-by">
<span id="bug-3188"></span><h3>ColumnProperty constructs work a lot better with aliases, order_by<a class="headerlink" href="#columnproperty-constructs-work-a-lot-better-with-aliases-order-by" title="Permalink to this headline">¶</a></h3>
<p>A variety of issues regarding <a class="reference internal" href="../orm/mapping_columns.html#sqlalchemy.orm.column_property" title="sqlalchemy.orm.column_property"><code class="xref py py-func docutils literal notranslate"><span class="pre">column_property()</span></code></a> have been fixed,
most specifically with regards to the <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.aliased" title="sqlalchemy.orm.aliased"><code class="xref py py-func docutils literal notranslate"><span class="pre">aliased()</span></code></a> construct as well
as the “order by label” logic introduced in 0.9 (see <a class="reference internal" href="migration_09.html#migration-1068"><span class="std std-ref">Label constructs can now render as their name alone in an ORDER BY</span></a>).</p>
<p>Given a mapping like the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">B</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">a_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;a.id&#39;</span><span class="p">))</span>


<span class="n">A</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">column_property</span><span class="p">(</span>
        <span class="n">select</span><span class="p">([</span><span class="n">func</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">B</span><span class="o">.</span><span class="n">id</span><span class="p">)])</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">B</span><span class="o">.</span><span class="n">a_id</span> <span class="o">==</span> <span class="n">A</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">correlate</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="p">)</span></pre></div>
</div>
<p>A simple scenario that included “A.b” twice would fail to render
correctly:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">sess</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">a1</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">a1</span><span class="o">.</span><span class="n">b</span><span class="p">))</span></pre></div>
</div>
<p>This would order by the wrong column:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="n">a</span><span class="o">.</span><span class="n">id</span> <span class="n">AS</span> <span class="n">a_id</span><span class="p">,</span> <span class="p">(</span><span class="n">SELECT</span> <span class="nb">max</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="n">AS</span> <span class="n">max_1</span> <span class="n">FROM</span> <span class="n">b</span>
<span class="n">WHERE</span> <span class="n">b</span><span class="o">.</span><span class="n">a_id</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="n">AS</span> <span class="n">anon_1</span><span class="p">,</span> <span class="n">a_1</span><span class="o">.</span><span class="n">id</span> <span class="n">AS</span> <span class="n">a_1_id</span><span class="p">,</span>
<span class="p">(</span><span class="n">SELECT</span> <span class="nb">max</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="n">AS</span> <span class="n">max_2</span>
<span class="n">FROM</span> <span class="n">b</span> <span class="n">WHERE</span> <span class="n">b</span><span class="o">.</span><span class="n">a_id</span> <span class="o">=</span> <span class="n">a_1</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="n">AS</span> <span class="n">anon_2</span>
<span class="n">FROM</span> <span class="n">a</span><span class="p">,</span> <span class="n">a</span> <span class="n">AS</span> <span class="n">a_1</span> <span class="n">ORDER</span> <span class="n">BY</span> <span class="n">anon_1</span></pre></div>
</div>
<p>New output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="n">a</span><span class="o">.</span><span class="n">id</span> <span class="n">AS</span> <span class="n">a_id</span><span class="p">,</span> <span class="p">(</span><span class="n">SELECT</span> <span class="nb">max</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="n">AS</span> <span class="n">max_1</span>
<span class="n">FROM</span> <span class="n">b</span> <span class="n">WHERE</span> <span class="n">b</span><span class="o">.</span><span class="n">a_id</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="n">AS</span> <span class="n">anon_1</span><span class="p">,</span> <span class="n">a_1</span><span class="o">.</span><span class="n">id</span> <span class="n">AS</span> <span class="n">a_1_id</span><span class="p">,</span>
<span class="p">(</span><span class="n">SELECT</span> <span class="nb">max</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="n">AS</span> <span class="n">max_2</span>
<span class="n">FROM</span> <span class="n">b</span> <span class="n">WHERE</span> <span class="n">b</span><span class="o">.</span><span class="n">a_id</span> <span class="o">=</span> <span class="n">a_1</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="n">AS</span> <span class="n">anon_2</span>
<span class="n">FROM</span> <span class="n">a</span><span class="p">,</span> <span class="n">a</span> <span class="n">AS</span> <span class="n">a_1</span> <span class="n">ORDER</span> <span class="n">BY</span> <span class="n">anon_2</span></pre></div>
</div>
<p>There were also many scenarios where the “order by” logic would fail
to order by label, for example if the mapping were “polymorphic”:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>

    <span class="n">__mapper_args__</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;polymorphic_on&#39;</span><span class="p">:</span> <span class="nb">type</span><span class="p">,</span> <span class="s1">&#39;with_polymorphic&#39;</span><span class="p">:</span> <span class="s1">&#39;*&#39;</span><span class="p">}</span></pre></div>
</div>
<p>The order_by would fail to use the label, as it would be anonymized due
to the polymorphic loading:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="n">a</span><span class="o">.</span><span class="n">id</span> <span class="n">AS</span> <span class="n">a_id</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">type</span> <span class="n">AS</span> <span class="n">a_type</span><span class="p">,</span> <span class="p">(</span><span class="n">SELECT</span> <span class="nb">max</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="n">AS</span> <span class="n">max_1</span>
<span class="n">FROM</span> <span class="n">b</span> <span class="n">WHERE</span> <span class="n">b</span><span class="o">.</span><span class="n">a_id</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="n">AS</span> <span class="n">anon_1</span>
<span class="n">FROM</span> <span class="n">a</span> <span class="n">ORDER</span> <span class="n">BY</span> <span class="p">(</span><span class="n">SELECT</span> <span class="nb">max</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="n">AS</span> <span class="n">max_2</span>
<span class="n">FROM</span> <span class="n">b</span> <span class="n">WHERE</span> <span class="n">b</span><span class="o">.</span><span class="n">a_id</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">id</span><span class="p">)</span></pre></div>
</div>
<p>Now that the order by label tracks the anonymized label, this now works:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="n">a</span><span class="o">.</span><span class="n">id</span> <span class="n">AS</span> <span class="n">a_id</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">type</span> <span class="n">AS</span> <span class="n">a_type</span><span class="p">,</span> <span class="p">(</span><span class="n">SELECT</span> <span class="nb">max</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="n">AS</span> <span class="n">max_1</span>
<span class="n">FROM</span> <span class="n">b</span> <span class="n">WHERE</span> <span class="n">b</span><span class="o">.</span><span class="n">a_id</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="n">AS</span> <span class="n">anon_1</span>
<span class="n">FROM</span> <span class="n">a</span> <span class="n">ORDER</span> <span class="n">BY</span> <span class="n">anon_1</span></pre></div>
</div>
<p>Included in these fixes are a variety of heisenbugs that could corrupt
the state of an <code class="docutils literal notranslate"><span class="pre">aliased()</span></code> construct such that the labeling logic
would again fail; these have also been fixed.</p>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3148">#3148</a> <a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3188">#3188</a></p>
</div>
</div>
<div class="section" id="new-features-and-improvements-core">
<h2>New Features and Improvements - Core<a class="headerlink" href="#new-features-and-improvements-core" title="Permalink to this headline">¶</a></h2>
<div class="section" id="select-query-limit-offset-may-be-specified-as-an-arbitrary-sql-expression">
<span id="feature-3034"></span><h3>Select/Query LIMIT / OFFSET may be specified as an arbitrary SQL expression<a class="headerlink" href="#select-query-limit-offset-may-be-specified-as-an-arbitrary-sql-expression" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select.limit" title="sqlalchemy.sql.expression.Select.limit"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.limit()</span></code></a> and <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select.offset" title="sqlalchemy.sql.expression.Select.offset"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.offset()</span></code></a> methods now accept
any SQL expression, in addition to integer values, as arguments.  The ORM
<a class="reference internal" href="../orm/query.html#sqlalchemy.orm.query.Query" title="sqlalchemy.orm.query.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a> object also passes through any expression to the underlying
<a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select" title="sqlalchemy.sql.expression.Select"><code class="xref py py-class docutils literal notranslate"><span class="pre">Select</span></code></a> object.   Typically
this is used to allow a bound parameter to be passed, which can be substituted
with a value later:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sel</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">table</span><span class="p">])</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">bindparam</span><span class="p">(</span><span class="s1">&#39;mylimit&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">offset</span><span class="p">(</span><span class="n">bindparam</span><span class="p">(</span><span class="s1">&#39;myoffset&#39;</span><span class="p">))</span></pre></div>
</div>
<p>Dialects which don’t support non-integer LIMIT or OFFSET expressions may continue
to not support this behavior; third party dialects may also need modification
in order to take advantage of the new behavior.  A dialect which currently
uses the <code class="docutils literal notranslate"><span class="pre">._limit</span></code> or <code class="docutils literal notranslate"><span class="pre">._offset</span></code> attributes will continue to function
for those cases where the limit/offset was specified as a simple integer value.
However, when a SQL expression is specified, these two attributes will
instead raise a <a class="reference internal" href="../core/exceptions.html#sqlalchemy.exc.CompileError" title="sqlalchemy.exc.CompileError"><code class="xref py py-class docutils literal notranslate"><span class="pre">CompileError</span></code></a> on access.  A third-party dialect which
wishes to support the new feature should now call upon the <code class="docutils literal notranslate"><span class="pre">._limit_clause</span></code>
and <code class="docutils literal notranslate"><span class="pre">._offset_clause</span></code> attributes to receive the full SQL expression, rather
than the integer value.</p>
</div>
<div class="section" id="the-use-alter-flag-on-foreignkeyconstraint-is-usually-no-longer-needed">
<span id="feature-3282"></span><h3>The <code class="docutils literal notranslate"><span class="pre">use_alter</span></code> flag on <code class="docutils literal notranslate"><span class="pre">ForeignKeyConstraint</span></code> is (usually) no longer needed<a class="headerlink" href="#the-use-alter-flag-on-foreignkeyconstraint-is-usually-no-longer-needed" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.MetaData.create_all" title="sqlalchemy.schema.MetaData.create_all"><code class="xref py py-meth docutils literal notranslate"><span class="pre">MetaData.create_all()</span></code></a> and <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.MetaData.drop_all" title="sqlalchemy.schema.MetaData.drop_all"><code class="xref py py-meth docutils literal notranslate"><span class="pre">MetaData.drop_all()</span></code></a> methods will
now make use of a system that automatically renders an ALTER statement
for foreign key constraints that are involved in mutually-dependent cycles
between tables, without the
need to specify <a class="reference internal" href="../core/constraints.html#sqlalchemy.schema.ForeignKeyConstraint.params.use_alter" title="sqlalchemy.schema.ForeignKeyConstraint"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">ForeignKeyConstraint.use_alter</span></code></a>.   Additionally,
the foreign key constraints no longer need to have a name in order to be
created via ALTER; only the DROP operation requires a name.   In the case
of a DROP, the feature will ensure that only constraints which have
explicit names are actually included as ALTER statements.  In the
case of an unresolvable cycle within a DROP, the system emits
a succinct and clear error message now if the DROP cannot proceed.</p>
<p>The <a class="reference internal" href="../core/constraints.html#sqlalchemy.schema.ForeignKeyConstraint.params.use_alter" title="sqlalchemy.schema.ForeignKeyConstraint"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">ForeignKeyConstraint.use_alter</span></code></a> and
<a class="reference internal" href="../core/constraints.html#sqlalchemy.schema.ForeignKey.params.use_alter" title="sqlalchemy.schema.ForeignKey"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">ForeignKey.use_alter</span></code></a> flags remain in place, and continue to have
the same effect of establishing those constraints for which ALTER is
required during a CREATE/DROP scenario.</p>
<p>As of version 1.0.1, special logic takes over in the case of SQLite, which
does not support ALTER, in the case that during a DROP, the given tables have
an unresolvable cycle; in this case a warning is emitted, and the tables
are dropped with <strong>no</strong> ordering, which is usually fine on SQLite unless
constraints are enabled. To resolve the warning and proceed with at least
a partial ordering on a SQLite database, particularly one where constraints
are enabled, re-apply “use_alter” flags to those
<a class="reference internal" href="../core/constraints.html#sqlalchemy.schema.ForeignKey" title="sqlalchemy.schema.ForeignKey"><code class="xref py py-class docutils literal notranslate"><span class="pre">ForeignKey</span></code></a> and <a class="reference internal" href="../core/constraints.html#sqlalchemy.schema.ForeignKeyConstraint" title="sqlalchemy.schema.ForeignKeyConstraint"><code class="xref py py-class docutils literal notranslate"><span class="pre">ForeignKeyConstraint</span></code></a> objects which should
be explicitly omitted from the sort.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../core/constraints.html#use-alter"><span class="std std-ref">Creating/Dropping Foreign Key Constraints via ALTER</span></a> - full description of the new behavior.</p>
</div>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3282">#3282</a></p>
</div>
<div class="section" id="resultproxy-auto-close-is-now-a-soft-close">
<span id="change-3330"></span><h3>ResultProxy “auto close” is now a “soft” close<a class="headerlink" href="#resultproxy-auto-close-is-now-a-soft-close" title="Permalink to this headline">¶</a></h3>
<p>For many releases, the <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.ResultProxy" title="sqlalchemy.engine.ResultProxy"><code class="xref py py-class docutils literal notranslate"><span class="pre">ResultProxy</span></code></a> object has always been
automatically closed out at the point at which all result rows have been
fetched.  This was to allow usage of the object without the need to call
upon <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.ResultProxy.close" title="sqlalchemy.engine.ResultProxy.close"><code class="xref py py-meth docutils literal notranslate"><span class="pre">ResultProxy.close()</span></code></a> explicitly; as all DBAPI resources had been
freed, the object was safe to discard.   However, the object maintained
a strict “closed” behavior, which meant that any subsequent calls to
<a class="reference internal" href="../core/connections.html#sqlalchemy.engine.ResultProxy.fetchone" title="sqlalchemy.engine.ResultProxy.fetchone"><code class="xref py py-meth docutils literal notranslate"><span class="pre">ResultProxy.fetchone()</span></code></a>, <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.ResultProxy.fetchmany" title="sqlalchemy.engine.ResultProxy.fetchmany"><code class="xref py py-meth docutils literal notranslate"><span class="pre">ResultProxy.fetchmany()</span></code></a> or
<a class="reference internal" href="../core/connections.html#sqlalchemy.engine.ResultProxy.fetchall" title="sqlalchemy.engine.ResultProxy.fetchall"><code class="xref py py-meth docutils literal notranslate"><span class="pre">ResultProxy.fetchall()</span></code></a> would now raise a <a class="reference internal" href="../core/exceptions.html#sqlalchemy.exc.ResourceClosedError" title="sqlalchemy.exc.ResourceClosedError"><code class="xref py py-class docutils literal notranslate"><span class="pre">ResourceClosedError</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
<span class="go">(1, &#39;x&#39;)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
<span class="go">None  # indicates no more rows</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
<span class="go">exception: ResourceClosedError</span></pre></div>
</div>
<p>This behavior is inconsistent vs. what pep-249 states, which is
that you can call upon the fetch methods repeatedly even after results
are exhausted.  It also interferes with behavior for some implementations of
result proxy, such as the <code class="xref py py-class docutils literal notranslate"><span class="pre">BufferedColumnResultProxy</span></code> used by the
cx_oracle dialect for certain datatypes.</p>
<p>To solve this, the “closed” state of the <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.ResultProxy" title="sqlalchemy.engine.ResultProxy"><code class="xref py py-class docutils literal notranslate"><span class="pre">ResultProxy</span></code></a> has been
broken into two states; a “soft close” which does the majority of what
“close” does, in that it releases the DBAPI cursor and in the case of a
“close with result” object will also release the connection, and a
“closed” state which is everything included by “soft close” as well as
establishing the fetch methods as “closed”.   The <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.ResultProxy.close" title="sqlalchemy.engine.ResultProxy.close"><code class="xref py py-meth docutils literal notranslate"><span class="pre">ResultProxy.close()</span></code></a>
method is now never called implicitly, only the <code class="xref py py-meth docutils literal notranslate"><span class="pre">ResultProxy._soft_close()</span></code>
method which is non-public:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
<span class="go">(1, &#39;x&#39;)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
<span class="go">None  # indicates no more rows</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
<span class="go">None  # still None</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="go">[]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
<span class="go">exception: ResourceClosedError  # *now* it raises</span></pre></div>
</div>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3330">#3330</a>
<a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3329">#3329</a></p>
</div>
<div class="section" id="check-constraints-now-support-the-column-0-name-s-token-in-naming-conventions">
<h3>CHECK Constraints now support the <code class="docutils literal notranslate"><span class="pre">%(column_0_name)s</span></code> token in naming conventions<a class="headerlink" href="#check-constraints-now-support-the-column-0-name-s-token-in-naming-conventions" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">%(column_0_name)s</span></code> will derive from the first column found in the
expression of a <a class="reference internal" href="../core/constraints.html#sqlalchemy.schema.CheckConstraint" title="sqlalchemy.schema.CheckConstraint"><code class="xref py py-class docutils literal notranslate"><span class="pre">CheckConstraint</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">metadata</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">(</span>
    <span class="n">naming_convention</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;ck&quot;</span><span class="p">:</span> <span class="s2">&quot;ck_</span><span class="si">%(table_name)s</span><span class="s2">_</span><span class="si">%(column_0_name)s</span><span class="s2">&quot;</span><span class="p">}</span>
<span class="p">)</span>

<span class="n">foo</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">),</span>
<span class="p">)</span>

<span class="n">CheckConstraint</span><span class="p">(</span><span class="n">foo</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">value</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span></pre></div>
</div>
<p>Will render:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CREATE</span> <span class="n">TABLE</span> <span class="n">foo</span> <span class="p">(</span>
    <span class="n">value</span> <span class="n">INTEGER</span><span class="p">,</span>
    <span class="n">CONSTRAINT</span> <span class="n">ck_foo_value</span> <span class="n">CHECK</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
<span class="p">)</span></pre></div>
</div>
<p>The combination of naming conventions with the constraint produced by a
<a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.SchemaType" title="sqlalchemy.types.SchemaType"><code class="xref py py-class docutils literal notranslate"><span class="pre">SchemaType</span></code></a> such as <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Boolean" title="sqlalchemy.types.Boolean"><code class="xref py py-class docutils literal notranslate"><span class="pre">Boolean</span></code></a> or <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Enum" title="sqlalchemy.types.Enum"><code class="xref py py-class docutils literal notranslate"><span class="pre">Enum</span></code></a> will also
now make use of all CHECK constraint conventions.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../core/constraints.html#naming-check-constraints"><span class="std std-ref">Naming CHECK Constraints</span></a></p>
<p><a class="reference internal" href="../core/constraints.html#naming-schematypes"><span class="std std-ref">Configuring Naming for Boolean, Enum, and other schema types</span></a></p>
</div>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3299">#3299</a></p>
</div>
<div class="section" id="constraints-referring-to-unattached-columns-can-auto-attach-to-the-table-when-their-referred-columns-are-attached">
<span id="change-3341"></span><h3>Constraints referring to unattached Columns can auto-attach to the Table when their referred columns are attached<a class="headerlink" href="#constraints-referring-to-unattached-columns-can-auto-attach-to-the-table-when-their-referred-columns-are-attached" title="Permalink to this headline">¶</a></h3>
<p>Since at least version 0.8, a <a class="reference internal" href="../core/constraints.html#sqlalchemy.schema.Constraint" title="sqlalchemy.schema.Constraint"><code class="xref py py-class docutils literal notranslate"><span class="pre">Constraint</span></code></a> has had the ability to
“auto-attach” itself to a <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> based on being passed table-attached columns:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="n">Table</span><span class="p">,</span> <span class="n">Column</span><span class="p">,</span> <span class="n">MetaData</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">UniqueConstraint</span>

<span class="n">m</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">()</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">uq</span> <span class="o">=</span> <span class="n">UniqueConstraint</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">b</span><span class="p">)</span>  <span class="c1"># will auto-attach to Table</span>

<span class="k">assert</span> <span class="n">uq</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">constraints</span></pre></div>
</div>
<p>In order to assist with some cases that tend to come up with declarative,
this same auto-attachment logic can now function even if the <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a>
objects are not yet associated with the <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a>; additional events
are established such that when those <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> objects are associated,
the <a class="reference internal" href="../core/constraints.html#sqlalchemy.schema.Constraint" title="sqlalchemy.schema.Constraint"><code class="xref py py-class docutils literal notranslate"><span class="pre">Constraint</span></code></a> is also added:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="n">Table</span><span class="p">,</span> <span class="n">Column</span><span class="p">,</span> <span class="n">MetaData</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">UniqueConstraint</span>

<span class="n">m</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">()</span>

<span class="n">a</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">)</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">)</span>

<span class="n">uq</span> <span class="o">=</span> <span class="n">UniqueConstraint</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

<span class="k">assert</span> <span class="n">uq</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">constraints</span>  <span class="c1"># constraint auto-attached</span></pre></div>
</div>
<p>The above feature was a late add as of version 1.0.0b3.  A fix as of
version 1.0.4 for <a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3411">#3411</a> ensures that this logic
does not occur if the <a class="reference internal" href="../core/constraints.html#sqlalchemy.schema.Constraint" title="sqlalchemy.schema.Constraint"><code class="xref py py-class docutils literal notranslate"><span class="pre">Constraint</span></code></a> refers to a mixture of
<a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> objects and string column names; as we do not yet have
tracking for the addition of names to a <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="n">Table</span><span class="p">,</span> <span class="n">Column</span><span class="p">,</span> <span class="n">MetaData</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">UniqueConstraint</span>

<span class="n">m</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">()</span>

<span class="n">a</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">)</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">)</span>

<span class="n">uq</span> <span class="o">=</span> <span class="n">UniqueConstraint</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

<span class="c1"># constraint *not* auto-attached, as we do not have tracking</span>
<span class="c1"># to locate when a name &#39;b&#39; becomes available on the table</span>
<span class="k">assert</span> <span class="n">uq</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">constraints</span></pre></div>
</div>
<p>Above, the attachment event for column “a” to table “t” will fire off before
column “b” is attached (as “a” is stated in the <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> constructor
before “b”), and the constraint will fail to locate “b” if it were to attempt
an attachment.  For consistency, if the constraint refers to any string names,
the autoattach-on-column-attach logic is skipped.</p>
<p>The original auto-attach logic of course remains in place, if the <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a>
already contains all the target <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> objects at the time
the <a class="reference internal" href="../core/constraints.html#sqlalchemy.schema.Constraint" title="sqlalchemy.schema.Constraint"><code class="xref py py-class docutils literal notranslate"><span class="pre">Constraint</span></code></a> is constructed:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="n">Table</span><span class="p">,</span> <span class="n">Column</span><span class="p">,</span> <span class="n">MetaData</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">UniqueConstraint</span>

<span class="n">m</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">()</span>

<span class="n">a</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">)</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">)</span>


<span class="n">t</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

<span class="n">uq</span> <span class="o">=</span> <span class="n">UniqueConstraint</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span>

<span class="c1"># constraint auto-attached normally as in older versions</span>
<span class="k">assert</span> <span class="n">uq</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">constraints</span></pre></div>
</div>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3341">#3341</a>
<a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3411">#3411</a></p>
</div>
<div class="section" id="insert-from-select-now-includes-python-and-sql-expression-defaults">
<span id="feature-insert-from-select-defaults"></span><span id="change-2051"></span><h3>INSERT FROM SELECT now includes Python and SQL-expression defaults<a class="headerlink" href="#insert-from-select-now-includes-python-and-sql-expression-defaults" title="Permalink to this headline">¶</a></h3>
<p><a class="reference internal" href="../core/dml.html#sqlalchemy.sql.expression.Insert.from_select" title="sqlalchemy.sql.expression.Insert.from_select"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Insert.from_select()</span></code></a> now includes Python and SQL-expression defaults if
otherwise unspecified; the limitation where non-server column defaults
aren’t included in an INSERT FROM SELECT is now lifted and these
expressions are rendered as constants into the SELECT statement:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="n">Table</span><span class="p">,</span> <span class="n">Column</span><span class="p">,</span> <span class="n">MetaData</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">select</span><span class="p">,</span> <span class="n">func</span>

<span class="n">m</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">()</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
    <span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">func</span><span class="o">.</span><span class="n">somefunction</span><span class="p">()))</span>

<span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">x</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">from_select</span><span class="p">([</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">stmt</span><span class="p">))</span></pre></div>
</div>
<p>Will render:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">INSERT</span> <span class="n">INTO</span> <span class="n">t</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="n">SELECT</span> <span class="n">t</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">somefunction</span><span class="p">()</span> <span class="n">AS</span> <span class="n">somefunction_1</span>
<span class="n">FROM</span> <span class="n">t</span></pre></div>
</div>
<p>The feature can be disabled using
<a class="reference internal" href="../core/dml.html#sqlalchemy.sql.expression.Insert.from_select.params.include_defaults" title="sqlalchemy.sql.expression.Insert.from_select"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Insert.from_select.include_defaults</span></code></a>.</p>
</div>
<div class="section" id="column-server-defaults-now-render-literal-values">
<span id="change-3087"></span><h3>Column server defaults now render literal values<a class="headerlink" href="#column-server-defaults-now-render-literal-values" title="Permalink to this headline">¶</a></h3>
<p>The “literal binds” compiler flag is switched on when a
<a class="reference internal" href="../core/defaults.html#sqlalchemy.schema.DefaultClause" title="sqlalchemy.schema.DefaultClause"><code class="xref py py-class docutils literal notranslate"><span class="pre">DefaultClause</span></code></a>, set up by <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column.params.server_default" title="sqlalchemy.schema.Column"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Column.server_default</span></code></a>
is present as a SQL expression to be compiled.  This allows literals
embedded in SQL to render correctly, such as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="n">Table</span><span class="p">,</span> <span class="n">Column</span><span class="p">,</span> <span class="n">MetaData</span><span class="p">,</span> <span class="n">Text</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.schema</span> <span class="k">import</span> <span class="n">CreateTable</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.dialects.postgresql</span> <span class="k">import</span> <span class="n">ARRAY</span><span class="p">,</span> <span class="n">array</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.dialects</span> <span class="k">import</span> <span class="n">postgresql</span>

<span class="n">metadata</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">()</span>

<span class="n">tbl</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s2">&quot;derp&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;arr&quot;</span><span class="p">,</span> <span class="n">ARRAY</span><span class="p">(</span><span class="n">Text</span><span class="p">),</span>
                <span class="n">server_default</span><span class="o">=</span><span class="n">array</span><span class="p">([</span><span class="s2">&quot;foo&quot;</span><span class="p">,</span> <span class="s2">&quot;bar&quot;</span><span class="p">,</span> <span class="s2">&quot;baz&quot;</span><span class="p">])),</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">CreateTable</span><span class="p">(</span><span class="n">tbl</span><span class="p">)</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">dialect</span><span class="o">=</span><span class="n">postgresql</span><span class="o">.</span><span class="n">dialect</span><span class="p">()))</span></pre></div>
</div>
<p>Now renders:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CREATE</span> <span class="n">TABLE</span> <span class="n">derp</span> <span class="p">(</span>
    <span class="n">arr</span> <span class="n">TEXT</span><span class="p">[]</span> <span class="n">DEFAULT</span> <span class="n">ARRAY</span><span class="p">[</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="s1">&#39;baz&#39;</span><span class="p">]</span>
<span class="p">)</span></pre></div>
</div>
<p>Previously, the literal values <code class="docutils literal notranslate"><span class="pre">&quot;foo&quot;,</span> <span class="pre">&quot;bar&quot;,</span> <span class="pre">&quot;baz&quot;</span></code> would render as
bound parameters, which are useless in DDL.</p>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3087">#3087</a></p>
</div>
<div class="section" id="uniqueconstraint-is-now-part-of-the-table-reflection-process">
<span id="feature-3184"></span><h3>UniqueConstraint is now part of the Table reflection process<a class="headerlink" href="#uniqueconstraint-is-now-part-of-the-table-reflection-process" title="Permalink to this headline">¶</a></h3>
<p>A <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> object populated using <code class="docutils literal notranslate"><span class="pre">autoload=True</span></code> will now
include <a class="reference internal" href="../core/constraints.html#sqlalchemy.schema.UniqueConstraint" title="sqlalchemy.schema.UniqueConstraint"><code class="xref py py-class docutils literal notranslate"><span class="pre">UniqueConstraint</span></code></a> constructs as well as
<a class="reference internal" href="../core/constraints.html#sqlalchemy.schema.Index" title="sqlalchemy.schema.Index"><code class="xref py py-class docutils literal notranslate"><span class="pre">Index</span></code></a> constructs.  This logic has a few caveats for
PostgreSQL and MySQL:</p>
<div class="section" id="postgresql">
<h4>PostgreSQL<a class="headerlink" href="#postgresql" title="Permalink to this headline">¶</a></h4>
<p>PostgreSQL has the behavior such that when a UNIQUE constraint is
created, it implicitly creates a UNIQUE INDEX corresponding to that
constraint as well. The <a class="reference internal" href="../core/reflection.html#sqlalchemy.engine.reflection.Inspector.get_indexes" title="sqlalchemy.engine.reflection.Inspector.get_indexes"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Inspector.get_indexes()</span></code></a> and the
<a class="reference internal" href="../core/reflection.html#sqlalchemy.engine.reflection.Inspector.get_unique_constraints" title="sqlalchemy.engine.reflection.Inspector.get_unique_constraints"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Inspector.get_unique_constraints()</span></code></a> methods will continue to
<strong>both</strong> return these entries distinctly, where
<a class="reference internal" href="../core/reflection.html#sqlalchemy.engine.reflection.Inspector.get_indexes" title="sqlalchemy.engine.reflection.Inspector.get_indexes"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Inspector.get_indexes()</span></code></a> now features a token
<code class="docutils literal notranslate"><span class="pre">duplicates_constraint</span></code> within the index entry  indicating the
corresponding constraint when detected.   However, when performing
full table reflection using  <code class="docutils literal notranslate"><span class="pre">Table(...,</span> <span class="pre">autoload=True)</span></code>, the
<a class="reference internal" href="../core/constraints.html#sqlalchemy.schema.Index" title="sqlalchemy.schema.Index"><code class="xref py py-class docutils literal notranslate"><span class="pre">Index</span></code></a> construct is detected as being linked to the
<a class="reference internal" href="../core/constraints.html#sqlalchemy.schema.UniqueConstraint" title="sqlalchemy.schema.UniqueConstraint"><code class="xref py py-class docutils literal notranslate"><span class="pre">UniqueConstraint</span></code></a>, and is <strong>not</strong> present within the
<code class="xref py py-attr docutils literal notranslate"><span class="pre">Table.indexes</span></code> collection; only the <a class="reference internal" href="../core/constraints.html#sqlalchemy.schema.UniqueConstraint" title="sqlalchemy.schema.UniqueConstraint"><code class="xref py py-class docutils literal notranslate"><span class="pre">UniqueConstraint</span></code></a>
will be present in the <code class="xref py py-attr docutils literal notranslate"><span class="pre">Table.constraints</span></code> collection.   This
deduplication logic works by joining to the <code class="docutils literal notranslate"><span class="pre">pg_constraint</span></code> table
when querying <code class="docutils literal notranslate"><span class="pre">pg_index</span></code> to see if the two constructs are linked.</p>
</div>
<div class="section" id="mysql">
<h4>MySQL<a class="headerlink" href="#mysql" title="Permalink to this headline">¶</a></h4>
<p>MySQL does not have separate concepts for a UNIQUE INDEX and a UNIQUE
constraint.  While it supports both syntaxes when creating tables and indexes,
it does not store them any differently. The
<a class="reference internal" href="../core/reflection.html#sqlalchemy.engine.reflection.Inspector.get_indexes" title="sqlalchemy.engine.reflection.Inspector.get_indexes"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Inspector.get_indexes()</span></code></a>
and the <a class="reference internal" href="../core/reflection.html#sqlalchemy.engine.reflection.Inspector.get_unique_constraints" title="sqlalchemy.engine.reflection.Inspector.get_unique_constraints"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Inspector.get_unique_constraints()</span></code></a> methods will continue to
<strong>both</strong> return an entry for a UNIQUE index in MySQL,
where <a class="reference internal" href="../core/reflection.html#sqlalchemy.engine.reflection.Inspector.get_unique_constraints" title="sqlalchemy.engine.reflection.Inspector.get_unique_constraints"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Inspector.get_unique_constraints()</span></code></a> features a new token
<code class="docutils literal notranslate"><span class="pre">duplicates_index</span></code> within the constraint entry indicating that this is a
dupe entry corresponding to that index.  However, when performing
full table reflection using <code class="docutils literal notranslate"><span class="pre">Table(...,</span> <span class="pre">autoload=True)</span></code>,
the <a class="reference internal" href="../core/constraints.html#sqlalchemy.schema.UniqueConstraint" title="sqlalchemy.schema.UniqueConstraint"><code class="xref py py-class docutils literal notranslate"><span class="pre">UniqueConstraint</span></code></a> construct is
<strong>not</strong> part of the fully reflected <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> construct under any
circumstances; this construct is always represented by a <a class="reference internal" href="../core/constraints.html#sqlalchemy.schema.Index" title="sqlalchemy.schema.Index"><code class="xref py py-class docutils literal notranslate"><span class="pre">Index</span></code></a>
with the <code class="docutils literal notranslate"><span class="pre">unique=True</span></code> setting present in the <code class="xref py py-attr docutils literal notranslate"><span class="pre">Table.indexes</span></code>
collection.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../dialects/postgresql.html#postgresql-index-reflection"><span class="std std-ref">PostgreSQL Index Reflection</span></a></p>
<p><a class="reference internal" href="../dialects/mysql.html#mysql-unique-constraints"><span class="std std-ref">MySQL Unique Constraints and Reflection</span></a></p>
</div>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3184">#3184</a></p>
</div>
</div>
<div class="section" id="new-systems-to-safely-emit-parameterized-warnings">
<h3>New systems to safely emit parameterized warnings<a class="headerlink" href="#new-systems-to-safely-emit-parameterized-warnings" title="Permalink to this headline">¶</a></h3>
<p>For a long time, there has been a restriction that warning messages could not
refer to data elements, such that a particular function might emit an
infinite number of unique warnings.  The key place this occurs is in the
<code class="docutils literal notranslate"><span class="pre">Unicode</span> <span class="pre">type</span> <span class="pre">received</span> <span class="pre">non-unicode</span> <span class="pre">bind</span> <span class="pre">param</span> <span class="pre">value</span></code> warning.  Placing
the data value in this message would mean that the Python <code class="docutils literal notranslate"><span class="pre">__warningregistry__</span></code>
for that module, or in some cases the Python-global <code class="docutils literal notranslate"><span class="pre">warnings.onceregistry</span></code>,
would grow unbounded, as in most warning scenarios, one of these two collections
is populated with every distinct warning message.</p>
<p>The change here is that by using a special <code class="docutils literal notranslate"><span class="pre">string</span></code> type that purposely
changes how the string is hashed, we can control that a large number of
parameterized messages are hashed only on a small set of possible hash
values, such that a warning such as <code class="docutils literal notranslate"><span class="pre">Unicode</span> <span class="pre">type</span> <span class="pre">received</span> <span class="pre">non-unicode</span>
<span class="pre">bind</span> <span class="pre">param</span> <span class="pre">value</span></code> can be tailored to be emitted only a specific number
of times; beyond that, the Python warnings registry will begin recording
them as duplicates.</p>
<p>To illustrate, the following test script will show only ten warnings being
emitted for ten of the parameter sets, out of a total of 1000:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="n">create_engine</span><span class="p">,</span> <span class="n">Unicode</span><span class="p">,</span> <span class="n">select</span><span class="p">,</span> <span class="n">cast</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="n">e</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s2">&quot;sqlite://&quot;</span><span class="p">)</span>

<span class="c1"># Use the &quot;once&quot; filter (which is also the default for Python</span>
<span class="c1"># warnings).  Exactly ten of these warnings will</span>
<span class="c1"># be emitted; beyond that, the Python warnings registry will accumulate</span>
<span class="c1"># new values as dupes of one of the ten existing.</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;once&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
    <span class="n">e</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">select</span><span class="p">([</span><span class="n">cast</span><span class="p">(</span>
        <span class="p">(</span><span class="s1">&#39;foo_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">))</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">),</span> <span class="n">Unicode</span><span class="p">)]))</span></pre></div>
</div>
<p>The format of the warning here is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">sqlalchemy</span><span class="o">/</span><span class="n">sql</span><span class="o">/</span><span class="n">sqltypes</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">186</span><span class="p">:</span> <span class="n">SAWarning</span><span class="p">:</span> <span class="n">Unicode</span> <span class="nb">type</span> <span class="n">received</span>
  <span class="n">non</span><span class="o">-</span><span class="n">unicode</span> <span class="n">bind</span> <span class="n">param</span> <span class="n">value</span> <span class="s1">&#39;foo_4852&#39;</span><span class="o">.</span> <span class="p">(</span><span class="n">this</span> <span class="n">warning</span> <span class="n">may</span> <span class="n">be</span>
  <span class="n">suppressed</span> <span class="n">after</span> <span class="mi">10</span> <span class="n">occurrences</span><span class="p">)</span></pre></div>
</div>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3178">#3178</a></p>
</div>
</div>
<div class="section" id="key-behavioral-changes-orm">
<h2>Key Behavioral Changes - ORM<a class="headerlink" href="#key-behavioral-changes-orm" title="Permalink to this headline">¶</a></h2>
<div class="section" id="query-update-now-resolves-string-names-into-mapped-attribute-names">
<span id="bug-3228"></span><h3>query.update() now resolves string names into mapped attribute names<a class="headerlink" href="#query-update-now-resolves-string-names-into-mapped-attribute-names" title="Permalink to this headline">¶</a></h3>
<p>The documentation for <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.query.Query.update" title="sqlalchemy.orm.query.Query.update"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.update()</span></code></a> states that the given
<code class="docutils literal notranslate"><span class="pre">values</span></code> dictionary is “a dictionary with attributes names as keys”,
implying that these are mapped attribute names.  Unfortunately, the function
was designed more in mind to receive attributes and SQL expressions and
not as much strings; when strings
were passed, these strings would be passed through straight to the core
update statement without any resolution as far as how these names are
represented on the mapped class, meaning the name would have to match that
of a table column exactly, not how an attribute of that name was mapped
onto the class.</p>
<p>The string names are now resolved as attribute names in earnest:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;user&#39;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;user_name&#39;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">))</span></pre></div>
</div>
<p>Above, the column <code class="docutils literal notranslate"><span class="pre">user_name</span></code> is mapped as <code class="docutils literal notranslate"><span class="pre">name</span></code>.  Previously,
a call to <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.query.Query.update" title="sqlalchemy.orm.query.Query.update"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.update()</span></code></a> that was passed strings would have to
have been called as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;user_name&#39;</span><span class="p">:</span> <span class="s1">&#39;moonbeam&#39;</span><span class="p">})</span></pre></div>
</div>
<p>The given string is now resolved against the entity:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;moonbeam&#39;</span><span class="p">})</span></pre></div>
</div>
<p>It is typically preferable to use the attribute directly, to avoid any
ambiguity:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">User</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="s1">&#39;moonbeam&#39;</span><span class="p">})</span></pre></div>
</div>
<p>The change also indicates that synonyms and hybrid attributes can be referred
to by string name as well:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;user&#39;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;user_name&#39;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">))</span>

    <span class="nd">@hybrid_property</span>
    <span class="k">def</span> <span class="nf">fullname</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

<span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;fullname&#39;</span><span class="p">:</span> <span class="s1">&#39;moonbeam&#39;</span><span class="p">})</span></pre></div>
</div>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3228">#3228</a></p>
</div>
<div class="section" id="warnings-emitted-when-comparing-objects-with-none-values-to-relationships">
<span id="bug-3371"></span><h3>Warnings emitted when comparing objects with None values to relationships<a class="headerlink" href="#warnings-emitted-when-comparing-objects-with-none-values-to-relationships" title="Permalink to this headline">¶</a></h3>
<p>This change is new as of 1.0.1.  Some users are performing
queries that are essentially of this form:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Address</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Address</span><span class="o">.</span><span class="n">user</span> <span class="o">==</span> <span class="n">User</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span></pre></div>
</div>
<p>This pattern is not currently supported in SQLAlchemy.  For all versions,
it emits SQL resembling:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>SELECT address.id AS address_id, address.user_id AS address_user_id,
address.email_address AS address_email_address
FROM address WHERE ? = address.user_id
(None,)</pre></div>
</div>
<p>Note above, there is a comparison <code class="docutils literal notranslate"><span class="pre">WHERE</span> <span class="pre">?</span> <span class="pre">=</span> <span class="pre">address.user_id</span></code> where the
bound value <code class="docutils literal notranslate"><span class="pre">?</span></code> is receiving <code class="docutils literal notranslate"><span class="pre">None</span></code>, or <code class="docutils literal notranslate"><span class="pre">NULL</span></code> in SQL.  <strong>This will
always return False in SQL</strong>.  The comparison here would in theory
generate SQL as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="n">address</span><span class="o">.</span><span class="n">id</span> <span class="n">AS</span> <span class="n">address_id</span><span class="p">,</span> <span class="n">address</span><span class="o">.</span><span class="n">user_id</span> <span class="n">AS</span> <span class="n">address_user_id</span><span class="p">,</span>
<span class="n">address</span><span class="o">.</span><span class="n">email_address</span> <span class="n">AS</span> <span class="n">address_email_address</span>
<span class="n">FROM</span> <span class="n">address</span> <span class="n">WHERE</span> <span class="n">address</span><span class="o">.</span><span class="n">user_id</span> <span class="n">IS</span> <span class="n">NULL</span></pre></div>
</div>
<p>But right now, <strong>it does not</strong>.   Applications which are relying upon the
fact that “NULL = NULL” produces False in all cases run the risk that
someday, SQLAlchemy might fix this issue to generate “IS NULL”, and the queries
will then produce different results.  Therefore with this kind of operation,
you will see a warning:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SAWarning</span><span class="p">:</span> <span class="n">Got</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">value</span> <span class="n">of</span> <span class="n">column</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">;</span> <span class="n">this</span> <span class="ow">is</span> <span class="n">unsupported</span>
<span class="k">for</span> <span class="n">a</span> <span class="n">relationship</span> <span class="n">comparison</span> <span class="ow">and</span> <span class="n">will</span> <span class="ow">not</span> <span class="n">currently</span> <span class="n">produce</span> <span class="n">an</span>
<span class="n">IS</span> <span class="n">comparison</span> <span class="p">(</span><span class="n">but</span> <span class="n">may</span> <span class="ow">in</span> <span class="n">a</span> <span class="n">future</span> <span class="n">release</span><span class="p">)</span></pre></div>
</div>
<p>Note that this pattern was broken in most cases for release 1.0.0 including
all of the betas; a value like <code class="docutils literal notranslate"><span class="pre">SYMBOL('NEVER_SET')</span></code> would be generated.
This issue has been fixed, but as a result of identifying this pattern,
the warning is now there so that we can more safely repair this broken
behavior (now captured in <a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3373">#3373</a>) in a future release.</p>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3371">#3371</a></p>
</div>
<div class="section" id="a-negated-contains-or-equals-relationship-comparison-will-use-the-current-value-of-attributes-not-the-database-value">
<span id="bug-3374"></span><h3>A “negated contains or equals” relationship comparison will use the current value of attributes, not the database value<a class="headerlink" href="#a-negated-contains-or-equals-relationship-comparison-will-use-the-current-value-of-attributes-not-the-database-value" title="Permalink to this headline">¶</a></h3>
<p>This change is new as of 1.0.1; while we would have preferred for this to be in 1.0.0,
it only became apparent as a result of <a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3371">#3371</a>.</p>
<p>Given a mapping:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">B</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">a_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;a.id&#39;</span><span class="p">))</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">)</span></pre></div>
</div>
<p>Given <code class="docutils literal notranslate"><span class="pre">A</span></code>, with primary key of 7, but which we changed to be 10
without flushing:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">s</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">autoflush</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">a1</span> <span class="o">=</span> <span class="n">A</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

<span class="n">a1</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">10</span></pre></div>
</div>
<p>A query against a many-to-one relationship with this object as the target
will use the value 10 in the bound parameters:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">s</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">B</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">B</span><span class="o">.</span><span class="n">a</span> <span class="o">==</span> <span class="n">a1</span><span class="p">)</span></pre></div>
</div>
<p>Produces:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>SELECT b.id AS b_id, b.a_id AS b_a_id
FROM b
WHERE ? = b.a_id
(10,)</pre></div>
</div>
<p>However, before this change, the negation of this criteria would <strong>not</strong> use
10, it would use 7, unless the object were flushed first:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">s</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">B</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">B</span><span class="o">.</span><span class="n">a</span> <span class="o">!=</span> <span class="n">a1</span><span class="p">)</span></pre></div>
</div>
<p>Produces (in 0.9 and all versions prior to 1.0.1):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>SELECT b.id AS b_id, b.a_id AS b_a_id
FROM b
WHERE b.a_id != ? OR b.a_id IS NULL
(7,)</pre></div>
</div>
<p>For a transient object, it would produce a broken query:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="n">b</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">a_id</span>
<span class="n">FROM</span> <span class="n">b</span>
<span class="n">WHERE</span> <span class="n">b</span><span class="o">.</span><span class="n">a_id</span> <span class="o">!=</span> <span class="p">:</span><span class="n">a_id_1</span> <span class="n">OR</span> <span class="n">b</span><span class="o">.</span><span class="n">a_id</span> <span class="n">IS</span> <span class="n">NULL</span>
<span class="p">{</span><span class="sa">u</span><span class="s1">&#39;a_id_1&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">(</span><span class="s1">&#39;NEVER_SET&#39;</span><span class="p">)}</span></pre></div>
</div>
<p>This inconsistency has been repaired, and in all queries the current attribute
value, in this example <code class="docutils literal notranslate"><span class="pre">10</span></code>, will now be used.</p>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3374">#3374</a></p>
</div>
<div class="section" id="changes-to-attribute-events-and-other-operations-regarding-attributes-that-have-no-pre-existing-value">
<span id="migration-3061"></span><h3>Changes to attribute events and other operations regarding attributes that have no pre-existing value<a class="headerlink" href="#changes-to-attribute-events-and-other-operations-regarding-attributes-that-have-no-pre-existing-value" title="Permalink to this headline">¶</a></h3>
<p>In this change, the default return value of <code class="docutils literal notranslate"><span class="pre">None</span></code> when accessing an object
is now returned dynamically on each access, rather than implicitly setting the
attribute’s state with a special “set” operation when it is first accessed.
The visible result of this change is that <code class="docutils literal notranslate"><span class="pre">obj.__dict__</span></code> is not implicitly
modified on get, and there are also some minor behavioral changes
for <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.attributes.get_history" title="sqlalchemy.orm.attributes.get_history"><code class="xref py py-func docutils literal notranslate"><span class="pre">get_history()</span></code></a> and related functions.</p>
<p>Given an object with no state:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">obj</span> <span class="o">=</span> <span class="n">Foo</span><span class="p">()</span></pre></div>
</div>
<p>It has always been SQLAlchemy’s behavior such that if we access a scalar
or many-to-one attribute that was never set, it is returned as <code class="docutils literal notranslate"><span class="pre">None</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">obj</span><span class="o">.</span><span class="n">someattr</span>
<span class="go">None</span></pre></div>
</div>
<p>This value of <code class="docutils literal notranslate"><span class="pre">None</span></code> is in fact now part of the state of <code class="docutils literal notranslate"><span class="pre">obj</span></code>, and is
not unlike as though we had set the attribute explicitly, e.g.
<code class="docutils literal notranslate"><span class="pre">obj.someattr</span> <span class="pre">=</span> <span class="pre">None</span></code>.  However, the “set on get” here would behave
differently as far as history and events.   It would not emit any attribute
event, and additionally if we view history, we see this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">inspect</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">someattr</span><span class="o">.</span><span class="n">history</span>
<span class="go">History(added=(), unchanged=[None], deleted=())   # 0.9 and below</span></pre></div>
</div>
<p>That is, it’s as though the attribute were always <code class="docutils literal notranslate"><span class="pre">None</span></code> and were
never changed.  This is explicitly different from if we had set the
attribute first instead:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">obj</span> <span class="o">=</span> <span class="n">Foo</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">obj</span><span class="o">.</span><span class="n">someattr</span> <span class="o">=</span> <span class="kc">None</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">inspect</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">someattr</span><span class="o">.</span><span class="n">history</span>
<span class="go">History(added=[None], unchanged=(), deleted=())  # all versions</span></pre></div>
</div>
<p>The above means that the behavior of our “set” operation can be corrupted
by the fact that the value was accessed via “get” earlier.  In 1.0, this
inconsistency has been resolved, by no longer actually setting anything
when the default “getter” is used.</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">obj</span> <span class="o">=</span> <span class="n">Foo</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">obj</span><span class="o">.</span><span class="n">someattr</span>
<span class="go">None</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">inspect</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">someattr</span><span class="o">.</span><span class="n">history</span>
<span class="go">History(added=(), unchanged=(), deleted=())  # 1.0</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">obj</span><span class="o">.</span><span class="n">someattr</span> <span class="o">=</span> <span class="kc">None</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">inspect</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">someattr</span><span class="o">.</span><span class="n">history</span>
<span class="go">History(added=[None], unchanged=(), deleted=())</span></pre></div>
</div>
<p>The reason the above behavior hasn’t had much impact is because the
INSERT statement in relational databases considers a missing value to be
the same as NULL in most cases.   Whether SQLAlchemy received a history
event for a particular attribute set to None or not would usually not matter;
as the difference between sending None/NULL or not wouldn’t have an impact.
However, as <a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3060">#3060</a> (described here in <a class="reference internal" href="#migration-3060"><span class="std std-ref">Priority of attribute changes on relationship-bound attributes vs. FK-bound may appear to change</span></a>)
illustrates, there are some seldom edge cases
where we do in fact want to positively have <code class="docutils literal notranslate"><span class="pre">None</span></code> set.  Also, allowing
the attribute event here means it’s now possible to create “default value”
functions for ORM mapped attributes.</p>
<p>As part of this change, the generation of the implicit “None” is now disabled
for other situations where this used to occur; this includes when an
attribute set operation on a many-to-one is received; previously, the “old” value
would be “None” if it had been not set otherwise; it now will send the
value <code class="xref py py-data docutils literal notranslate"><span class="pre">orm.attributes.NEVER_SET</span></code>, which is a value that may be sent
to an attribute listener now.   This symbol may also be received when
calling on mapper utility functions such as <a class="reference internal" href="../orm/mapping_api.html#sqlalchemy.orm.Mapper.primary_key_from_instance" title="sqlalchemy.orm.Mapper.primary_key_from_instance"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Mapper.primary_key_from_instance()</span></code></a>;
if the primary key attributes have no setting at all, whereas the value
would be <code class="docutils literal notranslate"><span class="pre">None</span></code> before, it will now be the <code class="xref py py-data docutils literal notranslate"><span class="pre">orm.attributes.NEVER_SET</span></code>
symbol, and no change to the object’s state occurs.</p>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3061">#3061</a></p>
</div>
<div class="section" id="priority-of-attribute-changes-on-relationship-bound-attributes-vs-fk-bound-may-appear-to-change">
<span id="migration-3060"></span><h3>Priority of attribute changes on relationship-bound attributes vs. FK-bound may appear to change<a class="headerlink" href="#priority-of-attribute-changes-on-relationship-bound-attributes-vs-fk-bound-may-appear-to-change" title="Permalink to this headline">¶</a></h3>
<p>As a side effect of <a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3060">#3060</a>, setting a relationship-bound attribute to <code class="docutils literal notranslate"><span class="pre">None</span></code>
is now a tracked history event which refers to the intention of persisting
<code class="docutils literal notranslate"><span class="pre">None</span></code> to that attribute.   As it has always been the case that setting a
relationship-bound attribute will trump direct assignment to the foreign key
attributes, a change in behavior can be seen here when assigning None.
Given a mapping:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;table_a&#39;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">B</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;table_b&#39;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">a_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;table_a.id&#39;</span><span class="p">))</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">A</span><span class="p">)</span></pre></div>
</div>
<p>In 1.0, the relationship-bound attribute takes precedence over the FK-bound
attribute in all cases, whether or not
the value we assign is a reference to an <code class="docutils literal notranslate"><span class="pre">A</span></code> object or is <code class="docutils literal notranslate"><span class="pre">None</span></code>.
In 0.9, the behavior is inconsistent and
only takes effect if a value is assigned; the None is not considered:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">a1</span> <span class="o">=</span> <span class="n">A</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">a2</span> <span class="o">=</span> <span class="n">A</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">session</span><span class="o">.</span><span class="n">add_all</span><span class="p">([</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">])</span>
<span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

<span class="n">b1</span> <span class="o">=</span> <span class="n">B</span><span class="p">()</span>
<span class="n">b1</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">a1</span>   <span class="c1"># we expect a_id to be &#39;1&#39;; takes precedence in 0.9 and 1.0</span>

<span class="n">b2</span> <span class="o">=</span> <span class="n">B</span><span class="p">()</span>
<span class="n">b2</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># we expect a_id to be None; takes precedence only in 1.0</span>

<span class="n">b1</span><span class="o">.</span><span class="n">a_id</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">b2</span><span class="o">.</span><span class="n">a_id</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">session</span><span class="o">.</span><span class="n">add_all</span><span class="p">([</span><span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">])</span>
<span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

<span class="k">assert</span> <span class="n">b1</span><span class="o">.</span><span class="n">a</span> <span class="ow">is</span> <span class="n">a1</span>  <span class="c1"># passes in both 0.9 and 1.0</span>
<span class="k">assert</span> <span class="n">b2</span><span class="o">.</span><span class="n">a</span> <span class="ow">is</span> <span class="kc">None</span>  <span class="c1"># passes in 1.0, in 0.9 it&#39;s a2</span></pre></div>
</div>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3060">#3060</a></p>
</div>
<div class="section" id="session-expunge-will-fully-detach-an-object-that-s-been-deleted">
<span id="bug-3139"></span><h3>session.expunge() will fully detach an object that’s been deleted<a class="headerlink" href="#session-expunge-will-fully-detach-an-object-that-s-been-deleted" title="Permalink to this headline">¶</a></h3>
<p>The behavior of <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.session.Session.expunge" title="sqlalchemy.orm.session.Session.expunge"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.expunge()</span></code></a> had a bug that caused an
inconsistency in behavior regarding deleted objects.  The
<a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.session.object_session" title="sqlalchemy.orm.session.object_session"><code class="xref py py-func docutils literal notranslate"><span class="pre">object_session()</span></code></a> function as well as the <a class="reference internal" href="../orm/internals.html#sqlalchemy.orm.state.InstanceState.session" title="sqlalchemy.orm.state.InstanceState.session"><code class="xref py py-attr docutils literal notranslate"><span class="pre">InstanceState.session</span></code></a>
attribute would still report object as belonging to the <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.session.Session" title="sqlalchemy.orm.session.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a>
subsequent to the expunge:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">u1</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<span class="n">sess</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">u1</span><span class="p">)</span>

<span class="n">sess</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

<span class="k">assert</span> <span class="n">u1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sess</span>
<span class="k">assert</span> <span class="n">inspect</span><span class="p">(</span><span class="n">u1</span><span class="p">)</span><span class="o">.</span><span class="n">session</span> <span class="ow">is</span> <span class="n">sess</span>  <span class="c1"># this is normal before commit</span>

<span class="n">sess</span><span class="o">.</span><span class="n">expunge</span><span class="p">(</span><span class="n">u1</span><span class="p">)</span>

<span class="k">assert</span> <span class="n">u1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sess</span>
<span class="k">assert</span> <span class="n">inspect</span><span class="p">(</span><span class="n">u1</span><span class="p">)</span><span class="o">.</span><span class="n">session</span> <span class="ow">is</span> <span class="kc">None</span>  <span class="c1"># would fail</span></pre></div>
</div>
<p>Note that it is normal for <code class="docutils literal notranslate"><span class="pre">u1</span> <span class="pre">not</span> <span class="pre">in</span> <span class="pre">sess</span></code> to be True while
<code class="docutils literal notranslate"><span class="pre">inspect(u1).session</span></code> still refers to the session, while the transaction
is ongoing subsequent to the delete operation and <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.session.Session.expunge" title="sqlalchemy.orm.session.Session.expunge"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.expunge()</span></code></a>
has not been called; the full detachment normally completes once the
transaction is committed.  This issue would also impact functions
that rely on <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.session.Session.expunge" title="sqlalchemy.orm.session.Session.expunge"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.expunge()</span></code></a> such as <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.session.make_transient" title="sqlalchemy.orm.session.make_transient"><code class="xref py py-func docutils literal notranslate"><span class="pre">make_transient()</span></code></a>.</p>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3139">#3139</a></p>
</div>
<div class="section" id="joined-subquery-eager-loading-explicitly-disallowed-with-yield-per">
<span id="migration-yield-per-eager-loading"></span><h3>Joined/Subquery eager loading explicitly disallowed with yield_per<a class="headerlink" href="#joined-subquery-eager-loading-explicitly-disallowed-with-yield-per" title="Permalink to this headline">¶</a></h3>
<p>In order to make the <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.query.Query.yield_per" title="sqlalchemy.orm.query.Query.yield_per"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.yield_per()</span></code></a> method easier to use,
an exception is raised if any subquery eager loaders, or joined
eager loaders that would use collections, are
to take effect when yield_per is used, as these are currently not compatible
with yield-per (subquery loading could be in theory, however).
When this error is raised, the <a class="reference internal" href="../orm/loading_relationships.html#sqlalchemy.orm.lazyload" title="sqlalchemy.orm.lazyload"><code class="xref py py-func docutils literal notranslate"><span class="pre">lazyload()</span></code></a> option can be sent with
an asterisk:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">q</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Object</span><span class="p">)</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">lazyload</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">yield_per</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span></pre></div>
</div>
<p>or use <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.query.Query.enable_eagerloads" title="sqlalchemy.orm.query.Query.enable_eagerloads"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.enable_eagerloads()</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">q</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Object</span><span class="p">)</span><span class="o">.</span><span class="n">enable_eagerloads</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">yield_per</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span></pre></div>
</div>
<p>The <a class="reference internal" href="../orm/loading_relationships.html#sqlalchemy.orm.lazyload" title="sqlalchemy.orm.lazyload"><code class="xref py py-func docutils literal notranslate"><span class="pre">lazyload()</span></code></a> option has the advantage that additional many-to-one
joined loader options can still be used:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">q</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Object</span><span class="p">)</span><span class="o">.</span><span class="n">options</span><span class="p">(</span>
    <span class="n">lazyload</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">),</span> <span class="n">joinedload</span><span class="p">(</span><span class="s2">&quot;some_manytoone&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">yield_per</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span></pre></div>
</div>
</div>
<div class="section" id="changes-and-fixes-in-handling-of-duplicate-join-targets">
<span id="bug-3233"></span><h3>Changes and fixes in handling of duplicate join targets<a class="headerlink" href="#changes-and-fixes-in-handling-of-duplicate-join-targets" title="Permalink to this headline">¶</a></h3>
<p>Changes here encompass bugs where an unexpected and inconsistent
behavior would occur in some scenarios when joining to an entity
twice, or to multiple single-table entities against the same table,
without using a relationship-based ON clause, as well as when joining
multiple times to the same target relationship.</p>
<p>Starting with a mapping as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">Column</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">ForeignKey</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="k">import</span> <span class="n">Session</span><span class="p">,</span> <span class="n">relationship</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.declarative</span> <span class="k">import</span> <span class="n">declarative_base</span>

<span class="n">Base</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">bs</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;B&quot;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">B</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">a_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;a.id&#39;</span><span class="p">))</span></pre></div>
</div>
<p>A query that joins to <code class="docutils literal notranslate"><span class="pre">A.bs</span></code> twice:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">bs</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">bs</span><span class="p">))</span></pre></div>
</div>
<p>Will render:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="n">a</span><span class="o">.</span><span class="n">id</span> <span class="n">AS</span> <span class="n">a_id</span>
<span class="n">FROM</span> <span class="n">a</span> <span class="n">JOIN</span> <span class="n">b</span> <span class="n">ON</span> <span class="n">a</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">a_id</span></pre></div>
</div>
<p>The query deduplicates the redundant <code class="docutils literal notranslate"><span class="pre">A.bs</span></code> because it is attempting
to support a case like the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">s</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">bs</span><span class="p">)</span><span class="o">.</span>\
    <span class="nb">filter</span><span class="p">(</span><span class="n">B</span><span class="o">.</span><span class="n">foo</span> <span class="o">==</span> <span class="s1">&#39;bar&#39;</span><span class="p">)</span><span class="o">.</span>\
    <span class="n">reset_joinpoint</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">bs</span><span class="p">,</span> <span class="n">B</span><span class="o">.</span><span class="n">cs</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">bar</span> <span class="o">==</span> <span class="s1">&#39;bat&#39;</span><span class="p">)</span></pre></div>
</div>
<p>That is, the <code class="docutils literal notranslate"><span class="pre">A.bs</span></code> is part of a “path”.  As part of <a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3367">#3367</a>,
arriving at the same endpoint twice without it being part of a
larger path will now emit a warning:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SAWarning</span><span class="p">:</span> <span class="n">Pathed</span> <span class="n">join</span> <span class="n">target</span> <span class="n">A</span><span class="o">.</span><span class="n">bs</span> <span class="n">has</span> <span class="n">already</span> <span class="n">been</span> <span class="n">joined</span> <span class="n">to</span><span class="p">;</span> <span class="n">skipping</span></pre></div>
</div>
<p>The bigger change involves when joining to an entity without using a
relationship-bound path.  If we join to <code class="docutils literal notranslate"><span class="pre">B</span></code> twice:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">B</span><span class="o">.</span><span class="n">a_id</span> <span class="o">==</span> <span class="n">A</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">B</span><span class="o">.</span><span class="n">a_id</span> <span class="o">==</span> <span class="n">A</span><span class="o">.</span><span class="n">id</span><span class="p">))</span></pre></div>
</div>
<p>In 0.9, this would render as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="n">a</span><span class="o">.</span><span class="n">id</span> <span class="n">AS</span> <span class="n">a_id</span>
<span class="n">FROM</span> <span class="n">a</span> <span class="n">JOIN</span> <span class="n">b</span> <span class="n">ON</span> <span class="n">b</span><span class="o">.</span><span class="n">a_id</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">id</span> <span class="n">JOIN</span> <span class="n">b</span> <span class="n">AS</span> <span class="n">b_1</span> <span class="n">ON</span> <span class="n">b_1</span><span class="o">.</span><span class="n">a_id</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">id</span></pre></div>
</div>
<p>This is problematic since the aliasing is implicit and in the case of different
ON clauses can lead to unpredictable results.</p>
<p>In 1.0, no automatic aliasing is applied and we get:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="n">a</span><span class="o">.</span><span class="n">id</span> <span class="n">AS</span> <span class="n">a_id</span>
<span class="n">FROM</span> <span class="n">a</span> <span class="n">JOIN</span> <span class="n">b</span> <span class="n">ON</span> <span class="n">b</span><span class="o">.</span><span class="n">a_id</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">id</span> <span class="n">JOIN</span> <span class="n">b</span> <span class="n">ON</span> <span class="n">b</span><span class="o">.</span><span class="n">a_id</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">id</span></pre></div>
</div>
<p>This will raise an error from the database.  While it might be nice if
the “duplicate join target” acted identically if we joined both from
redundant relationships vs. redundant non-relationship based targets,
for now we are only changing the behavior in the more serious case where
implicit aliasing would have occurred previously, and only emitting a warning
in the relationship case.  Ultimately, joining to the same thing twice without
any aliasing to disambiguate should raise an error in all cases.</p>
<p>The change also has an impact on single-table inheritance targets.  Using
a mapping as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">Column</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">ForeignKey</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="k">import</span> <span class="n">Session</span><span class="p">,</span> <span class="n">relationship</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.declarative</span> <span class="k">import</span> <span class="n">declarative_base</span>

<span class="n">Base</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>

    <span class="n">__mapper_args__</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;polymorphic_on&#39;</span><span class="p">:</span> <span class="nb">type</span><span class="p">,</span> <span class="s1">&#39;polymorphic_identity&#39;</span><span class="p">:</span> <span class="s1">&#39;a&#39;</span><span class="p">}</span>


<span class="k">class</span> <span class="nc">ASub1</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>
    <span class="n">__mapper_args__</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;polymorphic_identity&#39;</span><span class="p">:</span> <span class="s1">&#39;asub1&#39;</span><span class="p">}</span>


<span class="k">class</span> <span class="nc">ASub2</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>
    <span class="n">__mapper_args__</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;polymorphic_identity&#39;</span><span class="p">:</span> <span class="s1">&#39;asub2&#39;</span><span class="p">}</span>


<span class="k">class</span> <span class="nc">B</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">a_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;a.id&quot;</span><span class="p">))</span>

    <span class="n">a</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="n">primaryjoin</span><span class="o">=</span><span class="s2">&quot;B.a_id == A.id&quot;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">Session</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">ASub1</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">ASub1</span><span class="o">.</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ASub2</span><span class="p">,</span> <span class="n">B</span><span class="o">.</span><span class="n">a</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">ASub1</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">ASub1</span><span class="o">.</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ASub2</span><span class="p">,</span> <span class="n">ASub2</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">B</span><span class="o">.</span><span class="n">a_id</span><span class="p">))</span></pre></div>
</div>
<p>The two queries at the bottom are equivalent, and should both render
the identical SQL:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="n">a</span><span class="o">.</span><span class="n">id</span> <span class="n">AS</span> <span class="n">a_id</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">type</span> <span class="n">AS</span> <span class="n">a_type</span>
<span class="n">FROM</span> <span class="n">a</span> <span class="n">JOIN</span> <span class="n">b</span> <span class="n">ON</span> <span class="n">b</span><span class="o">.</span><span class="n">a_id</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">id</span> <span class="n">JOIN</span> <span class="n">a</span> <span class="n">ON</span> <span class="n">b</span><span class="o">.</span><span class="n">a_id</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">id</span> <span class="n">AND</span> <span class="n">a</span><span class="o">.</span><span class="n">type</span> <span class="n">IN</span> <span class="p">(:</span><span class="n">type_1</span><span class="p">)</span>
<span class="n">WHERE</span> <span class="n">a</span><span class="o">.</span><span class="n">type</span> <span class="n">IN</span> <span class="p">(:</span><span class="n">type_2</span><span class="p">)</span></pre></div>
</div>
<p>The above SQL is invalid, as it renders “a” within the FROM list twice.
However, the implicit aliasing bug would occur with the second query only
and render this instead:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="n">a</span><span class="o">.</span><span class="n">id</span> <span class="n">AS</span> <span class="n">a_id</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">type</span> <span class="n">AS</span> <span class="n">a_type</span>
<span class="n">FROM</span> <span class="n">a</span> <span class="n">JOIN</span> <span class="n">b</span> <span class="n">ON</span> <span class="n">b</span><span class="o">.</span><span class="n">a_id</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">id</span> <span class="n">JOIN</span> <span class="n">a</span> <span class="n">AS</span> <span class="n">a_1</span>
<span class="n">ON</span> <span class="n">a_1</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">a_id</span> <span class="n">AND</span> <span class="n">a_1</span><span class="o">.</span><span class="n">type</span> <span class="n">IN</span> <span class="p">(:</span><span class="n">type_1</span><span class="p">)</span>
<span class="n">WHERE</span> <span class="n">a_1</span><span class="o">.</span><span class="n">type</span> <span class="n">IN</span> <span class="p">(:</span><span class="n">type_2</span><span class="p">)</span></pre></div>
</div>
<p>Where above, the second join to “a” is aliased.  While this seems convenient,
it’s not how single-inheritance queries work in general and is misleading
and inconsistent.</p>
<p>The net effect is that applications which were relying on this bug will now
have an error raised by the database.   The solution is to use the expected
form.  When referring to multiple subclasses of a single-inheritance
entity in a query, you must manually use aliases to disambiguate the table,
as all the subclasses normally refer to the same table:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">asub2_alias</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">ASub2</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">ASub1</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">ASub1</span><span class="o">.</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">asub2_alias</span><span class="p">,</span> <span class="n">B</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">of_type</span><span class="p">(</span><span class="n">asub2_alias</span><span class="p">)))</span></pre></div>
</div>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3233">#3233</a>
<a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3367">#3367</a></p>
</div>
<div class="section" id="deferred-columns-no-longer-implicitly-undefer">
<h3>Deferred Columns No Longer Implicitly Undefer<a class="headerlink" href="#deferred-columns-no-longer-implicitly-undefer" title="Permalink to this headline">¶</a></h3>
<p>Mapped attributes marked as deferred without explicit undeferral
will now remain “deferred” even if their column is otherwise
present in the result set in some way.   This is a performance
enhancement in that an ORM load no longer spends time searching
for each deferred column when the result set is obtained.  However,
for an application that has been relying upon this, an explicit
<a class="reference internal" href="../orm/loading_columns.html#sqlalchemy.orm.undefer" title="sqlalchemy.orm.undefer"><code class="xref py py-func docutils literal notranslate"><span class="pre">undefer()</span></code></a> or similar option should now be used, in order
to prevent a SELECT from being emitted when the attribute is accessed.</p>
</div>
<div class="section" id="deprecated-orm-event-hooks-removed">
<span id="migration-deprecated-orm-events"></span><h3>Deprecated ORM Event Hooks Removed<a class="headerlink" href="#deprecated-orm-event-hooks-removed" title="Permalink to this headline">¶</a></h3>
<p>The following ORM event hooks, some of which have been deprecated since
0.5, have been removed:   <code class="docutils literal notranslate"><span class="pre">translate_row</span></code>, <code class="docutils literal notranslate"><span class="pre">populate_instance</span></code>,
<code class="docutils literal notranslate"><span class="pre">append_result</span></code>, <code class="docutils literal notranslate"><span class="pre">create_instance</span></code>.  The use cases for these hooks
originated in the very early 0.1 / 0.2 series of SQLAlchemy and have long
since been unnecessary.  In particular, the hooks were largely unusable
as the behavioral contracts within these events was strongly linked to
the surrounding internals, such as how an instance needs to be created
and initialized as well as how columns are located within an ORM-generated
row.   The removal of these hooks greatly simplifies the mechanics of ORM
object loading.</p>
</div>
<div class="section" id="api-change-for-new-bundle-feature-when-custom-row-loaders-are-used">
<span id="bundle-api-change"></span><h3>API Change for new Bundle feature when custom row loaders are used<a class="headerlink" href="#api-change-for-new-bundle-feature-when-custom-row-loaders-are-used" title="Permalink to this headline">¶</a></h3>
<p>The new <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.query.Bundle" title="sqlalchemy.orm.query.Bundle"><code class="xref py py-class docutils literal notranslate"><span class="pre">Bundle</span></code></a> object of 0.9 has a small change in API,
when the <code class="docutils literal notranslate"><span class="pre">create_row_processor()</span></code> method is overridden on a custom class.
Previously, the sample code looked like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="k">import</span> <span class="n">Bundle</span>

<span class="k">class</span> <span class="nc">DictBundle</span><span class="p">(</span><span class="n">Bundle</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">create_row_processor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">procs</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Override create_row_processor to return values as dictionaries&quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">proc</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
                        <span class="nb">zip</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="p">(</span><span class="n">proc</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span> <span class="k">for</span> <span class="n">proc</span> <span class="ow">in</span> <span class="n">procs</span><span class="p">))</span>
                    <span class="p">)</span>
        <span class="k">return</span> <span class="n">proc</span></pre></div>
</div>
<p>The unused <code class="docutils literal notranslate"><span class="pre">result</span></code> member is now removed:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="k">import</span> <span class="n">Bundle</span>

<span class="k">class</span> <span class="nc">DictBundle</span><span class="p">(</span><span class="n">Bundle</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">create_row_processor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">procs</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Override create_row_processor to return values as dictionaries&quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">proc</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
                        <span class="nb">zip</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="p">(</span><span class="n">proc</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">proc</span> <span class="ow">in</span> <span class="n">procs</span><span class="p">))</span>
                    <span class="p">)</span>
        <span class="k">return</span> <span class="n">proc</span></pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../orm/loading_columns.html#bundles"><span class="std std-ref">Column Bundles</span></a></p>
</div>
</div>
<div class="section" id="right-inner-join-nesting-now-the-default-for-joinedload-with-innerjoin-true">
<span id="migration-3008"></span><h3>Right inner join nesting now the default for joinedload with innerjoin=True<a class="headerlink" href="#right-inner-join-nesting-now-the-default-for-joinedload-with-innerjoin-true" title="Permalink to this headline">¶</a></h3>
<p>The behavior of <a class="reference internal" href="../orm/loading_relationships.html#sqlalchemy.orm.joinedload.params.innerjoin" title="sqlalchemy.orm.joinedload"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">joinedload.innerjoin</span></code></a> as well as
<a class="reference internal" href="../orm/relationship_api.html#sqlalchemy.orm.relationship.params.innerjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.innerjoin</span></code></a> is now to use “nested”
inner joins, that is, right-nested, as the default behavior when an
inner join joined eager load is chained to an outer join eager load.  In
order to get the old behavior of chaining all joined eager loads as
outer join when an outer join is present, use <code class="docutils literal notranslate"><span class="pre">innerjoin=&quot;unnested&quot;</span></code>.</p>
<p>As introduced in <a class="reference internal" href="migration_09.html#feature-2976"><span class="std std-ref">Right-nested inner joins available in joined eager loads</span></a> from version 0.9, the behavior of
<code class="docutils literal notranslate"><span class="pre">innerjoin=&quot;nested&quot;</span></code> is that an inner join eager load chained to an outer
join eager load will use a right-nested join.  <code class="docutils literal notranslate"><span class="pre">&quot;nested&quot;</span></code> is now implied
when using <code class="docutils literal notranslate"><span class="pre">innerjoin=True</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">options</span><span class="p">(</span>
    <span class="n">joinedload</span><span class="p">(</span><span class="s2">&quot;orders&quot;</span><span class="p">,</span> <span class="n">innerjoin</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">joinedload</span><span class="p">(</span><span class="s2">&quot;items&quot;</span><span class="p">,</span> <span class="n">innerjoin</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span></pre></div>
</div>
<p>With the new default, this will render the FROM clause in the form:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FROM</span> <span class="n">users</span> <span class="n">LEFT</span> <span class="n">OUTER</span> <span class="n">JOIN</span> <span class="p">(</span><span class="n">orders</span> <span class="n">JOIN</span> <span class="n">items</span> <span class="n">ON</span> <span class="o">&lt;</span><span class="n">onclause</span><span class="o">&gt;</span><span class="p">)</span> <span class="n">ON</span> <span class="o">&lt;</span><span class="n">onclause</span><span class="o">&gt;</span></pre></div>
</div>
<p>That is, using a right-nested join for the INNER join so that the full
result of <code class="docutils literal notranslate"><span class="pre">users</span></code> can be returned.   The use of an INNER join is more efficient
than using an OUTER join, and allows the <a class="reference internal" href="../orm/loading_relationships.html#sqlalchemy.orm.joinedload.params.innerjoin" title="sqlalchemy.orm.joinedload"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">joinedload.innerjoin</span></code></a>
optimization parameter to take effect in all cases.</p>
<p>To get the older behavior, use <code class="docutils literal notranslate"><span class="pre">innerjoin=&quot;unnested&quot;</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">options</span><span class="p">(</span>
    <span class="n">joinedload</span><span class="p">(</span><span class="s2">&quot;orders&quot;</span><span class="p">,</span> <span class="n">innerjoin</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">joinedload</span><span class="p">(</span><span class="s2">&quot;items&quot;</span><span class="p">,</span> <span class="n">innerjoin</span><span class="o">=</span><span class="s2">&quot;unnested&quot;</span><span class="p">))</span></pre></div>
</div>
<p>This will avoid right-nested joins and chain the joins together using all
OUTER joins despite the innerjoin directive:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FROM</span> <span class="n">users</span> <span class="n">LEFT</span> <span class="n">OUTER</span> <span class="n">JOIN</span> <span class="n">orders</span> <span class="n">ON</span> <span class="o">&lt;</span><span class="n">onclause</span><span class="o">&gt;</span> <span class="n">LEFT</span> <span class="n">OUTER</span> <span class="n">JOIN</span> <span class="n">items</span> <span class="n">ON</span> <span class="o">&lt;</span><span class="n">onclause</span><span class="o">&gt;</span></pre></div>
</div>
<p>As noted in the 0.9 notes, the only database backend that has difficulty
with right-nested joins is SQLite; SQLAlchemy as of 0.9 converts a right-nested
join into a subquery as a join target on SQLite.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="migration_09.html#feature-2976"><span class="std std-ref">Right-nested inner joins available in joined eager loads</span></a> - description of the feature as introduced in 0.9.4.</p>
</div>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3008">#3008</a></p>
</div>
<div class="section" id="subqueries-no-longer-applied-to-uselist-false-joined-eager-loads">
<span id="change-3249"></span><h3>Subqueries no longer applied to uselist=False joined eager loads<a class="headerlink" href="#subqueries-no-longer-applied-to-uselist-false-joined-eager-loads" title="Permalink to this headline">¶</a></h3>
<p>Given a joined eager load like the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="n">uselist</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">B</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">a_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;a.id&#39;</span><span class="p">))</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">Session</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">joinedload</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">b</span><span class="p">))</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span></pre></div>
</div>
<p>SQLAlchemy considers the relationship <code class="docutils literal notranslate"><span class="pre">A.b</span></code> to be a “one to many,
loaded as a single value”, which is essentially a “one to one”
relationship.  However, joined eager loading has always treated the
above as a situation where the main query needs to be inside a
subquery, as would normally be needed for a collection of B objects
where the main query has a LIMIT applied:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="n">anon_1</span><span class="o">.</span><span class="n">a_id</span> <span class="n">AS</span> <span class="n">anon_1_a_id</span><span class="p">,</span> <span class="n">b_1</span><span class="o">.</span><span class="n">id</span> <span class="n">AS</span> <span class="n">b_1_id</span><span class="p">,</span> <span class="n">b_1</span><span class="o">.</span><span class="n">a_id</span> <span class="n">AS</span> <span class="n">b_1_a_id</span>
<span class="n">FROM</span> <span class="p">(</span><span class="n">SELECT</span> <span class="n">a</span><span class="o">.</span><span class="n">id</span> <span class="n">AS</span> <span class="n">a_id</span>
<span class="n">FROM</span> <span class="n">a</span> <span class="n">LIMIT</span> <span class="p">:</span><span class="n">param_1</span><span class="p">)</span> <span class="n">AS</span> <span class="n">anon_1</span>
<span class="n">LEFT</span> <span class="n">OUTER</span> <span class="n">JOIN</span> <span class="n">b</span> <span class="n">AS</span> <span class="n">b_1</span> <span class="n">ON</span> <span class="n">anon_1</span><span class="o">.</span><span class="n">a_id</span> <span class="o">=</span> <span class="n">b_1</span><span class="o">.</span><span class="n">a_id</span></pre></div>
</div>
<p>However, since the relationship of the inner query to the outer one is
that at most only one row is shared in the case of <code class="docutils literal notranslate"><span class="pre">uselist=False</span></code>
(in the same way as a many-to-one), the “subquery” used with LIMIT +
joined eager loading is now dropped in this case:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="n">a</span><span class="o">.</span><span class="n">id</span> <span class="n">AS</span> <span class="n">a_id</span><span class="p">,</span> <span class="n">b_1</span><span class="o">.</span><span class="n">id</span> <span class="n">AS</span> <span class="n">b_1_id</span><span class="p">,</span> <span class="n">b_1</span><span class="o">.</span><span class="n">a_id</span> <span class="n">AS</span> <span class="n">b_1_a_id</span>
<span class="n">FROM</span> <span class="n">a</span> <span class="n">LEFT</span> <span class="n">OUTER</span> <span class="n">JOIN</span> <span class="n">b</span> <span class="n">AS</span> <span class="n">b_1</span> <span class="n">ON</span> <span class="n">a</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">b_1</span><span class="o">.</span><span class="n">a_id</span>
<span class="n">LIMIT</span> <span class="p">:</span><span class="n">param_1</span></pre></div>
</div>
<p>In the case that the LEFT OUTER JOIN returns more than one row, the ORM
has always emitted a warning here and ignored additional results for
<code class="docutils literal notranslate"><span class="pre">uselist=False</span></code>, so the results in that error situation should not change.</p>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3249">#3249</a></p>
</div>
<div class="section" id="query-update-query-delete-raises-if-used-with-join-select-from-from-self">
<h3>query.update() / query.delete() raises if used with join(), select_from(), from_self()<a class="headerlink" href="#query-update-query-delete-raises-if-used-with-join-select-from-from-self" title="Permalink to this headline">¶</a></h3>
<p>A warning is emitted in SQLAlchemy 0.9.10 (not yet released as of
June 9, 2015) when the <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.query.Query.update" title="sqlalchemy.orm.query.Query.update"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.update()</span></code></a> or <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.query.Query.delete" title="sqlalchemy.orm.query.Query.delete"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.delete()</span></code></a> methods
are invoked against a query which has also called upon <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.query.Query.join" title="sqlalchemy.orm.query.Query.join"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.join()</span></code></a>,
<a class="reference internal" href="../orm/query.html#sqlalchemy.orm.query.Query.outerjoin" title="sqlalchemy.orm.query.Query.outerjoin"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.outerjoin()</span></code></a>,
<a class="reference internal" href="../orm/query.html#sqlalchemy.orm.query.Query.select_from" title="sqlalchemy.orm.query.Query.select_from"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.select_from()</span></code></a> or <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.query.Query.from_self" title="sqlalchemy.orm.query.Query.from_self"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.from_self()</span></code></a>.  These are unsupported
use cases which silently fail in the 0.9 series up until 0.9.10 where it emits
a warning.  In 1.0, these cases raise an exception.</p>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3349">#3349</a></p>
</div>
<div class="section" id="query-update-with-synchronize-session-evaluate-raises-on-multi-table-update">
<h3>query.update() with <code class="docutils literal notranslate"><span class="pre">synchronize_session='evaluate'</span></code> raises on multi-table update<a class="headerlink" href="#query-update-with-synchronize-session-evaluate-raises-on-multi-table-update" title="Permalink to this headline">¶</a></h3>
<p>The “evaluator” for <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.query.Query.update" title="sqlalchemy.orm.query.Query.update"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.update()</span></code></a> won’t work with multi-table
updates, and needs to be set to <code class="docutils literal notranslate"><span class="pre">synchronize_session=False</span></code> or
<code class="docutils literal notranslate"><span class="pre">synchronize_session='fetch'</span></code> when multiple tables are present.
The new behavior is that an explicit exception is now raised, with a message
to change the synchronize setting.
This is upgraded from a warning emitted as of 0.9.7.</p>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3117">#3117</a></p>
</div>
<div class="section" id="resurrect-event-has-been-removed">
<h3>Resurrect Event has been Removed<a class="headerlink" href="#resurrect-event-has-been-removed" title="Permalink to this headline">¶</a></h3>
<p>The “resurrect” ORM event has been removed entirely.  This event ceased to
have any function since version 0.8 removed the older “mutable” system
from the unit of work.</p>
</div>
<div class="section" id="change-to-single-table-inheritance-criteria-when-using-from-self-count">
<span id="migration-3177"></span><h3>Change to single-table-inheritance criteria when using from_self(), count()<a class="headerlink" href="#change-to-single-table-inheritance-criteria-when-using-from-self-count" title="Permalink to this headline">¶</a></h3>
<p>Given a single-table inheritance mapping, such as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Widget</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__table__</span> <span class="o">=</span> <span class="s1">&#39;widget_table&#39;</span>

<span class="k">class</span> <span class="nc">FooWidget</span><span class="p">(</span><span class="n">Widget</span><span class="p">):</span>
    <span class="k">pass</span></pre></div>
</div>
<p>Using <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.query.Query.from_self" title="sqlalchemy.orm.query.Query.from_self"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.from_self()</span></code></a> or <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.query.Query.count" title="sqlalchemy.orm.query.Query.count"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.count()</span></code></a> against a subclass
would produce a subquery, but then add the “WHERE” criteria for subtypes
to the outside:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sess</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">FooWidget</span><span class="p">)</span><span class="o">.</span><span class="n">from_self</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span></pre></div>
</div>
<p>rendering:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>SELECT
    anon_1.widgets_id AS anon_1_widgets_id,
    anon_1.widgets_type AS anon_1_widgets_type
FROM (SELECT widgets.id AS widgets_id, widgets.type AS widgets_type,
FROM widgets) AS anon_1
WHERE anon_1.widgets_type IN (?)</pre></div>
</div>
<p>The issue with this is that if the inner query does not specify all
columns, then we can’t add the WHERE clause on the outside (it actually tries,
and produces a bad query).  This decision
apparently goes way back to 0.6.5 with the note “may need to make more
adjustments to this”.   Well, those adjustments have arrived!  So now the
above query will render:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>SELECT
    anon_1.widgets_id AS anon_1_widgets_id,
    anon_1.widgets_type AS anon_1_widgets_type
FROM (SELECT widgets.id AS widgets_id, widgets.type AS widgets_type,
FROM widgets
WHERE widgets.type IN (?)) AS anon_1</pre></div>
</div>
<p>So that queries that don’t include “type” will still work!:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sess</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">FooWidget</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span></pre></div>
</div>
<p>Renders:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>SELECT count(*) AS count_1
FROM (SELECT widgets.id AS widgets_id
FROM widgets
WHERE widgets.type IN (?)) AS anon_1</pre></div>
</div>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3177">#3177</a></p>
</div>
<div class="section" id="single-table-inheritance-criteria-added-to-all-on-clauses-unconditionally">
<span id="migration-3222"></span><h3>single-table-inheritance criteria added to all ON clauses unconditionally<a class="headerlink" href="#single-table-inheritance-criteria-added-to-all-on-clauses-unconditionally" title="Permalink to this headline">¶</a></h3>
<p>When joining to a single-table inheritance subclass target, the ORM always adds
the “single table criteria” when joining on a relationship.  Given a
mapping as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Widget</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;widget&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>
    <span class="n">related_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;related.id&#39;</span><span class="p">))</span>
    <span class="n">related</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Related&quot;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;widget&quot;</span><span class="p">)</span>
    <span class="n">__mapper_args__</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;polymorphic_on&#39;</span><span class="p">:</span> <span class="nb">type</span><span class="p">}</span>


<span class="k">class</span> <span class="nc">FooWidget</span><span class="p">(</span><span class="n">Widget</span><span class="p">):</span>
    <span class="n">__mapper_args__</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;polymorphic_identity&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">}</span>


<span class="k">class</span> <span class="nc">Related</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;related&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></pre></div>
</div>
<p>It’s been the behavior for quite some time that a JOIN on the relationship
will render a “single inheritance” clause for the type:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">s</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Related</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">FooWidget</span><span class="p">,</span> <span class="n">Related</span><span class="o">.</span><span class="n">widget</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span></pre></div>
</div>
<p>SQL output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="n">related</span><span class="o">.</span><span class="n">id</span> <span class="n">AS</span> <span class="n">related_id</span>
<span class="n">FROM</span> <span class="n">related</span> <span class="n">JOIN</span> <span class="n">widget</span> <span class="n">ON</span> <span class="n">related</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">widget</span><span class="o">.</span><span class="n">related_id</span> <span class="n">AND</span> <span class="n">widget</span><span class="o">.</span><span class="n">type</span> <span class="n">IN</span> <span class="p">(:</span><span class="n">type_1</span><span class="p">)</span></pre></div>
</div>
<p>Above, because we joined to a subclass <code class="docutils literal notranslate"><span class="pre">FooWidget</span></code>, <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.query.Query.join" title="sqlalchemy.orm.query.Query.join"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.join()</span></code></a>
knew to add the <code class="docutils literal notranslate"><span class="pre">AND</span> <span class="pre">widget.type</span> <span class="pre">IN</span> <span class="pre">('foo')</span></code> criteria to the ON clause.</p>
<p>The change here is that the <code class="docutils literal notranslate"><span class="pre">AND</span> <span class="pre">widget.type</span> <span class="pre">IN()</span></code> criteria is now appended
to <em>any</em> ON clause, not just those generated from a relationship,
including one that is explicitly stated:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># ON clause will now render as</span>
<span class="c1"># related.id = widget.related_id AND widget.type IN (:type_1)</span>
<span class="n">s</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Related</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">FooWidget</span><span class="p">,</span> <span class="n">FooWidget</span><span class="o">.</span><span class="n">related_id</span> <span class="o">==</span> <span class="n">Related</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span></pre></div>
</div>
<p>As well as the “implicit” join when no ON clause of any kind is stated:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># ON clause will now render as</span>
<span class="c1"># related.id = widget.related_id AND widget.type IN (:type_1)</span>
<span class="n">s</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Related</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">FooWidget</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span></pre></div>
</div>
<p>Previously, the ON clause for these would not include the single-inheritance
criteria.  Applications that are already adding this criteria to work around
this will want to remove its explicit use, though it should continue to work
fine if the criteria happens to be rendered twice in the meantime.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="#bug-3233"><span class="std std-ref">Changes and fixes in handling of duplicate join targets</span></a></p>
</div>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3222">#3222</a></p>
</div>
</div>
<div class="section" id="key-behavioral-changes-core">
<h2>Key Behavioral Changes - Core<a class="headerlink" href="#key-behavioral-changes-core" title="Permalink to this headline">¶</a></h2>
<div class="section" id="warnings-emitted-when-coercing-full-sql-fragments-into-text">
<span id="migration-2992"></span><h3>Warnings emitted when coercing full SQL fragments into text()<a class="headerlink" href="#warnings-emitted-when-coercing-full-sql-fragments-into-text" title="Permalink to this headline">¶</a></h3>
<p>Since SQLAlchemy’s inception, there has always been an emphasis on not getting
in the way of the usage of plain text.   The Core and ORM expression systems
were intended to allow any number of points at which the user can just
use plain text SQL expressions, not just in the sense that you can send a
full SQL string to <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Connection.execute" title="sqlalchemy.engine.Connection.execute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Connection.execute()</span></code></a>, but that you can send strings
with SQL expressions into many functions, such as <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select.where" title="sqlalchemy.sql.expression.Select.where"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.where()</span></code></a>,
<a class="reference internal" href="../orm/query.html#sqlalchemy.orm.query.Query.filter" title="sqlalchemy.orm.query.Query.filter"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.filter()</span></code></a>, and <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select.order_by" title="sqlalchemy.sql.expression.Select.order_by"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.order_by()</span></code></a>.</p>
<p>Note that by “SQL expressions” we mean a <strong>full fragment of a SQL string</strong>,
such as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># the argument sent to where() is a full SQL expression</span>
<span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">sometable</span><span class="p">])</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;somecolumn = &#39;value&#39;&quot;</span><span class="p">)</span></pre></div>
</div>
<p>and we are <strong>not talking about string arguments</strong>, that is, the normal
behavior of passing string values that become parameterized:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># This is a normal Core expression with a string argument -</span>
<span class="c1"># we aren&#39;t talking about this!!</span>
<span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">sometable</span><span class="p">])</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sometable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">somecolumn</span> <span class="o">==</span> <span class="s1">&#39;value&#39;</span><span class="p">)</span></pre></div>
</div>
<p>The Core tutorial has long featured an example of the use of this technique,
using a <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><code class="xref py py-func docutils literal notranslate"><span class="pre">select()</span></code></a> construct where virtually all components of it
are specified as straight strings.  However, despite this long-standing
behavior and example, users are apparently surprised that this behavior
exists, and when asking around the community, I was unable to find any user
that was in fact <em>not</em> surprised that you can send a full string into a method
like <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.query.Query.filter" title="sqlalchemy.orm.query.Query.filter"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.filter()</span></code></a>.</p>
<p>So the change here is to encourage the user to qualify textual strings when
composing SQL that is partially or fully composed from textual fragments.
When composing a select as below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;a = b&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">select_from</span><span class="p">(</span><span class="s2">&quot;sometable&quot;</span><span class="p">)</span></pre></div>
</div>
<p>The statement is built up normally, with all the same coercions as before.
However, one will see the following warnings emitted:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SAWarning</span><span class="p">:</span> <span class="n">Textual</span> <span class="n">column</span> <span class="n">expression</span> <span class="s1">&#39;a&#39;</span> <span class="n">should</span> <span class="n">be</span> <span class="n">explicitly</span> <span class="n">declared</span>
<span class="k">with</span> <span class="n">text</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">),</span> <span class="ow">or</span> <span class="n">use</span> <span class="n">column</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">more</span> <span class="n">specificity</span>
<span class="p">(</span><span class="n">this</span> <span class="n">warning</span> <span class="n">may</span> <span class="n">be</span> <span class="n">suppressed</span> <span class="n">after</span> <span class="mi">10</span> <span class="n">occurrences</span><span class="p">)</span>

<span class="n">SAWarning</span><span class="p">:</span> <span class="n">Textual</span> <span class="n">column</span> <span class="n">expression</span> <span class="s1">&#39;b&#39;</span> <span class="n">should</span> <span class="n">be</span> <span class="n">explicitly</span> <span class="n">declared</span>
<span class="k">with</span> <span class="n">text</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">),</span> <span class="ow">or</span> <span class="n">use</span> <span class="n">column</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">more</span> <span class="n">specificity</span>
<span class="p">(</span><span class="n">this</span> <span class="n">warning</span> <span class="n">may</span> <span class="n">be</span> <span class="n">suppressed</span> <span class="n">after</span> <span class="mi">10</span> <span class="n">occurrences</span><span class="p">)</span>

<span class="n">SAWarning</span><span class="p">:</span> <span class="n">Textual</span> <span class="n">SQL</span> <span class="n">expression</span> <span class="s1">&#39;a = b&#39;</span> <span class="n">should</span> <span class="n">be</span> <span class="n">explicitly</span> <span class="n">declared</span>
<span class="k">as</span> <span class="n">text</span><span class="p">(</span><span class="s1">&#39;a = b&#39;</span><span class="p">)</span> <span class="p">(</span><span class="n">this</span> <span class="n">warning</span> <span class="n">may</span> <span class="n">be</span> <span class="n">suppressed</span> <span class="n">after</span> <span class="mi">10</span> <span class="n">occurrences</span><span class="p">)</span>

<span class="n">SAWarning</span><span class="p">:</span> <span class="n">Textual</span> <span class="n">SQL</span> <span class="n">FROM</span> <span class="n">expression</span> <span class="s1">&#39;sometable&#39;</span> <span class="n">should</span> <span class="n">be</span> <span class="n">explicitly</span>
<span class="n">declared</span> <span class="k">as</span> <span class="n">text</span><span class="p">(</span><span class="s1">&#39;sometable&#39;</span><span class="p">),</span> <span class="ow">or</span> <span class="n">use</span> <span class="n">table</span><span class="p">(</span><span class="s1">&#39;sometable&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">more</span>
<span class="n">specificity</span> <span class="p">(</span><span class="n">this</span> <span class="n">warning</span> <span class="n">may</span> <span class="n">be</span> <span class="n">suppressed</span> <span class="n">after</span> <span class="mi">10</span> <span class="n">occurrences</span><span class="p">)</span></pre></div>
</div>
<p>These warnings attempt to show exactly where the issue is by displaying
the parameters as well as where the string was received.
The warnings make use of the <a class="reference internal" href="#feature-3178"><span class="std std-ref">Session.get_bind() handles a wider variety of inheritance scenarios</span></a> so that parameterized warnings
can be emitted safely without running out of memory, and as always, if
one wishes the warnings to be exceptions, the
<a class="reference external" href="https://docs.python.org/2/library/warnings.html">Python Warnings Filter</a>
should be used:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>   <span class="c1"># all warnings raise an exception</span></pre></div>
</div>
<p>Given the above warnings, our statement works just fine, but
to get rid of the warnings we would rewrite our statement as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="n">select</span><span class="p">,</span> <span class="n">text</span>
<span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span>
        <span class="n">text</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">),</span>
        <span class="n">text</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">)</span>
    <span class="p">])</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;a = b&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">select_from</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;sometable&quot;</span><span class="p">))</span></pre></div>
</div>
<p>and as the warnings suggest, we can give our statement more specificity
about the text if we use <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.column" title="sqlalchemy.sql.expression.column"><code class="xref py py-func docutils literal notranslate"><span class="pre">column()</span></code></a> and <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.table" title="sqlalchemy.sql.expression.table"><code class="xref py py-func docutils literal notranslate"><span class="pre">table()</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="n">select</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">table</span>

<span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">column</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">),</span> <span class="n">column</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">)])</span><span class="o">.</span>\
    <span class="n">where</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;a = b&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">select_from</span><span class="p">(</span><span class="n">table</span><span class="p">(</span><span class="s2">&quot;sometable&quot;</span><span class="p">))</span></pre></div>
</div>
<p>Where note also that <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.table" title="sqlalchemy.sql.expression.table"><code class="xref py py-func docutils literal notranslate"><span class="pre">table()</span></code></a> and <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.column" title="sqlalchemy.sql.expression.column"><code class="xref py py-func docutils literal notranslate"><span class="pre">column()</span></code></a> can now
be imported from “sqlalchemy” without the “sql” part.</p>
<p>The behavior here applies to <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><code class="xref py py-func docutils literal notranslate"><span class="pre">select()</span></code></a> as well as to key methods
on <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.query.Query" title="sqlalchemy.orm.query.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a>, including <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.query.Query.filter" title="sqlalchemy.orm.query.Query.filter"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.filter()</span></code></a>,
<a class="reference internal" href="../orm/query.html#sqlalchemy.orm.query.Query.from_statement" title="sqlalchemy.orm.query.Query.from_statement"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.from_statement()</span></code></a> and <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.query.Query.having" title="sqlalchemy.orm.query.Query.having"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.having()</span></code></a>.</p>
<div class="section" id="order-by-and-group-by-are-special-cases">
<h4>ORDER BY and GROUP BY are special cases<a class="headerlink" href="#order-by-and-group-by-are-special-cases" title="Permalink to this headline">¶</a></h4>
<p>There is one case where usage of a string has special meaning, and as part
of this change we have enhanced its functionality.  When we have a
<a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><code class="xref py py-func docutils literal notranslate"><span class="pre">select()</span></code></a> or <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.query.Query" title="sqlalchemy.orm.query.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a> that refers to some column name or named
label, we might want to GROUP BY and/or ORDER BY known columns or labels:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span>
    <span class="n">user</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
    <span class="n">func</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;id_count&quot;</span><span class="p">)</span>
<span class="p">])</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;id_count&quot;</span><span class="p">)</span></pre></div>
</div>
<p>In the above statement we expect to see “ORDER BY id_count”, as opposed to a
re-statement of the function.   The string argument given is actively
matched to an entry in the columns clause during compilation, so the above
statement would produce as we expect, without warnings (though note that
the <code class="docutils literal notranslate"><span class="pre">&quot;name&quot;</span></code> expression has been resolved to <code class="docutils literal notranslate"><span class="pre">users.name</span></code>!):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="n">users</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">count</span><span class="p">(</span><span class="n">users</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="n">AS</span> <span class="n">id_count</span>
<span class="n">FROM</span> <span class="n">users</span> <span class="n">GROUP</span> <span class="n">BY</span> <span class="n">users</span><span class="o">.</span><span class="n">name</span> <span class="n">ORDER</span> <span class="n">BY</span> <span class="n">id_count</span></pre></div>
</div>
<p>However, if we refer to a name that cannot be located, then we get
the warning again, as below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span>
        <span class="n">user</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="n">func</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;id_count&quot;</span><span class="p">)</span>
    <span class="p">])</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;some_label&quot;</span><span class="p">)</span></pre></div>
</div>
<p>The output does what we say, but again it warns us:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SAWarning</span><span class="p">:</span> <span class="n">Can</span><span class="s1">&#39;t resolve label reference &#39;</span><span class="n">some_label</span><span class="s1">&#39;; converting to</span>
<span class="n">text</span><span class="p">()</span> <span class="p">(</span><span class="n">this</span> <span class="n">warning</span> <span class="n">may</span> <span class="n">be</span> <span class="n">suppressed</span> <span class="n">after</span> <span class="mi">10</span> <span class="n">occurrences</span><span class="p">)</span>

<span class="n">SELECT</span> <span class="n">users</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">count</span><span class="p">(</span><span class="n">users</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="n">AS</span> <span class="n">id_count</span>
<span class="n">FROM</span> <span class="n">users</span> <span class="n">ORDER</span> <span class="n">BY</span> <span class="n">some_label</span></pre></div>
</div>
<p>The above behavior applies to all those places where we might want to refer
to a so-called “label reference”; ORDER BY and GROUP BY, but also within an
OVER clause as well as a DISTINCT ON clause that refers to columns (e.g. the
PostgreSQL syntax).</p>
<p>We can still specify any arbitrary expression for ORDER BY or others using
<a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.text" title="sqlalchemy.sql.expression.text"><code class="xref py py-func docutils literal notranslate"><span class="pre">text()</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">users</span><span class="p">])</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;some special expression&quot;</span><span class="p">))</span></pre></div>
</div>
<p>The upshot of the whole change is that SQLAlchemy now would like us
to tell it when a string is sent that this string is explicitly
a <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.text" title="sqlalchemy.sql.expression.text"><code class="xref py py-func docutils literal notranslate"><span class="pre">text()</span></code></a> construct, or a column, table, etc., and if we use it as a
label name in an order by, group by, or other expression, SQLAlchemy expects
that the string resolves to something known, else it should again
be qualified with <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.text" title="sqlalchemy.sql.expression.text"><code class="xref py py-func docutils literal notranslate"><span class="pre">text()</span></code></a> or similar.</p>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/2992">#2992</a></p>
</div>
</div>
<div class="section" id="python-side-defaults-invoked-for-each-row-individually-when-using-a-multivalued-insert">
<span id="bug-3288"></span><h3>Python-side defaults invoked for each row individually when using a multivalued insert<a class="headerlink" href="#python-side-defaults-invoked-for-each-row-individually-when-using-a-multivalued-insert" title="Permalink to this headline">¶</a></h3>
<p>Support for Python-side column defaults when using the multi-valued
version of <a class="reference internal" href="../core/dml.html#sqlalchemy.sql.expression.Insert.values" title="sqlalchemy.sql.expression.Insert.values"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Insert.values()</span></code></a> were essentially not implemented, and
would only work “by accident” in specific situations, when the dialect in
use was using a non-positional (e.g. named) style of bound parameter, and
when it was not necessary that a Python-side callable be invoked for each
row.</p>
<p>The feature has been overhauled so that it works more similarly to
that of an “executemany” style of invocation:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">itertools</span>

<span class="n">counter</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
    <span class="s1">&#39;my_table&#39;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="nb">next</span><span class="p">(</span><span class="n">counter</span><span class="p">)),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">String</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">([</span>
    <span class="p">{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;d1&quot;</span><span class="p">},</span>
    <span class="p">{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;d2&quot;</span><span class="p">},</span>
    <span class="p">{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;d3&quot;</span><span class="p">},</span>
<span class="p">]))</span></pre></div>
</div>
<p>The above example will invoke <code class="docutils literal notranslate"><span class="pre">next(counter)</span></code> for each row individually
as would be expected:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>INSERT INTO my_table (id, data) VALUES (?, ?), (?, ?), (?, ?)
(1, &#39;d1&#39;, 2, &#39;d2&#39;, 3, &#39;d3&#39;)</pre></div>
</div>
<p>Previously, a positional dialect would fail as a bind would not be generated
for additional positions:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Incorrect</span> <span class="n">number</span> <span class="n">of</span> <span class="n">bindings</span> <span class="n">supplied</span><span class="o">.</span> <span class="n">The</span> <span class="n">current</span> <span class="n">statement</span> <span class="n">uses</span> <span class="mi">6</span><span class="p">,</span>
<span class="ow">and</span> <span class="n">there</span> <span class="n">are</span> <span class="mi">4</span> <span class="n">supplied</span><span class="o">.</span>
<span class="p">[</span><span class="n">SQL</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;INSERT INTO my_table (id, data) VALUES (?, ?), (?, ?), (?, ?)&#39;</span><span class="p">]</span>
<span class="p">[</span><span class="n">parameters</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;d1&#39;</span><span class="p">,</span> <span class="s1">&#39;d2&#39;</span><span class="p">,</span> <span class="s1">&#39;d3&#39;</span><span class="p">)]</span></pre></div>
</div>
<p>And with a “named” dialect, the same value for “id” would be re-used in
each row (hence this change is backwards-incompatible with a system that
relied on this):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">INSERT</span> <span class="n">INTO</span> <span class="n">my_table</span> <span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="n">VALUES</span> <span class="p">(:</span><span class="nb">id</span><span class="p">,</span> <span class="p">:</span><span class="n">data_0</span><span class="p">),</span> <span class="p">(:</span><span class="nb">id</span><span class="p">,</span> <span class="p">:</span><span class="n">data_1</span><span class="p">),</span> <span class="p">(:</span><span class="nb">id</span><span class="p">,</span> <span class="p">:</span><span class="n">data_2</span><span class="p">)</span>
<span class="p">{</span><span class="sa">u</span><span class="s1">&#39;data_2&#39;</span><span class="p">:</span> <span class="s1">&#39;d3&#39;</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;data_1&#39;</span><span class="p">:</span> <span class="s1">&#39;d2&#39;</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;data_0&#39;</span><span class="p">:</span> <span class="s1">&#39;d1&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span></pre></div>
</div>
<p>The system will also refuse to invoke a “server side” default as inline-rendered
SQL, since it cannot be guaranteed that a server side default is compatible
with this.  If the VALUES clause renders for a specific column, then a Python-side
value is required; if an omitted value only refers to a server-side default,
an exception is raised:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">t</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
    <span class="s1">&#39;my_table&#39;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">server_default</span><span class="o">=</span><span class="s1">&#39;some default&#39;</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">([</span>
    <span class="p">{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;d1&quot;</span><span class="p">},</span>
    <span class="p">{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;d2&quot;</span><span class="p">},</span>
    <span class="p">{},</span>
<span class="p">]))</span></pre></div>
</div>
<p>will raise:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sqlalchemy</span><span class="o">.</span><span class="n">exc</span><span class="o">.</span><span class="n">CompileError</span><span class="p">:</span> <span class="n">INSERT</span> <span class="n">value</span> <span class="k">for</span> <span class="n">column</span> <span class="n">my_table</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span>
<span class="n">explicitly</span> <span class="n">rendered</span> <span class="k">as</span> <span class="n">a</span> <span class="n">boundparameter</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">VALUES</span> <span class="n">clause</span><span class="p">;</span> <span class="n">a</span>
<span class="n">Python</span><span class="o">-</span><span class="n">side</span> <span class="n">value</span> <span class="ow">or</span> <span class="n">SQL</span> <span class="n">expression</span> <span class="ow">is</span> <span class="n">required</span></pre></div>
</div>
<p>Previously, the value “d1” would be copied into that of the third
row (but again, only with named format!):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">INSERT</span> <span class="n">INTO</span> <span class="n">my_table</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="n">VALUES</span> <span class="p">(:</span><span class="n">data_0</span><span class="p">),</span> <span class="p">(:</span><span class="n">data_1</span><span class="p">),</span> <span class="p">(:</span><span class="n">data_0</span><span class="p">)</span>
<span class="p">{</span><span class="sa">u</span><span class="s1">&#39;data_1&#39;</span><span class="p">:</span> <span class="s1">&#39;d2&#39;</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;data_0&#39;</span><span class="p">:</span> <span class="s1">&#39;d1&#39;</span><span class="p">}</span></pre></div>
</div>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3288">#3288</a></p>
</div>
<div class="section" id="event-listeners-can-not-be-added-or-removed-from-within-that-event-s-runner">
<span id="change-3163"></span><h3>Event listeners can not be added or removed from within that event’s runner<a class="headerlink" href="#event-listeners-can-not-be-added-or-removed-from-within-that-event-s-runner" title="Permalink to this headline">¶</a></h3>
<p>Removal of an event listener from inside that same event itself would
modify  the elements of a list during iteration, which would cause
still-attached event listeners to silently fail to fire.    To prevent
this while still maintaining performance, the lists have been replaced
with <code class="docutils literal notranslate"><span class="pre">collections.deque()</span></code>, which does not allow any additions or
removals during iteration, and instead raises <code class="docutils literal notranslate"><span class="pre">RuntimeError</span></code>.</p>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3163">#3163</a></p>
</div>
<div class="section" id="the-insert-from-select-construct-now-implies-inline-true">
<span id="change-3169"></span><h3>The INSERT…FROM SELECT construct now implies <code class="docutils literal notranslate"><span class="pre">inline=True</span></code><a class="headerlink" href="#the-insert-from-select-construct-now-implies-inline-true" title="Permalink to this headline">¶</a></h3>
<p>Using <a class="reference internal" href="../core/dml.html#sqlalchemy.sql.expression.Insert.from_select" title="sqlalchemy.sql.expression.Insert.from_select"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Insert.from_select()</span></code></a> now implies <code class="docutils literal notranslate"><span class="pre">inline=True</span></code>
on <a class="reference internal" href="../core/dml.html#sqlalchemy.sql.expression.insert" title="sqlalchemy.sql.expression.insert"><code class="xref py py-func docutils literal notranslate"><span class="pre">insert()</span></code></a>.  This helps to fix a bug where an
INSERT…FROM SELECT construct would inadvertently be compiled
as “implicit returning” on supporting backends, which would
cause breakage in the case of an INSERT that inserts zero rows
(as implicit returning expects a row), as well as arbitrary
return data in the case of an INSERT that inserts multiple
rows (e.g. only the first row of many).
A similar change is also applied to an INSERT..VALUES
with multiple parameter sets; implicit RETURNING will no longer emit
for this statement either.  As both of these constructs deal
with variable numbers of rows, the
<a class="reference internal" href="../core/connections.html#sqlalchemy.engine.ResultProxy.inserted_primary_key" title="sqlalchemy.engine.ResultProxy.inserted_primary_key"><code class="xref py py-attr docutils literal notranslate"><span class="pre">ResultProxy.inserted_primary_key</span></code></a> accessor does not
apply.   Previously, there was a documentation note that one
may prefer <code class="docutils literal notranslate"><span class="pre">inline=True</span></code> with INSERT..FROM SELECT as some databases
don’t support returning and therefore can’t do “implicit” returning,
but there’s no reason an INSERT…FROM SELECT needs implicit returning
in any case.   Regular explicit <a class="reference internal" href="../core/dml.html#sqlalchemy.sql.expression.Insert.returning" title="sqlalchemy.sql.expression.Insert.returning"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Insert.returning()</span></code></a> should
be used to return variable numbers of result rows if inserted
data is needed.</p>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3169">#3169</a></p>
</div>
<div class="section" id="autoload-with-now-implies-autoload-true">
<span id="change-3027"></span><h3><code class="docutils literal notranslate"><span class="pre">autoload_with</span></code> now implies <code class="docutils literal notranslate"><span class="pre">autoload=True</span></code><a class="headerlink" href="#autoload-with-now-implies-autoload-true" title="Permalink to this headline">¶</a></h3>
<p>A <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> can be set up for reflection by passing
<a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table.params.autoload_with" title="sqlalchemy.schema.Table"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Table.autoload_with</span></code></a> alone:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">my_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;my_table&#39;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">autoload_with</span><span class="o">=</span><span class="n">some_engine</span><span class="p">)</span></pre></div>
</div>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3027">#3027</a></p>
</div>
<div class="section" id="dbapi-exception-wrapping-and-handle-error-event-improvements">
<span id="change-3266"></span><h3>DBAPI exception wrapping and handle_error() event improvements<a class="headerlink" href="#dbapi-exception-wrapping-and-handle-error-event-improvements" title="Permalink to this headline">¶</a></h3>
<p>SQLAlchemy’s wrapping of DBAPI exceptions was not taking place in the
case where a <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Connection" title="sqlalchemy.engine.Connection"><code class="xref py py-class docutils literal notranslate"><span class="pre">Connection</span></code></a> object was invalidated, and then tried
to reconnect and encountered an error; this has been resolved.</p>
<p>Additionally, the recently added <a class="reference internal" href="../core/events.html#sqlalchemy.events.ConnectionEvents.handle_error" title="sqlalchemy.events.ConnectionEvents.handle_error"><code class="xref py py-meth docutils literal notranslate"><span class="pre">ConnectionEvents.handle_error()</span></code></a>
event is now invoked for errors that occur upon initial connect, upon
reconnect, and when <a class="reference internal" href="../core/engines.html#sqlalchemy.create_engine" title="sqlalchemy.create_engine"><code class="xref py py-func docutils literal notranslate"><span class="pre">create_engine()</span></code></a> is used given a custom connection
function via <a class="reference internal" href="../core/engines.html#sqlalchemy.create_engine.params.creator" title="sqlalchemy.create_engine"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">create_engine.creator</span></code></a>.</p>
<p>The <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.ExceptionContext" title="sqlalchemy.engine.ExceptionContext"><code class="xref py py-class docutils literal notranslate"><span class="pre">ExceptionContext</span></code></a> object has a new datamember
<a class="reference internal" href="../core/connections.html#sqlalchemy.engine.ExceptionContext.engine" title="sqlalchemy.engine.ExceptionContext.engine"><code class="xref py py-attr docutils literal notranslate"><span class="pre">ExceptionContext.engine</span></code></a> that will always refer to the <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Engine" title="sqlalchemy.engine.Engine"><code class="xref py py-class docutils literal notranslate"><span class="pre">Engine</span></code></a>
in use, in those cases when the <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Connection" title="sqlalchemy.engine.Connection"><code class="xref py py-class docutils literal notranslate"><span class="pre">Connection</span></code></a> object is not available
(e.g. on initial connect).</p>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3266">#3266</a></p>
</div>
<div class="section" id="foreignkeyconstraint-columns-is-now-a-columncollection">
<span id="change-3243"></span><h3>ForeignKeyConstraint.columns is now a ColumnCollection<a class="headerlink" href="#foreignkeyconstraint-columns-is-now-a-columncollection" title="Permalink to this headline">¶</a></h3>
<p><a class="reference internal" href="../core/constraints.html#sqlalchemy.schema.ForeignKeyConstraint.columns" title="sqlalchemy.schema.ForeignKeyConstraint.columns"><code class="xref py py-attr docutils literal notranslate"><span class="pre">ForeignKeyConstraint.columns</span></code></a> was previously a plain list
containing either strings or <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> objects, depending on
how the <a class="reference internal" href="../core/constraints.html#sqlalchemy.schema.ForeignKeyConstraint" title="sqlalchemy.schema.ForeignKeyConstraint"><code class="xref py py-class docutils literal notranslate"><span class="pre">ForeignKeyConstraint</span></code></a> was constructed and whether it was
associated with a table.  The collection is now a <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.ColumnCollection" title="sqlalchemy.sql.expression.ColumnCollection"><code class="xref py py-class docutils literal notranslate"><span class="pre">ColumnCollection</span></code></a>,
and is only initialized after the <a class="reference internal" href="../core/constraints.html#sqlalchemy.schema.ForeignKeyConstraint" title="sqlalchemy.schema.ForeignKeyConstraint"><code class="xref py py-class docutils literal notranslate"><span class="pre">ForeignKeyConstraint</span></code></a> is
associated with a <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a>.  A new accessor
<a class="reference internal" href="../core/constraints.html#sqlalchemy.schema.ForeignKeyConstraint.column_keys" title="sqlalchemy.schema.ForeignKeyConstraint.column_keys"><code class="xref py py-attr docutils literal notranslate"><span class="pre">ForeignKeyConstraint.column_keys</span></code></a>
is added to unconditionally return string keys for the local set of
columns regardless of how the object was constructed or its current
state.</p>
</div>
<div class="section" id="metadata-sorted-tables-accessor-is-deterministic">
<span id="feature-3084"></span><h3>MetaData.sorted_tables accessor is “deterministic”<a class="headerlink" href="#metadata-sorted-tables-accessor-is-deterministic" title="Permalink to this headline">¶</a></h3>
<p>The sorting of tables resulting from the <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.MetaData.sorted_tables" title="sqlalchemy.schema.MetaData.sorted_tables"><code class="xref py py-attr docutils literal notranslate"><span class="pre">MetaData.sorted_tables</span></code></a>
accessor is “deterministic”; the ordering should be the same in all cases
regardless of Python hashing.   This is done by first sorting the tables
by name before passing them to the topological algorithm, which maintains
that ordering as it iterates.</p>
<p>Note that this change does <strong>not</strong> yet apply to the ordering applied
when emitting <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.MetaData.create_all" title="sqlalchemy.schema.MetaData.create_all"><code class="xref py py-meth docutils literal notranslate"><span class="pre">MetaData.create_all()</span></code></a> or <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.MetaData.drop_all" title="sqlalchemy.schema.MetaData.drop_all"><code class="xref py py-meth docutils literal notranslate"><span class="pre">MetaData.drop_all()</span></code></a>.</p>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3084">#3084</a></p>
</div>
<div class="section" id="null-false-and-true-constants-are-no-longer-singletons">
<span id="bug-3170"></span><h3>null(), false() and true() constants are no longer singletons<a class="headerlink" href="#null-false-and-true-constants-are-no-longer-singletons" title="Permalink to this headline">¶</a></h3>
<p>These three constants were changed to return a “singleton” value
in 0.9; unfortunately, that would lead to a query like the following
to not render as expected:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">select</span><span class="p">([</span><span class="n">null</span><span class="p">(),</span> <span class="n">null</span><span class="p">()])</span></pre></div>
</div>
<p>rendering only <code class="docutils literal notranslate"><span class="pre">SELECT</span> <span class="pre">NULL</span> <span class="pre">AS</span> <span class="pre">anon_1</span></code>, because the two <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.null" title="sqlalchemy.sql.expression.null"><code class="xref py py-func docutils literal notranslate"><span class="pre">null()</span></code></a>
constructs would come out as the same  <code class="docutils literal notranslate"><span class="pre">NULL</span></code> object, and
SQLAlchemy’s Core model is based on object identity in order to
determine lexical significance.    The change in 0.9 had no
importance other than the desire to save on object overhead; in general,
an unnamed construct needs to stay lexically unique so that it gets
labeled uniquely.</p>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3170">#3170</a></p>
</div>
<div class="section" id="sqlite-oracle-have-distinct-methods-for-temporary-table-view-name-reporting">
<span id="change-3204"></span><h3>SQLite/Oracle have distinct methods for temporary table/view name reporting<a class="headerlink" href="#sqlite-oracle-have-distinct-methods-for-temporary-table-view-name-reporting" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference internal" href="../core/reflection.html#sqlalchemy.engine.reflection.Inspector.get_table_names" title="sqlalchemy.engine.reflection.Inspector.get_table_names"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Inspector.get_table_names()</span></code></a> and <a class="reference internal" href="../core/reflection.html#sqlalchemy.engine.reflection.Inspector.get_view_names" title="sqlalchemy.engine.reflection.Inspector.get_view_names"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Inspector.get_view_names()</span></code></a>
methods in the case of SQLite/Oracle would also return the names of temporary
tables and views, which is not provided by any other dialect (in the case
of MySQL at least it is not even possible).  This logic has been moved
out to two new methods <a class="reference internal" href="../core/reflection.html#sqlalchemy.engine.reflection.Inspector.get_temp_table_names" title="sqlalchemy.engine.reflection.Inspector.get_temp_table_names"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Inspector.get_temp_table_names()</span></code></a> and
<a class="reference internal" href="../core/reflection.html#sqlalchemy.engine.reflection.Inspector.get_temp_view_names" title="sqlalchemy.engine.reflection.Inspector.get_temp_view_names"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Inspector.get_temp_view_names()</span></code></a>.</p>
<p>Note that reflection of a specific named temporary table or temporary view,
either by <code class="docutils literal notranslate"><span class="pre">Table('name',</span> <span class="pre">autoload=True)</span></code> or via methods like
<a class="reference internal" href="../core/reflection.html#sqlalchemy.engine.reflection.Inspector.get_columns" title="sqlalchemy.engine.reflection.Inspector.get_columns"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Inspector.get_columns()</span></code></a> continues to function for most if not all
dialects.   For SQLite specifically, there is a bug fix for UNIQUE constraint
reflection from temp tables as well, which is <a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3203">#3203</a>.</p>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3204">#3204</a></p>
</div>
</div>
<div class="section" id="dialect-improvements-and-changes-postgresql">
<h2>Dialect Improvements and Changes - PostgreSQL<a class="headerlink" href="#dialect-improvements-and-changes-postgresql" title="Permalink to this headline">¶</a></h2>
<div class="section" id="overhaul-of-enum-type-create-drop-rules">
<span id="change-3319"></span><h3>Overhaul of ENUM type create/drop rules<a class="headerlink" href="#overhaul-of-enum-type-create-drop-rules" title="Permalink to this headline">¶</a></h3>
<p>The rules for PostgreSQL <a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.ENUM" title="sqlalchemy.dialects.postgresql.ENUM"><code class="xref py py-class docutils literal notranslate"><span class="pre">ENUM</span></code></a> have been made more strict
with regards to creating and dropping of the TYPE.</p>
<p>An <a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.ENUM" title="sqlalchemy.dialects.postgresql.ENUM"><code class="xref py py-class docutils literal notranslate"><span class="pre">ENUM</span></code></a> that is created <strong>without</strong> being explicitly
associated with a <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.MetaData" title="sqlalchemy.schema.MetaData"><code class="xref py py-class docutils literal notranslate"><span class="pre">MetaData</span></code></a> object will be created <em>and</em> dropped
corresponding to <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table.create" title="sqlalchemy.schema.Table.create"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Table.create()</span></code></a> and <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table.drop" title="sqlalchemy.schema.Table.drop"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Table.drop()</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;sometable&#39;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;some_enum&#39;</span><span class="p">,</span> <span class="n">ENUM</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;myenum&#39;</span><span class="p">))</span>
<span class="p">)</span>

<span class="n">table</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>  <span class="c1"># will emit CREATE TYPE and CREATE TABLE</span>
<span class="n">table</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>  <span class="c1"># will emit DROP TABLE and DROP TYPE - new for 1.0</span></pre></div>
</div>
<p>This means that if a second table also has an enum named ‘myenum’, the
above DROP operation will now fail.    In order to accommodate the use case
of a common shared enumerated type, the behavior of a metadata-associated
enumeration has been enhanced.</p>
<p>An <a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.ENUM" title="sqlalchemy.dialects.postgresql.ENUM"><code class="xref py py-class docutils literal notranslate"><span class="pre">ENUM</span></code></a> that is created <strong>with</strong> being explicitly
associated with a <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.MetaData" title="sqlalchemy.schema.MetaData"><code class="xref py py-class docutils literal notranslate"><span class="pre">MetaData</span></code></a> object will <em>not</em> be created <em>or</em> dropped
corresponding to <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table.create" title="sqlalchemy.schema.Table.create"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Table.create()</span></code></a> and <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table.drop" title="sqlalchemy.schema.Table.drop"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Table.drop()</span></code></a>, with
the exception of <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table.create" title="sqlalchemy.schema.Table.create"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Table.create()</span></code></a> called with the <code class="docutils literal notranslate"><span class="pre">checkfirst=True</span></code>
flag:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">my_enum</span> <span class="o">=</span> <span class="n">ENUM</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;myenum&#39;</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">)</span>

<span class="n">table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;sometable&#39;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;some_enum&#39;</span><span class="p">,</span> <span class="n">my_enum</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1"># will fail: ENUM &#39;my_enum&#39; does not exist</span>
<span class="n">table</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>

<span class="c1"># will check for enum and emit CREATE TYPE</span>
<span class="n">table</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">checkfirst</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">table</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>  <span class="c1"># will emit DROP TABLE, *not* DROP TYPE</span>

<span class="n">metadata</span><span class="o">.</span><span class="n">drop_all</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span> <span class="c1"># will emit DROP TYPE</span>

<span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span> <span class="c1"># will emit CREATE TYPE</span></pre></div>
</div>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3319">#3319</a></p>
</div>
<div class="section" id="new-postgresql-table-options">
<h3>New PostgreSQL Table options<a class="headerlink" href="#new-postgresql-table-options" title="Permalink to this headline">¶</a></h3>
<p>Added support for PG table options TABLESPACE, ON COMMIT,
WITH(OUT) OIDS, and INHERITS, when rendering DDL via
the <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> construct.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../dialects/postgresql.html#postgresql-table-options"><span class="std std-ref">PostgreSQL Table Options</span></a></p>
</div>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/2051">#2051</a></p>
</div>
<div class="section" id="new-get-enums-method-with-postgresql-dialect">
<span id="feature-get-enums"></span><h3>New get_enums() method with PostgreSQL Dialect<a class="headerlink" href="#new-get-enums-method-with-postgresql-dialect" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference internal" href="../core/inspection.html#sqlalchemy.inspect" title="sqlalchemy.inspect"><code class="xref py py-func docutils literal notranslate"><span class="pre">inspect()</span></code></a> method returns a <a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.base.PGInspector" title="sqlalchemy.dialects.postgresql.base.PGInspector"><code class="xref py py-class docutils literal notranslate"><span class="pre">PGInspector</span></code></a> object in the
case of PostgreSQL, which includes a new <a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.base.PGInspector.get_enums" title="sqlalchemy.dialects.postgresql.base.PGInspector.get_enums"><code class="xref py py-meth docutils literal notranslate"><span class="pre">PGInspector.get_enums()</span></code></a>
method that returns information on all available <code class="docutils literal notranslate"><span class="pre">ENUM</span></code> types:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="n">inspect</span><span class="p">,</span> <span class="n">create_engine</span>

<span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s2">&quot;postgresql+psycopg2://host/dbname&quot;</span><span class="p">)</span>
<span class="n">insp</span> <span class="o">=</span> <span class="n">inspect</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">insp</span><span class="o">.</span><span class="n">get_enums</span><span class="p">())</span></pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.base.PGInspector.get_enums" title="sqlalchemy.dialects.postgresql.base.PGInspector.get_enums"><code class="xref py py-meth docutils literal notranslate"><span class="pre">PGInspector.get_enums()</span></code></a></p>
</div>
</div>
<div class="section" id="postgresql-dialect-reflects-materialized-views-foreign-tables">
<span id="feature-2891"></span><h3>PostgreSQL Dialect reflects Materialized Views, Foreign Tables<a class="headerlink" href="#postgresql-dialect-reflects-materialized-views-foreign-tables" title="Permalink to this headline">¶</a></h3>
<p>Changes are as follows:</p>
<ul class="simple">
<li><p>the <code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code> construct with <code class="docutils literal notranslate"><span class="pre">autoload=True</span></code> will now match a name
that exists in the database as a materialized view or foreign table.</p></li>
<li><p><a class="reference internal" href="../core/reflection.html#sqlalchemy.engine.reflection.Inspector.get_view_names" title="sqlalchemy.engine.reflection.Inspector.get_view_names"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Inspector.get_view_names()</span></code></a> will return plain and materialized view
names.</p></li>
<li><p><a class="reference internal" href="../core/reflection.html#sqlalchemy.engine.reflection.Inspector.get_table_names" title="sqlalchemy.engine.reflection.Inspector.get_table_names"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Inspector.get_table_names()</span></code></a> does <strong>not</strong> change for PostgreSQL, it
continues to return only the names of plain tables.</p></li>
<li><p>A new method <a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.base.PGInspector.get_foreign_table_names" title="sqlalchemy.dialects.postgresql.base.PGInspector.get_foreign_table_names"><code class="xref py py-meth docutils literal notranslate"><span class="pre">PGInspector.get_foreign_table_names()</span></code></a> is added which
will return the names of tables that are specifically marked as “foreign”
in the PostgreSQL schema tables.</p></li>
</ul>
<p>The change to reflection involves adding <code class="docutils literal notranslate"><span class="pre">'m'</span></code> and <code class="docutils literal notranslate"><span class="pre">'f'</span></code> to the list
of qualifiers we use when querying <code class="docutils literal notranslate"><span class="pre">pg_class.relkind</span></code>, but this change
is new in 1.0.0 to avoid any backwards-incompatible surprises for those
running 0.9 in production.</p>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/2891">#2891</a></p>
</div>
<div class="section" id="postgresql-has-table-now-works-for-temporary-tables">
<span id="change-3264"></span><h3>PostgreSQL <code class="docutils literal notranslate"><span class="pre">has_table()</span></code> now works for temporary tables<a class="headerlink" href="#postgresql-has-table-now-works-for-temporary-tables" title="Permalink to this headline">¶</a></h3>
<p>This is a simple fix such that “has table” for temporary tables now works,
so that code like the following may proceed:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="o">*</span>

<span class="n">metadata</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">()</span>
<span class="n">user_tmp</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
    <span class="s2">&quot;user_tmp&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">INT</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)),</span>
    <span class="n">prefixes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;TEMPORARY&#39;</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">e</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s2">&quot;postgresql://scott:tiger@localhost/test&quot;</span><span class="p">,</span> <span class="n">echo</span><span class="o">=</span><span class="s1">&#39;debug&#39;</span><span class="p">)</span>
<span class="k">with</span> <span class="n">e</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
    <span class="n">user_tmp</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">checkfirst</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># checkfirst will succeed</span>
    <span class="n">user_tmp</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">checkfirst</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></pre></div>
</div>
<p>The very unlikely case that this behavior will cause a non-failing application
to behave differently, is because PostgreSQL allows a non-temporary table
to silently overwrite a temporary table.  So code like the following will
now act completely differently, no longer creating the real table following
the temporary table:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="o">*</span>

<span class="n">metadata</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">()</span>
<span class="n">user_tmp</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
    <span class="s2">&quot;user_tmp&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">INT</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)),</span>
    <span class="n">prefixes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;TEMPORARY&#39;</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">e</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s2">&quot;postgresql://scott:tiger@localhost/test&quot;</span><span class="p">,</span> <span class="n">echo</span><span class="o">=</span><span class="s1">&#39;debug&#39;</span><span class="p">)</span>
<span class="k">with</span> <span class="n">e</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
    <span class="n">user_tmp</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">checkfirst</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">m2</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">()</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
        <span class="s2">&quot;user_tmp&quot;</span><span class="p">,</span> <span class="n">m2</span><span class="p">,</span>
        <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">INT</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)),</span>
    <span class="p">)</span>

    <span class="c1"># in 0.9, *will create* the new table, overwriting the old one.</span>
    <span class="c1"># in 1.0, *will not create* the new table</span>
    <span class="n">user</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">checkfirst</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></pre></div>
</div>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3264">#3264</a></p>
</div>
<div class="section" id="postgresql-filter-keyword">
<span id="feature-gh134"></span><h3>PostgreSQL FILTER keyword<a class="headerlink" href="#postgresql-filter-keyword" title="Permalink to this headline">¶</a></h3>
<p>The SQL standard FILTER keyword for aggregate functions is now supported
by PostgreSQL as of 9.4.  SQLAlchemy allows this using
<a class="reference internal" href="../core/functions.html#sqlalchemy.sql.functions.FunctionElement.filter" title="sqlalchemy.sql.functions.FunctionElement.filter"><code class="xref py py-meth docutils literal notranslate"><span class="pre">FunctionElement.filter()</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">func</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span></pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../core/functions.html#sqlalchemy.sql.functions.FunctionElement.filter" title="sqlalchemy.sql.functions.FunctionElement.filter"><code class="xref py py-meth docutils literal notranslate"><span class="pre">FunctionElement.filter()</span></code></a></p>
<p><a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.FunctionFilter" title="sqlalchemy.sql.expression.FunctionFilter"><code class="xref py py-class docutils literal notranslate"><span class="pre">FunctionFilter</span></code></a></p>
</div>
</div>
<div class="section" id="pg8000-dialect-supports-client-side-encoding">
<h3>PG8000 dialect supports client side encoding<a class="headerlink" href="#pg8000-dialect-supports-client-side-encoding" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference internal" href="../core/engines.html#sqlalchemy.create_engine.params.encoding" title="sqlalchemy.create_engine"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">create_engine.encoding</span></code></a> parameter is now honored
by the pg8000 dialect, using on connect handler which
emits <code class="docutils literal notranslate"><span class="pre">SET</span> <span class="pre">CLIENT_ENCODING</span></code> matching the selected encoding.</p>
</div>
<div class="section" id="pg8000-native-jsonb-support">
<h3>PG8000 native JSONB support<a class="headerlink" href="#pg8000-native-jsonb-support" title="Permalink to this headline">¶</a></h3>
<p>Support for PG8000 versions greater than 1.10.1 has been added, where
JSONB is supported natively.</p>
</div>
<div class="section" id="support-for-psycopg2cffi-dialect-on-pypy">
<h3>Support for psycopg2cffi Dialect on PyPy<a class="headerlink" href="#support-for-psycopg2cffi-dialect-on-pypy" title="Permalink to this headline">¶</a></h3>
<p>Support for the pypy psycopg2cffi dialect is added.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../dialects/postgresql.html#module-sqlalchemy.dialects.postgresql.psycopg2cffi" title="sqlalchemy.dialects.postgresql.psycopg2cffi"><code class="xref py py-mod docutils literal notranslate"><span class="pre">sqlalchemy.dialects.postgresql.psycopg2cffi</span></code></a></p>
</div>
</div>
</div>
<div class="section" id="dialect-improvements-and-changes-mysql">
<h2>Dialect Improvements and Changes - MySQL<a class="headerlink" href="#dialect-improvements-and-changes-mysql" title="Permalink to this headline">¶</a></h2>
<div class="section" id="mysql-timestamp-type-now-renders-null-not-null-in-all-cases">
<span id="change-3155"></span><h3>MySQL TIMESTAMP Type now renders NULL / NOT NULL in all cases<a class="headerlink" href="#mysql-timestamp-type-now-renders-null-not-null-in-all-cases" title="Permalink to this headline">¶</a></h3>
<p>The MySQL dialect has always worked around MySQL’s implicit NOT NULL
default associated with TIMESTAMP columns by emitting NULL for
such a type, if the column is set up with <code class="docutils literal notranslate"><span class="pre">nullable=True</span></code>.   However,
MySQL 5.6.6 and above features a new flag
<a class="reference external" href="http://dev.mysql.com/doc/refman/5.6/en/server-system-variables.html#sysvar_explicit_defaults_for_timestamp">explicit_defaults_for_timestamp</a> which repairs MySQL’s non-standard
behavior to make it behave like any other type; to accommodate this,
SQLAlchemy now emits NULL/NOT NULL unconditionally for all TIMESTAMP
columns.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../dialects/mysql.html#mysql-timestamp-null"><span class="std std-ref">TIMESTAMP Columns and NULL</span></a></p>
</div>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3155">#3155</a></p>
</div>
<div class="section" id="mysql-set-type-overhauled-to-support-empty-sets-unicode-blank-value-handling">
<span id="change-3283"></span><h3>MySQL SET Type Overhauled to support empty sets, unicode, blank value handling<a class="headerlink" href="#mysql-set-type-overhauled-to-support-empty-sets-unicode-blank-value-handling" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference internal" href="../dialects/mysql.html#sqlalchemy.dialects.mysql.SET" title="sqlalchemy.dialects.mysql.SET"><code class="xref py py-class docutils literal notranslate"><span class="pre">SET</span></code></a> type historically not included a system of handling
blank sets and empty values separately; as different drivers had different
behaviors for treatment of empty strings and empty-string-set representations,
the SET type tried only to hedge between these behaviors, opting to treat the
empty set as <code class="docutils literal notranslate"><span class="pre">set([''])</span></code> as is still the current behavior for the
MySQL-Connector-Python DBAPI.
Part of the rationale here was that it was otherwise impossible to actually
store a blank string within a MySQL SET, as the driver gives us back strings
with no way to discern between <code class="docutils literal notranslate"><span class="pre">set([''])</span></code> and <code class="docutils literal notranslate"><span class="pre">set()</span></code>.  It was left
to the user to determine if <code class="docutils literal notranslate"><span class="pre">set([''])</span></code> actually meant “empty set” or not.</p>
<p>The new behavior moves the use case for the blank string, which is an unusual
case that isn’t even documented in MySQL’s documentation, into a special
case, and the default behavior of <a class="reference internal" href="../dialects/mysql.html#sqlalchemy.dialects.mysql.SET" title="sqlalchemy.dialects.mysql.SET"><code class="xref py py-class docutils literal notranslate"><span class="pre">SET</span></code></a> is now:</p>
<ul class="simple">
<li><p>to treat the empty string <code class="docutils literal notranslate"><span class="pre">''</span></code> as returned by MySQL-python into the empty
set <code class="docutils literal notranslate"><span class="pre">set()</span></code>;</p></li>
<li><p>to convert the single-blank value set <code class="docutils literal notranslate"><span class="pre">set([''])</span></code> returned by
MySQL-Connector-Python into the empty set <code class="docutils literal notranslate"><span class="pre">set()</span></code>;</p></li>
<li><p>To handle the case of a set type that actually wishes includes the blank
value <code class="docutils literal notranslate"><span class="pre">''</span></code> in its list of possible values,
a new feature (required in this use case) is implemented whereby the set
value is persisted and loaded as a bitwise integer value; the
flag <a class="reference internal" href="../dialects/mysql.html#sqlalchemy.dialects.mysql.SET.params.retrieve_as_bitwise" title="sqlalchemy.dialects.mysql.SET"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">SET.retrieve_as_bitwise</span></code></a> is added in order to
enable this.</p></li>
</ul>
<p>Using the <a class="reference internal" href="../dialects/mysql.html#sqlalchemy.dialects.mysql.SET.params.retrieve_as_bitwise" title="sqlalchemy.dialects.mysql.SET"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">SET.retrieve_as_bitwise</span></code></a> flag allows the set
to be persisted and retrieved with no ambiguity of values.   Theoretically
this flag can be turned on in all cases, as long as the given list of
values to the type matches the ordering exactly as declared in the
database; it only makes the SQL echo output a bit more unusual.</p>
<p>The default behavior of <a class="reference internal" href="../dialects/mysql.html#sqlalchemy.dialects.mysql.SET" title="sqlalchemy.dialects.mysql.SET"><code class="xref py py-class docutils literal notranslate"><span class="pre">SET</span></code></a> otherwise remains the same,
roundtripping values using strings.   The string-based behavior now
supports unicode fully including MySQL-python with use_unicode=0.</p>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3283">#3283</a></p>
</div>
<div class="section" id="mysql-internal-no-such-table-exceptions-not-passed-to-event-handlers">
<h3>MySQL internal “no such table” exceptions not passed to event handlers<a class="headerlink" href="#mysql-internal-no-such-table-exceptions-not-passed-to-event-handlers" title="Permalink to this headline">¶</a></h3>
<p>The MySQL dialect will now disable <a class="reference internal" href="../core/events.html#sqlalchemy.events.ConnectionEvents.handle_error" title="sqlalchemy.events.ConnectionEvents.handle_error"><code class="xref py py-meth docutils literal notranslate"><span class="pre">ConnectionEvents.handle_error()</span></code></a>
events from firing for those statements which it uses internally
to detect if a table exists or not.   This is achieved using an
execution option <code class="docutils literal notranslate"><span class="pre">skip_user_error_events</span></code> that disables the handle
error event for the scope of that execution.   In this way, user code
that rewrites exceptions doesn’t need to worry about the MySQL
dialect or other dialects that occasionally need to catch
SQLAlchemy specific exceptions.</p>
</div>
<div class="section" id="changed-the-default-value-of-raise-on-warnings-for-mysql-connector">
<h3>Changed the default value of <code class="docutils literal notranslate"><span class="pre">raise_on_warnings</span></code> for MySQL-Connector<a class="headerlink" href="#changed-the-default-value-of-raise-on-warnings-for-mysql-connector" title="Permalink to this headline">¶</a></h3>
<p>Changed the default value of “raise_on_warnings” to False for
MySQL-Connector.  This was set at True for some reason.  The “buffered”
flag unfortunately must stay at True as MySQLconnector does not allow
a cursor to be closed unless all results are fully fetched.</p>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/2515">#2515</a></p>
</div>
<div class="section" id="mysql-boolean-symbols-true-false-work-again">
<span id="bug-3186"></span><h3>MySQL boolean symbols “true”, “false” work again<a class="headerlink" href="#mysql-boolean-symbols-true-false-work-again" title="Permalink to this headline">¶</a></h3>
<p>0.9’s overhaul of the IS/IS NOT operators as well as boolean types in
<a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/2682">#2682</a> disallowed the MySQL dialect from making use of the
“true” and “false” symbols in the context of “IS” / “IS NOT”.  Apparently,
even though MySQL has no “boolean” type, it supports IS / IS NOT when the
special “true” and “false” symbols are used, even though these are otherwise
synonymous with “1” and “0” (and IS/IS NOT don’t work with the numerics).</p>
<p>So the change here is that the MySQL dialect remains “non native boolean”,
but the <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.true" title="sqlalchemy.sql.expression.true"><code class="xref py py-func docutils literal notranslate"><span class="pre">true()</span></code></a> and <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.false" title="sqlalchemy.sql.expression.false"><code class="xref py py-func docutils literal notranslate"><span class="pre">false()</span></code></a> symbols again produce the
keywords “true” and “false”, so that an expression like <code class="docutils literal notranslate"><span class="pre">column.is_(true())</span></code>
again works on MySQL.</p>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3186">#3186</a></p>
</div>
<div class="section" id="the-match-operator-now-returns-an-agnostic-matchtype-compatible-with-mysql-s-floating-point-return-value">
<span id="change-3263"></span><h3>The match() operator now returns an agnostic MatchType compatible with MySQL’s floating point return value<a class="headerlink" href="#the-match-operator-now-returns-an-agnostic-matchtype-compatible-with-mysql-s-floating-point-return-value" title="Permalink to this headline">¶</a></h3>
<p>The return type of a <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.operators.ColumnOperators.match" title="sqlalchemy.sql.operators.ColumnOperators.match"><code class="xref py py-meth docutils literal notranslate"><span class="pre">ColumnOperators.match()</span></code></a> expression is now a new type
called <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.MatchType" title="sqlalchemy.types.MatchType"><code class="xref py py-class docutils literal notranslate"><span class="pre">MatchType</span></code></a>.  This is a subclass of <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Boolean" title="sqlalchemy.types.Boolean"><code class="xref py py-class docutils literal notranslate"><span class="pre">Boolean</span></code></a>,
that can be intercepted by the dialect in order to produce a different
result type at SQL execution time.</p>
<p>Code like the following will now function correctly and return floating points
on MySQL:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="gp">... </span>   <span class="n">select</span><span class="p">([</span>
<span class="gp">... </span>       <span class="n">matchtable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;Agile Ruby Programming&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s1">&#39;ruby&#39;</span><span class="p">),</span>
<span class="gp">... </span>       <span class="n">matchtable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;Dive Python&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s1">&#39;python&#39;</span><span class="p">),</span>
<span class="gp">... </span>       <span class="n">matchtable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">title</span>
<span class="gp">... </span>   <span class="p">])</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">matchtable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<span class="gp">... </span><span class="p">)</span>
<span class="go">[</span>
<span class="go">    (2.0, 0.0, &#39;Agile Web Development with Ruby On Rails&#39;),</span>
<span class="go">    (0.0, 2.0, &#39;Dive Into Python&#39;),</span>
<span class="go">    (2.0, 0.0, &quot;Programming Matz&#39;s Ruby&quot;),</span>
<span class="go">    (0.0, 0.0, &#39;The Definitive Guide to Django&#39;),</span>
<span class="go">    (0.0, 1.0, &#39;Python in a Nutshell&#39;)</span>
<span class="go">]</span></pre></div>
</div>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3263">#3263</a></p>
</div>
<div class="section" id="drizzle-dialect-is-now-an-external-dialect">
<span id="change-2984"></span><h3>Drizzle Dialect is now an External Dialect<a class="headerlink" href="#drizzle-dialect-is-now-an-external-dialect" title="Permalink to this headline">¶</a></h3>
<p>The dialect for <a class="reference external" href="http://www.drizzle.org/">Drizzle</a> is now an external
dialect, available at <a class="reference external" href="https://bitbucket.org/zzzeek/sqlalchemy-drizzle">https://bitbucket.org/zzzeek/sqlalchemy-drizzle</a>.
This dialect was added to SQLAlchemy right before SQLAlchemy was able to
accommodate third party dialects well; going forward, all databases that aren’t
within the “ubiquitous use” category are third party dialects.
The dialect’s implementation hasn’t changed and is still based on the
MySQL + MySQLdb dialects within SQLAlchemy.  The dialect is as of yet
unreleased and in “attic” status; however it passes the majority of tests
and is generally in decent working order, if someone wants to pick up
on polishing it.</p>
</div>
</div>
<div class="section" id="dialect-improvements-and-changes-sqlite">
<h2>Dialect Improvements and Changes - SQLite<a class="headerlink" href="#dialect-improvements-and-changes-sqlite" title="Permalink to this headline">¶</a></h2>
<div class="section" id="sqlite-named-and-unnamed-unique-and-foreign-key-constraints-will-inspect-and-reflect">
<h3>SQLite named and unnamed UNIQUE and FOREIGN KEY constraints will inspect and reflect<a class="headerlink" href="#sqlite-named-and-unnamed-unique-and-foreign-key-constraints-will-inspect-and-reflect" title="Permalink to this headline">¶</a></h3>
<p>UNIQUE and FOREIGN KEY constraints are now fully reflected on
SQLite both with and without names.  Previously, foreign key
names were ignored and unnamed unique constraints were skipped.   In particular
this will help with Alembic’s new SQLite migration features.</p>
<p>To achieve this, for both foreign keys and unique constraints, the result
of PRAGMA foreign_keys, index_list, and index_info is combined with regular
expression parsing of the CREATE TABLE statement overall to form a complete
picture of the names of constraints, as well as differentiating UNIQUE
constraints that were created as UNIQUE vs. unnamed INDEXes.</p>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3244">#3244</a></p>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3261">#3261</a></p>
</div>
</div>
<div class="section" id="dialect-improvements-and-changes-sql-server">
<h2>Dialect Improvements and Changes - SQL Server<a class="headerlink" href="#dialect-improvements-and-changes-sql-server" title="Permalink to this headline">¶</a></h2>
<div class="section" id="pyodbc-driver-name-is-required-with-hostname-based-sql-server-connections">
<span id="change-3182"></span><h3>PyODBC driver name is required with hostname-based SQL Server connections<a class="headerlink" href="#pyodbc-driver-name-is-required-with-hostname-based-sql-server-connections" title="Permalink to this headline">¶</a></h3>
<p>Connecting to SQL Server with PyODBC using a DSN-less connection, e.g.
with an explicit hostname, now requires a driver name - SQLAlchemy will no
longer attempt to guess a default:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s2">&quot;mssql+pyodbc://scott:tiger@myhost:port/databasename?driver=SQL+Server+Native+Client+10.0&quot;</span><span class="p">)</span></pre></div>
</div>
<p>SQLAlchemy’s previously hardcoded default of “SQL Server” is obsolete on
Windows, and SQLAlchemy cannot be tasked with guessing the best driver
based on operation system/driver detection.   Using a DSN is always preferred
when using ODBC to avoid this issue entirely.</p>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3182">#3182</a></p>
</div>
<div class="section" id="sql-server-2012-large-text-binary-types-render-as-varchar-nvarchar-varbinary">
<h3>SQL Server 2012 large text / binary types render as VARCHAR, NVARCHAR, VARBINARY<a class="headerlink" href="#sql-server-2012-large-text-binary-types-render-as-varchar-nvarchar-varbinary" title="Permalink to this headline">¶</a></h3>
<p>The rendering of the <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.TextClause" title="sqlalchemy.sql.expression.TextClause"><code class="xref py py-class docutils literal notranslate"><span class="pre">TextClause</span></code></a>, <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.UnicodeText" title="sqlalchemy.types.UnicodeText"><code class="xref py py-class docutils literal notranslate"><span class="pre">UnicodeText</span></code></a>, and <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.LargeBinary" title="sqlalchemy.types.LargeBinary"><code class="xref py py-class docutils literal notranslate"><span class="pre">LargeBinary</span></code></a>
types has been changed for SQL Server 2012 and greater, with options
to control the behavior completely, based on deprecation guidelines from
Microsoft.  See <a class="reference internal" href="../dialects/mssql.html#mssql-large-type-deprecation"><span class="std std-ref">Large Text/Binary Type Deprecation</span></a> for details.</p>
</div>
</div>
<div class="section" id="dialect-improvements-and-changes-oracle">
<h2>Dialect Improvements and Changes - Oracle<a class="headerlink" href="#dialect-improvements-and-changes-oracle" title="Permalink to this headline">¶</a></h2>
<div class="section" id="improved-support-for-ctes-in-oracle">
<span id="change-3220"></span><h3>Improved support for CTEs in Oracle<a class="headerlink" href="#improved-support-for-ctes-in-oracle" title="Permalink to this headline">¶</a></h3>
<p>CTE support has been fixed up for Oracle, and there is also a new feature
<code class="xref py py-meth docutils literal notranslate"><span class="pre">CTE.with_suffixes()</span></code> that can assist with Oracle’s special directives:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">included_parts</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span>
    <span class="n">part</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">sub_part</span><span class="p">,</span> <span class="n">part</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">part</span><span class="p">,</span> <span class="n">part</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">quantity</span>
<span class="p">])</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">part</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">part</span> <span class="o">==</span> <span class="s2">&quot;p1&quot;</span><span class="p">)</span><span class="o">.</span>\
    <span class="n">cte</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;included_parts&quot;</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span>\
    <span class="n">suffix_with</span><span class="p">(</span>
        <span class="s2">&quot;search depth first by part set ord1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;cycle part set y_cycle to 1 default 0&quot;</span><span class="p">,</span> <span class="n">dialect</span><span class="o">=</span><span class="s1">&#39;oracle&#39;</span><span class="p">)</span></pre></div>
</div>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3220">#3220</a></p>
</div>
<div class="section" id="new-oracle-keywords-for-ddl">
<h3>New Oracle Keywords for DDL<a class="headerlink" href="#new-oracle-keywords-for-ddl" title="Permalink to this headline">¶</a></h3>
<p>Keywords such as COMPRESS, ON COMMIT, BITMAP:</p>
<p><a class="reference internal" href="../dialects/oracle.html#oracle-table-options"><span class="std std-ref">Oracle Table Options</span></a></p>
<p><a class="reference internal" href="../dialects/oracle.html#oracle-index-options"><span class="std std-ref">Oracle Specific Index Options</span></a></p>
</div>
</div>
</div>

    </div>

</div>

<div id="docs-bottom-navigation" class="docs-navigation-links, withsidebar">
        Previous:
        <a href="migration_11.html" title="previous chapter">What’s New in SQLAlchemy 1.1?</a>
        Next:
        <a href="migration_09.html" title="next chapter">What’s New in SQLAlchemy 0.9?</a>

    <div id="docs-copyright">
        &copy; <a href="../copyright.html">Copyright</a> 2007-2020, the SQLAlchemy authors and contributors.
        Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 3.0.3.
    </div>
</div>

</div>



        
        

    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
          URL_ROOT:    '../',
          VERSION:     '1.3.17',
          COLLAPSE_MODINDEX: false,
          FILE_SUFFIX: '.html'
      };
    </script>

    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>

    <!-- begin iterate through sphinx environment script_files -->
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    <!-- end iterate through sphinx environment script_files -->

    <script type="text/javascript" src="../_static/detectmobile.js"></script>
    <script type="text/javascript" src="../_static/init.js"></script>


    </body>
</html>


