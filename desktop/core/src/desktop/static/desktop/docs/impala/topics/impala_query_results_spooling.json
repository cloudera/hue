{"body":"<div><div id=\"data_sink\"><div class=\"hue-doc-title\">Spooling Impala Query Results</div><div><p>In Impala, you can control how query results are materialized and\n      returned to clients, e.g. impala-shell, Hue, JDBC apps.</p><ul><li>When query result spooling is disabled, Impala relies on clients to\n        fetch results to trigger the generation of more result row batches until\n        all the result rows have been produced. If a client issues a query\n        without fetching all the results, the query fragments continue to\n        consume the resources until the query is cancelled and unregistered,\n        potentially tying up resources and causing other queries to wait for an\n        extended period of time in admission control.<p>Impala would materialize\n          rows on-demand where rows are created only when the client requests\n          them.</p></li><li>When query result spooling is enabled, result sets of queries are\n        eagerly fetched and spooled in the spooling location, either in memory\n        or on disk. <p>Once all result rows have been fetched and stored in the\n          spooling location, the resources are freed up. Incoming client fetches\n          can get the data from the spooled results.</p></li></ul><p>Result spooling is turned off by default, but can be enabled via the\n        <span class=\"hue-doc-codeph\">SPOOL_QUERY_RESULTS</span> query option.</p><div class=\"hue-doc-section\" id=\"section_av4_hsy_2jb\"><div class=\"hue-doc-title\">Admission Control and Result Spooling</div><p>Query results spooling collects and stores query results in memory that\n        is controlled by admission control. Use the following query options to\n        calibrate how much memory to use and when to spill to disk.<dl><dt>MAX_RESULT_SPOOLING_MEM</dt><dd><p>The maximum amount of memory used when spooling query results.\n                If this value is exceeded when spooling results, all memory will\n                most likely be spilled to disk. Set to 100 MB by default. </p></dd><dt>MAX_SPILLED_RESULT_SPOOLING_MEM</dt><dd><p>The maximum amount of memory that can be spilled to disk when\n                spooling query results. Must be greater than or equal to\n                  <span class=\"hue-doc-codeph\">MAX_RESULT_SPOOLING_MEM</span>. If this value is\n                exceeded, the coordinator fragment will block until the client\n                has consumed enough rows to free up more memory. Set to 1 GB by\n                default.</p></dd></dl></p></div><div class=\"hue-doc-section\" id=\"section_oh2_fsy_2jb\"><div class=\"hue-doc-title\">Fetch Timeout</div><p>Resources for a query are released when the query completes its\n        execution. To prevent clients from indefinitely waiting for query\n        results, use the <span class=\"hue-doc-codeph\">FETCH_ROWS_TIMEOUT_MS</span> query option to\n        set the timeout when clients fetch rows. Timeout applies both when query\n        result spooling is enabled and disabled:<ul><li>When result spooling is disabled (<span class=\"hue-doc-codeph\">SPOOL_QUERY_RESULTS =\n              FALSE</span>), the timeout controls how long a client waits for\n            a single row batch to be produced by the coordinator. </li><li>When result spooling is enabled ( (<span class=\"hue-doc-codeph\">SPOOL_QUERY_RESULTS =\n              TRUE</span>), a client can fetch multiple row batches at a time,\n            so this timeout controls the total time a client waits for row\n            batches to be produced.</li></ul></p></div><div class=\"hue-doc-section\" id=\"section_ahm_bsy_2jb\"><div class=\"hue-doc-title\">Explain Plans</div><p>Below is the part of the <span class=\"hue-doc-codeph\">EXPLAIN</span> plan output for\n        result spooling.<div class=\"hue-doc-codeblock\">F01:PLAN FRAGMENT [UNPARTITIONED] hosts=1 instances=1\n|  Per-Host Resources: mem-estimate=4.02MB mem-reservation=4.00MB thread-reservation=1\nPLAN-ROOT SINK\n|  mem-estimate=4.00MB mem-reservation=4.00MB spill-buffer=2.00MB thread-reservation=0</div><ul><li>The <span class=\"hue-doc-codeph\">mem-estimate</span> for the <span class=\"hue-doc-codeph\">PLAN-ROOT\n              SINK</span> is an estimate of the amount of memory needed to\n            spool all the rows returned by the query.</li><li>The <span class=\"hue-doc-codeph\">mem-reservation</span> is the number and size of the\n            buffers necessary to spool the query results. By default, the read\n            and write buffers are 2 MB in size each, which is why the default is\n            4 MB.</li></ul></p></div><div class=\"hue-doc-section\" id=\"section_ovl_ksy_2jb\"><div class=\"hue-doc-title\">PlanRootSink</div><p>In Impala, the <span class=\"hue-doc-codeph\">PlanRootSink</span> class controls\n        the passing of batches of rows to the clients and acts as a queue of\n        rows to be sent to clients.</p><p><ul><li><p>When result spooling is disabled, a single batch or rows is sent\n              to the <span class=\"hue-doc-codeph\">PlanRootSink</span>, and then the client must\n              consume that batch before another one can be sent.</p></li><li><p>When result spooling is enabled, multiple batches of rows can be\n              sent to the <span class=\"hue-doc-codeph\">PlanRootSink</span>, and multiple batches\n              can be consumed by the client.</p></li></ul></p></div><div class=\"hue-doc-section\"><p><b>Related information:</b><a class=\"hue-doc-internal-link\" href=\"javascript:void(0);\" data-doc-ref=\"topics/impala_max_result_spooling_mem.xml\" data-doc-anchor-id=\"MAX_RESULT_SPOOLING_MEM\">MAX_RESULT_SPOOLING_MEM Query Option</a>, <a class=\"hue-doc-internal-link\" href=\"javascript:void(0);\" data-doc-ref=\"topics/impala_max_spilled_result_spooling_mem.xml\" data-doc-anchor-id=\"MAX_SPILLED_RESULT_SPOOLING_MEM\">MAX_SPILLED_RESULT_SPOOLING_MEM Query Option</a>, <a class=\"hue-doc-internal-link\" href=\"javascript:void(0);\" data-doc-ref=\"topics/impala_spool_query_results.xml\" data-doc-anchor-id=\"SPOOL_QUERY_RESULTS\">SPOOL_QUERY_RESULTS Query Option</a></p></div></div></div></div>","title":"Spooling Impala Query Results"}